[{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\auth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\db.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\index.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'azureAdConfig' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":47,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":47,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"azureAdConfig"},"fix":{"range":[1636,2037],"text":""},"desc":"Remove unused variable 'azureAdConfig'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":108,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":108,"endColumn":19}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from 'express';\r\nimport cors from 'cors';\r\nimport helmet from 'helmet';\r\nimport compression from 'compression';\r\nimport rateLimit from 'express-rate-limit'; // morgan removed\r\nimport passport from 'passport';\r\nimport { Strategy as JwtStrategy, ExtractJwt } from 'passport-jwt';\r\nimport jwksRsa from 'jwks-rsa'; // Added for Azure AD\r\nimport 'dotenv/config';\r\nimport { getPool, sql } from './db.js';\r\nimport { seedPermissions } from './utils/seedPermissions.js';\r\n\r\n// Import Routers\r\nimport dashboardRouter from './routes/dashboard.js';\r\nimport goalsRouter from './routes/goals.js';\r\nimport kpisRouter from './routes/kpis.js';\r\nimport projectsRouter from './routes/projects.js';\r\nimport tasksRouter from './routes/tasks.js';\r\nimport tagsRouter from './routes/tags.js';\r\nimport intakeRouter from './routes/intake.js';\r\nimport adminRouter from './routes/admin.js';\r\n\r\nconst app = express();\r\nconst PORT = process.env.PORT || 3001;\r\nconst IS_DEVELOPMENT = process.env.NODE_ENV !== 'production';\r\n\r\n// ==================== MIDDLEWARE ====================\r\n\r\napp.use(cors());\r\napp.use(helmet());\r\napp.use(compression());\r\napp.use(express.json({ limit: '50mb' }));\r\napp.use(express.urlencoded({ extended: true, limit: '50mb' }));\r\n// app.use(morgan(IS_DEVELOPMENT ? 'dev' : 'combined')); // Removed missing dependency\r\n\r\n// Rate Limiting\r\nconst limiter = rateLimit({\r\n    windowMs: 15 * 60 * 1000, // 15 minutes\r\n    max: 500, // Limit each IP to 500 requests per windowMs\r\n    standardHeaders: true,\r\n    legacyHeaders: false,\r\n});\r\napp.use('/api/', limiter);\r\n\r\n// ==================== AUTHENTICATION ====================\r\n\r\nconst azureAdConfig = {\r\n    identityMetadata: `https://login.microsoftonline.com/${process.env.AZURE_TENANT_ID}/v2.0/.well-known/openid-configuration`,\r\n    clientID: process.env.AZURE_CLIENT_ID,\r\n    validateIssuer: false, // Set to true if you need to validate the issuer\r\n    passReqToCallback: false,\r\n    loggingLevel: 'info',\r\n    scope: ['access_as_user'] // Scope string (space separated)\r\n};\r\n\r\n// Passport Config (using passport-jwt with Azure AD token structure)\r\n// We use jwks-rsa to retrieve public keys for signature validation\r\n\r\nconst jwtOptions = {\r\n    jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\r\n    secretOrKeyProvider: jwksRsa.passportJwtSecret({\r\n        cache: true,\r\n        rateLimit: true,\r\n        jwksRequestsPerMinute: 5,\r\n        jwksUri: `https://login.microsoftonline.com/${process.env.AZURE_TENANT_ID}/discovery/v2.0/keys`\r\n    }),\r\n    issuer: [\r\n        `https://login.microsoftonline.com/${process.env.AZURE_TENANT_ID}/v2.0`, // v2.0 endpoint\r\n        `https://sts.windows.net/${process.env.AZURE_TENANT_ID}/`              // v1.0 endpoint\r\n    ],\r\n    audience: [process.env.AZURE_CLIENT_ID, `api://${process.env.AZURE_CLIENT_ID}`],\r\n    algorithms: ['RS256']\r\n};\r\n\r\npassport.use(new JwtStrategy(jwtOptions, async (jwt_payload, done) => {\r\n    try {\r\n        // Find user by OID (Object ID from Azure AD)\r\n        const pool = await getPool();\r\n        const result = await pool.request()\r\n            .input('oid', sql.NVarChar, jwt_payload.oid)\r\n            .query('SELECT * FROM Users WHERE oid = @oid');\r\n\r\n        let user = result.recordset[0];\r\n\r\n        if (!user) {\r\n            // Auto-provision user if they don't exist\r\n            // Extract info from token claims\r\n            const name = jwt_payload.name || jwt_payload.preferred_username || 'Unknown User';\r\n            const email = jwt_payload.preferred_username || jwt_payload.email || 'unknown@example.com';\r\n            const tid = jwt_payload.tid || process.env.AZURE_TENANT_ID;\r\n\r\n            const insertResult = await pool.request()\r\n                .input('oid', sql.NVarChar, jwt_payload.oid)\r\n                .input('tid', sql.NVarChar, tid)\r\n                .input('name', sql.NVarChar, name)\r\n                .input('email', sql.NVarChar, email)\r\n                .query(`\r\n                    INSERT INTO Users (oid, tid, name, email, roles) \r\n                    OUTPUT INSERTED.* \r\n                    VALUES (@oid, @tid, @name, @email, '[\"User\"]')\r\n                `);\r\n            user = insertResult.recordset[0];\r\n        }\r\n\r\n        // Parse roles JSON\r\n        try {\r\n            user.roles = JSON.parse(user.roles || '[]');\r\n        } catch (e) {\r\n            user.roles = ['User'];\r\n        }\r\n\r\n        return done(null, user);\r\n    } catch (err) {\r\n        return done(err, false);\r\n    }\r\n}));\r\n\r\napp.use(passport.initialize());\r\n\r\n// Enforce Global Authentication for /api/\r\napp.use('/api/', (req, res, next) => {\r\n    passport.authenticate('jwt', { session: false }, (err, user, info) => {\r\n        if (err) {\r\n            console.error('Passport Error:', err);\r\n            return next(err);\r\n        }\r\n        if (!user) {\r\n            // Strict Mode: Reject invalid/missing tokens\r\n            if (info) console.log('Auth Failure:', info.message || info);\r\n            return res.status(401).json({ error: 'Unauthorized' });\r\n        }\r\n\r\n        // Success\r\n        req.user = user;\r\n        return next();\r\n    })(req, res, next);\r\n});\r\n\r\n// ==================== ROUTES ====================\r\n\r\napp.use('/api/dashboard', dashboardRouter);\r\napp.use('/api/goals', goalsRouter);\r\napp.use('/api/kpis', kpisRouter);\r\napp.use('/api/projects', projectsRouter);\r\napp.use('/api/tasks', tasksRouter);\r\napp.use('/api/tags', tagsRouter);\r\napp.use('/api/intake', intakeRouter);\r\napp.use('/api/admin', adminRouter);\r\n\r\n// Health Check (Public)\r\napp.get('/health', (req, res) => {\r\n    res.json({ status: 'ok', timestamp: new Date() });\r\n});\r\n\r\n// ==================== START SERVER ====================\r\n\r\nconst HOST = '0.0.0.0'; // Listen on all interfaces\r\n\r\napp.listen(PORT, HOST, async () => {\r\n    try {\r\n        await getPool();\r\n        // Seed permissions on startup\r\n        await seedPermissions();\r\n\r\n        console.log(`API server running on:`);\r\n        console.log(`  Local:   http://localhost:${PORT}`);\r\n        console.log(`  Network: http://0.0.0.0:${PORT}`);\r\n    } catch (err) {\r\n        console.error('Failed to connect to database:', err);\r\n    }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\middleware\\authMiddleware.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'sql' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"sql"},"fix":{"range":[16,21],"text":""},"desc":"Remove unused variable 'sql'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getPool, sql } from '../db.js';\r\nimport NodeCache from 'node-cache';\r\n\r\n// Cache permissions for 1 minute to reduce DB hits\r\nconst permissionCache = new NodeCache({ stdTTL: 60 });\r\nconst CACHE_KEY = 'all_role_permissions';\r\n\r\n/**\r\n * Middleware to ensure user has a specific role (e.g. 'Admin')\r\n * Azure AD token payload usually puts roles in `roles` array.\r\n */\r\nexport const checkRole = (requiredRole) => {\r\n    return (req, res, next) => {\r\n        // req.user is populated by passport-azure-ad\r\n        // It typically looks like the decoded JWT token\r\n        const user = req.user;\r\n\r\n        if (!user) {\r\n            return res.status(401).json({ error: 'Unauthorized: No user found' });\r\n        }\r\n\r\n        const userRoles = user.roles || [];\r\n\r\n        if (userRoles.includes(requiredRole)) {\r\n            return next();\r\n        }\r\n\r\n        return res.status(403).json({ error: `Forbidden: Requires ${requiredRole} role` });\r\n    };\r\n};\r\n\r\n/**\r\n * Middleware to check if user has a specific dynamic permission.\r\n * Checks against the RolePermissions table in DB.\r\n * Admins are always allowed.\r\n * Supports checking multiple permissions (OR logic) if passed an array.\r\n */\r\nexport const checkPermission = (permissionKeys) => {\r\n    return async (req, res, next) => {\r\n        const user = req.user;\r\n\r\n        if (!user) {\r\n            return res.status(401).json({ error: 'Unauthorized' });\r\n        }\r\n\r\n        const userRoles = user.roles || [];\r\n\r\n        // 1. Admin Bypass\r\n        if (userRoles.includes('Admin')) {\r\n            return next();\r\n        }\r\n\r\n        try {\r\n            // 2. Get Permissions (Cached)\r\n            let allPermissions = permissionCache.get(CACHE_KEY);\r\n            if (!allPermissions) {\r\n                const pool = await getPool();\r\n                const result = await pool.request().query('SELECT * FROM RolePermissions');\r\n                allPermissions = result.recordset;\r\n                permissionCache.set(CACHE_KEY, allPermissions);\r\n            }\r\n\r\n            // Normalize to array\r\n            const keysToCheck = Array.isArray(permissionKeys) ? permissionKeys : [permissionKeys];\r\n\r\n            // 3. Check if ANY of user's roles has ANY of the required permissions enabled\r\n            const hasAccess = userRoles.some(role => {\r\n                return keysToCheck.some(key => {\r\n                    const entry = allPermissions.find(p => p.role === role && p.permission === key);\r\n                    return entry ? entry.isAllowed : false;\r\n                });\r\n            });\r\n\r\n            if (hasAccess) {\r\n                return next();\r\n            } else {\r\n                return res.status(403).json({ error: `Forbidden: Missing required permission` });\r\n            }\r\n\r\n        } catch (err) {\r\n            console.error('Permission Check Error:', err);\r\n            // Fail closed\r\n            return res.status(500).json({ error: 'Internal Server Error during authorization' });\r\n        }\r\n    };\r\n};\r\n\r\n/**\r\n * Middleware to ensure the request has an authenticated user.\r\n * Rejects anonymous requests with 401. Use this as a baseline guard\r\n * on endpoints that don't need granular RBAC but must not be public.\r\n */\r\nexport const requireAuth = (req, res, next) => {\r\n    if (!req.user) {\r\n        return res.status(401).json({ error: 'Unauthorized: Authentication required' });\r\n    }\r\n    return next();\r\n};\r\n\r\n/**\r\n * Explicitly invalidate the permission cache.\r\n * Call this when permissions are updated in the DB.\r\n */\r\nexport const invalidatePermissionCache = () => {\r\n    try {\r\n        permissionCache.del(CACHE_KEY);\r\n        console.log('Permission cache invalidated.');\r\n    } catch (err) {\r\n        console.error('Error invalidating permission cache:', err);\r\n    }\r\n};\r\n\r\n/**\r\n * Helper to get authenticated user from request\r\n * @param {Request} req \r\n * @returns {object|null}\r\n */\r\nexport const getAuthUser = (req) => {\r\n    return req.user || null;\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\admin.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'cache' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"cache"},"fix":{"range":[325,331],"text":""},"desc":"Remove unused variable 'cache'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from 'express';\r\nimport { getPool, sql } from '../db.js';\r\nimport { checkPermission, checkRole, getAuthUser, invalidatePermissionCache, requireAuth } from '../middleware/authMiddleware.js';\r\nimport { handleError } from '../utils/errorHandler.js';\r\nimport { logAudit } from '../utils/auditLogger.js';\r\nimport { cache, CACHE_KEYS, invalidateTagCache, invalidateProjectCache } from '../utils/cache.js';\r\n\r\nconst router = express.Router();\r\n\r\n// ==================== TAG GROUPS ====================\r\n\r\n// Create tag group (Admin)\r\nrouter.post('/tag-groups', checkPermission('can_manage_tags'), async (req, res) => {\r\n    try {\r\n        const { name, slug, requirePrimary, sortOrder } = req.body;\r\n        if (!name || !slug) return res.status(400).json({ error: 'Missing required fields: name, slug' });\r\n\r\n        const pool = await getPool();\r\n        const result = await pool.request()\r\n            .input('name', sql.NVarChar, name)\r\n            .input('slug', sql.NVarChar, slug)\r\n            .input('requirePrimary', sql.Bit, requirePrimary ? 1 : 0)\r\n            .input('sortOrder', sql.Int, sortOrder || 0)\r\n            .query('INSERT INTO TagGroups (name, slug, requirePrimary, sortOrder) OUTPUT INSERTED.id VALUES (@name, @slug, @requirePrimary, @sortOrder)');\r\n\r\n        invalidateTagCache();\r\n        const newId = result.recordset[0].id.toString();\r\n        logAudit({ action: 'tag_group.create', entityType: 'tag_group', entityId: newId, entityTitle: name, user: getAuthUser(req), after: { name, slug, requirePrimary, sortOrder }, req });\r\n        res.json({ id: newId, name, slug, requirePrimary: !!requirePrimary, sortOrder: sortOrder || 0, tags: [] });\r\n    } catch (err) {\r\n        handleError(res, 'creating tag group', err);\r\n    }\r\n});\r\n\r\n// Update tag group (Admin)\r\nrouter.put('/tag-groups/:id', checkPermission('can_manage_tags'), async (req, res) => {\r\n    try {\r\n        const { name, slug, requirePrimary, sortOrder } = req.body;\r\n        const id = parseInt(req.params.id);\r\n        const pool = await getPool();\r\n        const prev = await pool.request().input('id', sql.Int, id).query('SELECT name, slug, requirePrimary, sortOrder FROM TagGroups WHERE id = @id');\r\n        await pool.request()\r\n            .input('id', sql.Int, id)\r\n            .input('name', sql.NVarChar, name)\r\n            .input('slug', sql.NVarChar, slug)\r\n            .input('requirePrimary', sql.Bit, requirePrimary ? 1 : 0)\r\n            .input('sortOrder', sql.Int, sortOrder || 0)\r\n            .query('UPDATE TagGroups SET name = @name, slug = @slug, requirePrimary = @requirePrimary, sortOrder = @sortOrder WHERE id = @id');\r\n\r\n        invalidateTagCache();\r\n        logAudit({ action: 'tag_group.update', entityType: 'tag_group', entityId: id, entityTitle: name, user: getAuthUser(req), before: prev.recordset[0], after: { name, slug, requirePrimary, sortOrder }, req });\r\n        res.json({ success: true });\r\n    } catch (err) {\r\n        handleError(res, 'updating tag group', err);\r\n    }\r\n});\r\n\r\n// Delete tag group (Admin)\r\nrouter.delete('/tag-groups/:id', checkPermission('can_manage_tags'), async (req, res) => {\r\n    try {\r\n        const id = parseInt(req.params.id);\r\n        const pool = await getPool();\r\n        const prev = await pool.request().input('id', sql.Int, id).query('SELECT name, slug FROM TagGroups WHERE id = @id');\r\n        await pool.request()\r\n            .input('id', sql.Int, id)\r\n            .query('DELETE FROM TagGroups WHERE id = @id');\r\n\r\n        invalidateTagCache();\r\n        logAudit({ action: 'tag_group.delete', entityType: 'tag_group', entityId: id, entityTitle: prev.recordset[0]?.name, user: getAuthUser(req), before: prev.recordset[0], req });\r\n        res.json({ success: true });\r\n    } catch (err) {\r\n        handleError(res, 'deleting tag group', err);\r\n    }\r\n});\r\n\r\n// ==================== TAGS ====================\r\n\r\n// Create tag (Admin)\r\nrouter.post('/tags', checkPermission('can_manage_tags'), async (req, res) => {\r\n    try {\r\n        const { groupId, name, slug, status, color, sortOrder, aliases } = req.body;\r\n        if (!groupId || !name || !slug) return res.status(400).json({ error: 'Missing required fields: groupId, name, slug' });\r\n\r\n        const pool = await getPool();\r\n        const result = await pool.request()\r\n            .input('groupId', sql.Int, parseInt(groupId))\r\n            .input('name', sql.NVarChar, name)\r\n            .input('slug', sql.NVarChar, slug)\r\n            .input('status', sql.NVarChar, status || 'active')\r\n            .input('color', sql.NVarChar, color || '#6366f1')\r\n            .input('sortOrder', sql.Int, sortOrder || 0)\r\n            .query('INSERT INTO Tags (groupId, name, slug, status, color, sortOrder) OUTPUT INSERTED.id VALUES (@groupId, @name, @slug, @status, @color, @sortOrder)');\r\n\r\n        const tagId = result.recordset[0].id;\r\n\r\n        // Insert aliases if provided\r\n        if (aliases && aliases.length > 0) {\r\n            for (const alias of aliases) {\r\n                if (alias.trim()) {\r\n                    await pool.request()\r\n                        .input('tagId', sql.Int, tagId)\r\n                        .input('alias', sql.NVarChar, alias.trim())\r\n                        .query('INSERT INTO TagAliases (tagId, alias) VALUES (@tagId, @alias)');\r\n                }\r\n            }\r\n        }\r\n\r\n        invalidateTagCache();\r\n        logAudit({ action: 'tag.create', entityType: 'tag', entityId: tagId.toString(), entityTitle: name, user: getAuthUser(req), after: { groupId, name, slug, status: status || 'active', color: color || '#6366f1', sortOrder: sortOrder || 0, aliases }, req });\r\n        res.json({ id: tagId.toString(), groupId: groupId.toString(), name, slug, status: status || 'active', color: color || '#6366f1', sortOrder: sortOrder || 0, aliases: (aliases || []).map(a => ({ alias: a })) });\r\n    } catch (err) {\r\n        handleError(res, 'creating tag', err);\r\n    }\r\n});\r\n\r\n// Update tag (Admin) — supports partial updates\r\nrouter.put('/tags/:id', checkPermission('can_manage_tags'), async (req, res) => {\r\n    try {\r\n        const { name, slug, status, color, sortOrder, aliases } = req.body;\r\n        const pool = await getPool();\r\n        const request = pool.request().input('id', sql.Int, parseInt(req.params.id));\r\n\r\n        let updateParts = [];\r\n        if (name !== undefined) { request.input('name', sql.NVarChar, name); updateParts.push('name = @name'); }\r\n        if (slug !== undefined) { request.input('slug', sql.NVarChar, slug); updateParts.push('slug = @slug'); }\r\n        if (status !== undefined) { request.input('status', sql.NVarChar, status); updateParts.push('status = @status'); }\r\n        if (color !== undefined) { request.input('color', sql.NVarChar, color); updateParts.push('color = @color'); }\r\n        if (sortOrder !== undefined) { request.input('sortOrder', sql.Int, sortOrder); updateParts.push('sortOrder = @sortOrder'); }\r\n\r\n        if (updateParts.length > 0) {\r\n            await request.query(`UPDATE Tags SET ${updateParts.join(', ')} WHERE id = @id`);\r\n        }\r\n\r\n        // Replace aliases if provided (delete-then-insert)\r\n        if (aliases !== undefined) {\r\n            await pool.request()\r\n                .input('tagId', sql.Int, parseInt(req.params.id))\r\n                .query('DELETE FROM TagAliases WHERE tagId = @tagId');\r\n\r\n            for (const alias of aliases) {\r\n                if (alias.trim()) {\r\n                    await pool.request()\r\n                        .input('tagId', sql.Int, parseInt(req.params.id))\r\n                        .input('alias', sql.NVarChar, alias.trim())\r\n                        .query('INSERT INTO TagAliases (tagId, alias) VALUES (@tagId, @alias)');\r\n                }\r\n            }\r\n        }\r\n\r\n        invalidateTagCache();\r\n        logAudit({ action: 'tag.update', entityType: 'tag', entityId: req.params.id, entityTitle: name, user: getAuthUser(req), after: { name, slug, status, color, sortOrder, aliases }, req });\r\n        res.json({ success: true });\r\n    } catch (err) {\r\n        handleError(res, 'updating tag', err);\r\n    }\r\n});\r\n\r\n// Delete tag (Admin)\r\nrouter.delete('/tags/:id', checkPermission('can_manage_tags'), async (req, res) => {\r\n    try {\r\n        const id = parseInt(req.params.id);\r\n        const pool = await getPool();\r\n        const prev = await pool.request().input('id', sql.Int, id).query('SELECT name, slug, groupId FROM Tags WHERE id = @id');\r\n        await pool.request()\r\n            .input('id', sql.Int, id)\r\n            .query('DELETE FROM Tags WHERE id = @id');\r\n\r\n        invalidateTagCache();\r\n        invalidateProjectCache();\r\n        logAudit({ action: 'tag.delete', entityType: 'tag', entityId: id, entityTitle: prev.recordset[0]?.name, user: getAuthUser(req), before: prev.recordset[0], req });\r\n        res.json({ success: true });\r\n    } catch (err) {\r\n        handleError(res, 'deleting tag', err);\r\n    }\r\n});\r\n\r\n// ==================== ROLE PERMISSIONS (ADMIN) ====================\r\n\r\n// Get all permissions - Require authentication so users can check their own rights\r\nrouter.get('/permissions', requireAuth, async (req, res) => {\r\n    try {\r\n        const pool = await getPool();\r\n        const result = await pool.request().query('SELECT * FROM RolePermissions ORDER BY role, permission');\r\n        res.json(result.recordset);\r\n    } catch (err) {\r\n        handleError(res, 'fetching permissions', err);\r\n    }\r\n});\r\n\r\n// Update a single permission\r\nrouter.post('/permissions', checkRole('Admin'), async (req, res) => {\r\n    try {\r\n        const { role, permission, isAllowed } = req.body;\r\n        const pool = await getPool();\r\n\r\n        await pool.request()\r\n            .input('role', sql.NVarChar, role)\r\n            .input('permission', sql.NVarChar, permission)\r\n            .input('isAllowed', sql.Bit, isAllowed ? 1 : 0)\r\n            .query(`\r\n                MERGE RolePermissions AS target\r\n                USING (SELECT @role, @permission) AS source (role, permission)\r\n                ON (target.role = source.role AND target.permission = source.permission)\r\n                WHEN MATCHED THEN\r\n                    UPDATE SET isAllowed = @isAllowed\r\n                WHEN NOT MATCHED THEN\r\n                    INSERT (role, permission, isAllowed)\r\n                    VALUES (@role, @permission, @isAllowed);\r\n            `);\r\n\r\n        invalidatePermissionCache(); // Clear cache so changes take effect immediately\r\n        logAudit({ action: 'permission.update', entityType: 'permission', entityId: `${role}.${permission}`, entityTitle: `${role}: ${permission}`, user: getAuthUser(req), after: { role, permission, isAllowed }, req });\r\n        res.json({ success: true, role, permission, isAllowed });\r\n    } catch (err) {\r\n        handleError(res, 'updating permission', err);\r\n    }\r\n});\r\n\r\n// Bulk update permissions\r\nrouter.post('/permissions/bulk', checkRole('Admin'), async (req, res) => {\r\n    try {\r\n        const { updates } = req.body; // Array of { role, permission, isAllowed }\r\n        if (!Array.isArray(updates)) {\r\n            return res.status(400).json({ error: 'updates must be an array' });\r\n        }\r\n\r\n        const pool = await getPool();\r\n        const transaction = new sql.Transaction(pool);\r\n        await transaction.begin();\r\n\r\n        try {\r\n            for (const update of updates) {\r\n                const request = new sql.Request(transaction);\r\n                await request\r\n                    .input('role', sql.NVarChar, update.role)\r\n                    .input('permission', sql.NVarChar, update.permission)\r\n                    .input('isAllowed', sql.Bit, update.isAllowed ? 1 : 0)\r\n                    .query(`\r\n                        MERGE RolePermissions AS target\r\n                        USING (SELECT @role, @permission) AS source (role, permission)\r\n                        ON (target.role = source.role AND target.permission = source.permission)\r\n                        WHEN MATCHED THEN\r\n                            UPDATE SET isAllowed = @isAllowed\r\n                        WHEN NOT MATCHED THEN\r\n                            INSERT (role, permission, isAllowed)\r\n                            VALUES (@role, @permission, @isAllowed);\r\n                    `);\r\n            }\r\n            await transaction.commit();\r\n            invalidatePermissionCache(); // Clear cache so changes take effect immediately\r\n            logAudit({ action: 'permission.bulk_update', entityType: 'permission', entityId: null, entityTitle: `${updates.length} permissions updated`, user: getAuthUser(req), after: null, metadata: { changes: updates }, req });\r\n            res.json({ success: true, count: updates.length });\r\n        } catch (err) {\r\n            await transaction.rollback();\r\n            throw err;\r\n        }\r\n    } catch (err) {\r\n        handleError(res, 'bulk updating permissions', err);\r\n    }\r\n});\r\n\r\n// ==================== AUDIT LOG (ADMIN) ====================\r\n\r\n// Get audit log entries with filtering and pagination (Admin only)\r\nrouter.get('/audit-log', checkRole('Admin'), async (req, res) => {\r\n    try {\r\n        const pool = await getPool();\r\n        const page = parseInt(req.query.page) || 1;\r\n        let limit = parseInt(req.query.limit) || 50;\r\n        if (limit > 200) limit = 200;\r\n        const offset = (page - 1) * limit;\r\n\r\n        // Build dynamic WHERE clauses\r\n        let whereClauses = [];\r\n        const countRequest = pool.request();\r\n        const dataRequest = pool.request();\r\n\r\n        // Helper to add params to both requests\r\n        const addParam = (name, type, value) => {\r\n            countRequest.input(name, type, value);\r\n            dataRequest.input(name, type, value);\r\n        };\r\n\r\n        if (req.query.action) {\r\n            whereClauses.push('action = @action');\r\n            addParam('action', sql.NVarChar(50), req.query.action);\r\n        }\r\n        if (req.query.entityType) {\r\n            whereClauses.push('entityType = @entityType');\r\n            addParam('entityType', sql.NVarChar(30), req.query.entityType);\r\n        }\r\n        if (req.query.entityId) {\r\n            whereClauses.push('entityId = @entityId');\r\n            addParam('entityId', sql.NVarChar(20), req.query.entityId);\r\n        }\r\n        if (req.query.userId) {\r\n            whereClauses.push('userId = @userId');\r\n            addParam('userId', sql.NVarChar(100), req.query.userId);\r\n        }\r\n        if (req.query.from) {\r\n            whereClauses.push('createdAt >= @fromDate');\r\n            addParam('fromDate', sql.DateTime2, new Date(req.query.from));\r\n        }\r\n        if (req.query.to) {\r\n            whereClauses.push('createdAt <= @toDate');\r\n            addParam('toDate', sql.DateTime2, new Date(req.query.to));\r\n        }\r\n        if (req.query.search) {\r\n            whereClauses.push('(entityTitle LIKE @search OR userName LIKE @search)');\r\n            addParam('search', sql.NVarChar, `%${req.query.search}%`);\r\n        }\r\n\r\n        const whereSQL = whereClauses.length > 0 ? `WHERE ${whereClauses.join(' AND ')}` : '';\r\n\r\n        // Get total count\r\n        const countResult = await countRequest.query(`SELECT COUNT(*) as total FROM AuditLog ${whereSQL}`);\r\n        const total = countResult.recordset[0].total;\r\n\r\n        // Get paginated data\r\n        dataRequest\r\n            .input('offset', sql.Int, offset)\r\n            .input('limit', sql.Int, limit);\r\n\r\n        const dataResult = await dataRequest.query(`\r\n            SELECT id, action, entityType, entityId, entityTitle, userId, userName,\r\n                   [before], [after], metadata, ipAddress, userAgent, createdAt\r\n            FROM AuditLog\r\n            ${whereSQL}\r\n            ORDER BY createdAt DESC\r\n            OFFSET @offset ROWS FETCH NEXT @limit ROWS ONLY\r\n        `);\r\n\r\n        const entries = dataResult.recordset.map(row => ({\r\n            id: row.id.toString(),\r\n            action: row.action,\r\n            entityType: row.entityType,\r\n            entityId: row.entityId,\r\n            entityTitle: row.entityTitle,\r\n            userId: row.userId,\r\n            userName: row.userName,\r\n            before: row.before ? JSON.parse(row.before) : null,\r\n            after: row.after ? JSON.parse(row.after) : null,\r\n            metadata: row.metadata ? JSON.parse(row.metadata) : null,\r\n            ipAddress: row.ipAddress,\r\n            userAgent: row.userAgent,\r\n            createdAt: row.createdAt\r\n        }));\r\n\r\n        res.json({\r\n            entries,\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total,\r\n                totalPages: Math.ceil(total / limit),\r\n                hasMore: page < Math.ceil(total / limit)\r\n            }\r\n        });\r\n    } catch (err) {\r\n        handleError(res, 'fetching audit log', err);\r\n    }\r\n});\r\n\r\n// Get audit log summary statistics (Admin only)\r\nrouter.get('/audit-log/stats', checkRole('Admin'), async (req, res) => {\r\n    try {\r\n        const pool = await getPool();\r\n\r\n        const [countsResult, topUsersResult, topEntitiesResult, actionBreakdownResult] = await Promise.all([\r\n            pool.request().query(`\r\n                SELECT \r\n                    (SELECT COUNT(*) FROM AuditLog WHERE createdAt >= DATEADD(HOUR, -24, GETDATE())) as last24h,\r\n                    (SELECT COUNT(*) FROM AuditLog WHERE createdAt >= DATEADD(DAY, -7, GETDATE())) as last7d,\r\n                    (SELECT COUNT(*) FROM AuditLog WHERE createdAt >= DATEADD(DAY, -30, GETDATE())) as last30d,\r\n                    (SELECT COUNT(*) FROM AuditLog) as total\r\n            `),\r\n            pool.request().query(`\r\n                SELECT TOP 10 userName, userId, COUNT(*) as eventCount\r\n                FROM AuditLog\r\n                WHERE createdAt >= DATEADD(DAY, -30, GETDATE()) AND userName IS NOT NULL\r\n                GROUP BY userName, userId\r\n                ORDER BY eventCount DESC\r\n            `),\r\n            pool.request().query(`\r\n                SELECT TOP 10 entityType, entityId, entityTitle, COUNT(*) as eventCount\r\n                FROM AuditLog\r\n                WHERE createdAt >= DATEADD(DAY, -30, GETDATE())\r\n                GROUP BY entityType, entityId, entityTitle\r\n                ORDER BY eventCount DESC\r\n            `),\r\n            pool.request().query(`\r\n                SELECT action, COUNT(*) as count\r\n                FROM AuditLog\r\n                WHERE createdAt >= DATEADD(DAY, -30, GETDATE())\r\n                GROUP BY action\r\n                ORDER BY count DESC\r\n            `)\r\n        ]);\r\n\r\n        res.json({\r\n            counts: countsResult.recordset[0],\r\n            topUsers: topUsersResult.recordset,\r\n            topEntities: topEntitiesResult.recordset,\r\n            actionBreakdown: actionBreakdownResult.recordset\r\n        });\r\n    } catch (err) {\r\n        handleError(res, 'fetching audit log stats', err);\r\n    }\r\n});\r\n\r\nexport default router;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\dashboard.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'sql' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":2,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"sql"},"fix":{"range":[48,53],"text":""},"desc":"Remove unused variable 'sql'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from 'express';\r\nimport { getPool, sql } from '../db.js';\r\nimport { checkPermission } from '../middleware/authMiddleware.js';\r\nimport { handleError } from '../utils/errorHandler.js';\r\nimport { buildInClause, addParams } from '../utils/sqlHelpers.js';\r\n\r\nconst router = express.Router();\r\n\r\n// Get dashboard statistics (server-side aggregation)\r\nrouter.get('/stats', checkPermission(['can_view_projects']), async (req, res) => {\r\n    try {\r\n        const pool = await getPool();\r\n        const goalIdsParam = req.query.goalIds || ''; // Comma-separated IDs\r\n        const goalIds = goalIdsParam ? goalIdsParam.split(',').map(id => parseInt(id)).filter(id => !isNaN(id)) : [];\r\n        const tagIdsParam = req.query.tagIds || '';\r\n        const tagIds = tagIdsParam ? tagIdsParam.split(',').map(id => parseInt(id)).filter(id => !isNaN(id)) : [];\r\n\r\n        let whereConditions = [];\r\n        let queryParams = {};\r\n\r\n        // 1. Goal Filtering (Safe IN clause)\r\n        if (goalIds.length > 0) {\r\n            const { text: goalInClause, params: goalParams } = buildInClause('goalId', goalIds);\r\n            whereConditions.push(`p.goalId IN (${goalInClause})`);\r\n            Object.assign(queryParams, goalParams);\r\n        }\r\n\r\n        // 2. Tag Filtering (Safe IN clause)\r\n        let tagJoin = '';\r\n        if (tagIds.length > 0) {\r\n            const { text: tagInClause, params: tagParams } = buildInClause('tagId', tagIds);\r\n            tagJoin = `INNER JOIN ProjectTags pt ON p.id = pt.projectId AND pt.tagId IN (${tagInClause})`;\r\n            Object.assign(queryParams, tagParams);\r\n        }\r\n\r\n        const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';\r\n\r\n        // Helper to run query with params\r\n        const runQuery = async (queryStr) => {\r\n            const request = pool.request();\r\n            addParams(request, queryParams);\r\n            return await request.query(queryStr);\r\n        };\r\n\r\n        // 1. Counts (Projects, Tasks, Completed Tasks)\r\n        // We join Tasks to Projects to respect the goal filtering\r\n        const statsQuery = `\r\n            SELECT \r\n                COUNT(DISTINCT p.id) as totalProjects,\r\n                COUNT(DISTINCT t.id) as totalTasks,\r\n                SUM(CASE WHEN t.status = 'done' THEN 1 ELSE 0 END) as completedTasks\r\n            FROM Projects p\r\n            ${tagJoin}\r\n            LEFT JOIN Tasks t ON p.id = t.projectId\r\n            ${whereClause}\r\n        `;\r\n        const statsResult = await runQuery(statsQuery);\r\n        const stats = statsResult.recordset[0];\r\n\r\n        // 2. Overdue Tasks (Top 5)\r\n        const overdueQuery = `\r\n            SELECT TOP 5 t.id, t.title, t.endDate, t.projectId, p.title as projectTitle\r\n            FROM Tasks t\r\n            INNER JOIN Projects p ON t.projectId = p.id\r\n            ${tagJoin}\r\n            ${whereClause ? whereClause + ' AND' : 'WHERE'} \r\n            t.endDate < CAST(GETDATE() AS DATE) \r\n            AND t.status != 'done'\r\n            ORDER BY t.endDate ASC\r\n        `;\r\n        const overdueResult = await runQuery(overdueQuery);\r\n\r\n        // 3. In Progress Tasks (Top 5)\r\n        const inProgressQuery = `\r\n            SELECT TOP 5 t.id, t.title, t.projectId, p.title as projectTitle\r\n            FROM Tasks t\r\n            INNER JOIN Projects p ON t.projectId = p.id\r\n            ${tagJoin}\r\n            ${whereClause ? whereClause + ' AND' : 'WHERE'} \r\n            t.status = 'in-progress'\r\n            ORDER BY t.startDate DESC, t.id DESC\r\n        `;\r\n        const inProgressResult = await runQuery(inProgressQuery);\r\n\r\n        // 4. Overdue Count (Separate query for total count)\r\n        const overdueCountQuery = `\r\n            SELECT COUNT(DISTINCT t.id) as count\r\n            FROM Tasks t\r\n            INNER JOIN Projects p ON t.projectId = p.id\r\n            ${tagJoin}\r\n            ${whereClause ? whereClause + ' AND' : 'WHERE'} \r\n            t.endDate < CAST(GETDATE() AS DATE) \r\n            AND t.status != 'done'\r\n        `;\r\n        const overdueCountResult = await runQuery(overdueCountQuery);\r\n\r\n        // 5. In Progress Count\r\n        const inProgressCountQuery = `\r\n            SELECT COUNT(DISTINCT t.id) as count\r\n            FROM Tasks t\r\n            INNER JOIN Projects p ON t.projectId = p.id\r\n            ${tagJoin}\r\n            ${whereClause ? whereClause + ' AND' : 'WHERE'} \r\n            t.status = 'in-progress'\r\n        `;\r\n        const inProgressCountResult = await runQuery(inProgressCountQuery);\r\n\r\n        // 6. Average Project Completion (for overall progress)\r\n        const completionQuery = `\r\n            SELECT AVG(\r\n                CASE WHEN pd.taskCount = 0 THEN 0 \r\n                ELSE (CAST(pd.doneCount AS FLOAT) / pd.taskCount) * 100 \r\n                END\r\n            ) as avgCompletion\r\n            FROM (\r\n                SELECT p.id, \r\n                    COUNT(t.id) as taskCount, \r\n                    SUM(CASE WHEN t.status = 'done' THEN 1 ELSE 0 END) as doneCount\r\n                FROM Projects p\r\n                ${tagJoin}\r\n                LEFT JOIN Tasks t ON p.id = t.projectId\r\n                ${whereClause}\r\n                GROUP BY p.id\r\n            ) pd\r\n        `;\r\n        const completionResult = await runQuery(completionQuery);\r\n\r\n        res.json({\r\n            totalProjects: stats.totalProjects || 0,\r\n            totalTasks: stats.totalTasks || 0,\r\n            completedTasks: stats.completedTasks || 0,\r\n            overdueTasks: overdueResult.recordset,\r\n            overdueCount: overdueCountResult.recordset[0].count,\r\n            inProgressTasks: inProgressResult.recordset,\r\n            inProgressCount: inProgressCountResult.recordset[0].count,\r\n            avgProjectCompletion: Math.round(completionResult.recordset[0].avgCompletion || 0)\r\n        });\r\n\r\n    } catch (err) {\r\n        handleError(res, 'fetching dashboard stats', err);\r\n    }\r\n});\r\n\r\nexport default router;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\goals.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\intake.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\kpis.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\projects.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\tags.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'sql' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":2,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"sql"},"fix":{"range":[48,53],"text":""},"desc":"Remove unused variable 'sql'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from 'express';\r\nimport { getPool, sql } from '../db.js';\r\nimport { checkPermission } from '../middleware/authMiddleware.js';\r\nimport { handleError } from '../utils/errorHandler.js';\r\nimport { cache, CACHE_KEYS } from '../utils/cache.js';\r\n\r\nconst router = express.Router();\r\n\r\n// Get all tag groups with their tags and aliases\r\nrouter.get('/', checkPermission(['can_view_projects', 'can_view_exec_dashboard']), async (req, res) => {\r\n    try {\r\n        const cached = cache.get(CACHE_KEYS.TAG_GROUPS);\r\n        if (cached) return res.json(cached);\r\n\r\n        const pool = await getPool();\r\n        const [groupsResult, tagsResult, aliasesResult] = await Promise.all([\r\n            pool.request().query('SELECT * FROM TagGroups ORDER BY sortOrder'),\r\n            pool.request().query('SELECT * FROM Tags ORDER BY sortOrder'),\r\n            pool.request().query('SELECT * FROM TagAliases')\r\n        ]);\r\n\r\n        // Build alias lookup\r\n        const aliasesByTag = {};\r\n        aliasesResult.recordset.forEach(a => {\r\n            if (!aliasesByTag[a.tagId]) aliasesByTag[a.tagId] = [];\r\n            aliasesByTag[a.tagId].push({ id: a.id, alias: a.alias });\r\n        });\r\n\r\n        const groups = groupsResult.recordset.map(g => ({\r\n            id: g.id.toString(),\r\n            name: g.name,\r\n            slug: g.slug,\r\n            requirePrimary: g.requirePrimary,\r\n            sortOrder: g.sortOrder,\r\n            tags: tagsResult.recordset\r\n                .filter(t => t.groupId === g.id)\r\n                .map(t => ({\r\n                    id: t.id.toString(),\r\n                    groupId: t.groupId.toString(),\r\n                    name: t.name,\r\n                    slug: t.slug,\r\n                    status: t.status,\r\n                    color: t.color,\r\n                    sortOrder: t.sortOrder,\r\n                    aliases: (aliasesByTag[t.id] || []).map(a => ({ id: a.id.toString(), alias: a.alias }))\r\n                }))\r\n        }));\r\n\r\n        cache.set(CACHE_KEYS.TAG_GROUPS, groups);\r\n        res.json(groups);\r\n    } catch (err) {\r\n        handleError(res, 'fetching tags', err);\r\n    }\r\n});\r\n\r\nexport default router;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\tasks.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\run_audit_migration.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\run_migration.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'sql' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":2,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"sql"},"fix":{"range":[82,87],"text":""},"desc":"Remove unused variable 'sql'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Run the tag migration script using the existing DB connection\r\nimport { getPool, sql } from './db.js';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\r\n\r\nasync function runMigration() {\r\n    try {\r\n        console.log('Connecting to database...');\r\n        const pool = await getPool();\r\n\r\n        console.log('Reading migration script...');\r\n        // Default to migrate_users.sql for this run, or generic logic\r\n        const scriptName = process.argv[2] || 'migrate_users.sql';\r\n        const sqlScript = fs.readFileSync(path.join(__dirname, scriptName), 'utf8');\r\n\r\n        // Split by GO statements (MSSQL batch separator)\r\n        const batches = sqlScript.split(/^\\s*GO\\s*$/mi).filter(b => b.trim());\r\n\r\n        console.log(`Found ${batches.length} batches to execute...`);\r\n\r\n        for (let i = 0; i < batches.length; i++) {\r\n            const batch = batches[i].trim();\r\n            if (!batch) continue;\r\n\r\n            try {\r\n                console.log(`Executing batch ${i + 1}/${batches.length}...`);\r\n                await pool.request().query(batch);\r\n                console.log(`  ✓ Batch ${i + 1} completed`);\r\n            } catch (err) {\r\n                console.error(`  ✗ Batch ${i + 1} failed:`, err.message);\r\n                // Continue with other batches (some may fail if tables already exist)\r\n            }\r\n        }\r\n\r\n        // Verify: count records\r\n        const groups = await pool.request().query('SELECT COUNT(*) as count FROM TagGroups');\r\n        const tags = await pool.request().query('SELECT COUNT(*) as count FROM Tags');\r\n        const aliases = await pool.request().query('SELECT COUNT(*) as count FROM TagAliases');\r\n\r\n        console.log('\\n=== Migration Complete ===');\r\n        console.log(`TagGroups: ${groups.recordset[0].count}`);\r\n        console.log(`Tags: ${tags.recordset[0].count}`);\r\n        console.log(`TagAliases: ${aliases.recordset[0].count}`);\r\n\r\n        process.exit(0);\r\n    } catch (err) {\r\n        console.error('Migration failed:', err);\r\n        process.exit(1);\r\n    }\r\n}\r\n\r\nrunMigration();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\scripts\\restore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\scripts\\seed_performance.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\scripts\\snapshot.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\auditLogger.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\cache.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\errorHandler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\seedPermissions.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\sqlHelpers.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'sql' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"sql"},"fix":{"range":[0,31],"text":""},"desc":"Remove unused variable 'sql'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { sql } from '../db.js';\r\n\r\n/**\r\n * Safely builds an IN clause for SQL queries with named parameters.\r\n * \r\n * @param {string} paramPrefix - Prefix for parameter names (e.g. 'id', 'status')\r\n * @param {Array<string|number>} values - Array of values to include in the IN clause\r\n * @returns {object} - { text: string, params: object }\r\n * \r\n * Example usage:\r\n * const { text, params } = buildInClause('projId', projectIds);\r\n * // text: \"@projId0, @projId1, @projId2\"\r\n * // params: { projId0: 1, projId1: 2, projId2: 3 }\r\n * \r\n * // In query:\r\n * // const request = pool.request();\r\n * // Object.entries(params).forEach(([key, val]) => request.input(key, val));\r\n * // request.query(`SELECT * FROM Projects WHERE id IN (${text})`);\r\n */\r\nexport const buildInClause = (paramPrefix, values) => {\r\n    if (!values || values.length === 0) {\r\n        return { text: 'NULL', params: {} }; // parsing 'IN (NULL)' is valid but matches nothing usually, or handled by caller\r\n    }\r\n\r\n    const params = {};\r\n    const paramNames = values.map((val, index) => {\r\n        const paramName = `${paramPrefix}${index}`;\r\n        params[paramName] = val;\r\n        return `@${paramName}`;\r\n    });\r\n\r\n    return {\r\n        text: paramNames.join(', '),\r\n        params\r\n    };\r\n};\r\n\r\n/**\r\n * Helper to add parameters to a MSSQL request object\r\n * @param {sql.Request} request - The MSSQL request object\r\n * @param {object} params - Key-value pairs of parameters\r\n */\r\nexport const addParams = (request, params) => {\r\n    Object.entries(params).forEach(([key, val]) => {\r\n        // Auto-detect type or use default input\r\n        // For strict typing, caller should handle manual input, \r\n        // but for simple IDs (Int/String), default works well in mssql\r\n        request.input(key, val);\r\n    });\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\App.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\apiClient.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":48,"column":67,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":68},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":50,"column":80,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":81}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Shared API client configuration.\r\n * Single source of truth for the API base URL and common fetch helpers.\r\n */\r\n\r\n// Protocol-safe: respects https in production, falls back to current host on port 3001\r\nexport const API_BASE = import.meta.env.VITE_API_URL\r\n    || `${window.location.protocol}//${window.location.hostname}:3001/api`;\r\n\r\nexport class ApiError extends Error {\r\n    constructor(status, message, data) {\r\n        super(message);\r\n        this.name = 'ApiError';\r\n        this.status = status;\r\n        this.data = data;\r\n    }\r\n}\r\n\r\n/**\r\n * Standardized fetch wrapper that handles auth headers and error parsing.\r\n * @param {string} url - Full URL\r\n * @param {string|null} token - Bearer token\r\n * @param {object} options - Fetch options\r\n */\r\nexport async function fetchWithAuth(url, token, options = {}) {\r\n    const headers = new Headers(options.headers || {});\r\n\r\n    if (token) {\r\n        headers.set('Authorization', `Bearer ${token}`);\r\n    }\r\n\r\n    if (!headers.has('Content-Type') && !(options.body instanceof FormData)) {\r\n        headers.set('Content-Type', 'application/json');\r\n    }\r\n\r\n    const config = {\r\n        ...options,\r\n        headers\r\n    };\r\n\r\n    try {\r\n        const response = await fetch(url, config);\r\n\r\n        if (!response.ok) {\r\n            let errorData;\r\n            const contentType = response.headers.get('content-type');\r\n            if (contentType && contentType.includes('application/json')) {\r\n                try { errorData = await response.json(); } catch (e) { /* ignore */ }\r\n            } else {\r\n                try { errorData = { message: await response.text() }; } catch (e) { /* ignore */ }\r\n            }\r\n\r\n            const message = (errorData && errorData.error) || (errorData && errorData.message) || `Request failed with status ${response.status}`;\r\n            throw new ApiError(response.status, message, errorData);\r\n        }\r\n\r\n        return response;\r\n    } catch (error) {\r\n        // If it's already an ApiError, rethrow\r\n        if (error instanceof ApiError) throw error;\r\n        // Network errors\r\n        throw new ApiError(0, error.message || 'Network Error', null);\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\authConfig.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Admin\\AdminPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Admin\\AuditLogView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Admin\\TagManager.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\AppContent.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Auth\\LoginPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Dashboard\\Dashboard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Dashboard\\ExecDashboard.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has missing dependencies: 'getDescendantGoalIds' and 'getProjectHierarchy'. Either include them or remove the dependency array.","line":374,"column":8,"nodeType":"ArrayExpression","endLine":374,"endColumn":103,"suggestions":[{"desc":"Update the dependencies array to be: [allProjects, projects, selectedGoalId, selectedTags, getDescendantGoalIds, goals, getProjectHierarchy, getLatestStatusReport, searchTerm]","fix":{"range":[14649,14744],"text":"[allProjects, projects, selectedGoalId, selectedTags, getDescendantGoalIds, goals, getProjectHierarchy, getLatestStatusReport, searchTerm]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo, useRef } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { Search, Download, X } from 'lucide-react';\r\nimport { Modal } from '../UI/Modal';\r\nimport { StatusReportView } from '../StatusReport/StatusReportView';\r\n\r\nimport { FilterBar } from '../UI/FilterBar';\r\nimport html2pdf from 'html2pdf.js';\r\nimport './ExecDashboard.css';\r\n\r\nimport { formatCompactDate as formatShortDate } from '../../utils';\r\nimport { API_BASE } from '../../apiClient';\r\n\r\nexport function ExecDashboard() {\r\n    const { projects, goals, getLatestStatusReport, fetchExecSummaryProjects, authFetch } = useData();\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [selectedGoalId, setSelectedGoalId] = useState('');\r\n    const [selectedTags, setSelectedTags] = useState([]);\r\n    const [selectedProject, setSelectedProject] = useState(null);\r\n    const tableRef = useRef(null);\r\n\r\n    // Export to PDF\r\n    const handleExportPDF = () => {\r\n        const element = tableRef.current.cloneNode(true);\r\n        const opt = {\r\n            margin: [0.3, 0.3],\r\n            filename: 'digital-health-executive-summary.pdf',\r\n            image: { type: 'jpeg', quality: 0.98 },\r\n            html2canvas: {\r\n                scale: 2,\r\n                useCORS: true,\r\n                letterRendering: true,\r\n                logging: false\r\n            },\r\n            jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }\r\n        };\r\n\r\n        const today = new Date().toLocaleDateString('en-US', {\r\n            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'\r\n        });\r\n\r\n        const filterTitle = selectedGoalId\r\n            ? goals.find(g => g.id == selectedGoalId)?.title || 'Filtered View'\r\n            : 'All Projects';\r\n\r\n        // Create a temporary container\r\n        const container = document.createElement('div');\r\n        container.style.width = '1100px'; // Approx A4 landscape width (297mm - margins)\r\n\r\n\r\n        // Create elements securely\r\n        const styleEl = document.createElement('style');\r\n        styleEl.textContent = `\r\n            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');\r\n            body { margin: 0; padding: 20px; font-family: 'Segoe UI', 'Inter', sans-serif; color: #1f2937; -webkit-font-smoothing: antialiased; }\r\n            \r\n            /* Banner Header */\r\n            .banner {\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: space-between;\r\n                padding: 8px 12px;\r\n                border: 2px solid #1f2937;\r\n                margin-bottom: 20px;\r\n                background: white;\r\n            }\r\n            .banner-title {\r\n                background: linear-gradient(135deg, #059669, #10b981);\r\n                color: white;\r\n                padding: 6px 20px;\r\n                font-size: 14px;\r\n                font-weight: 600;\r\n                border-radius: 4px;\r\n                flex-shrink: 0;\r\n            }\r\n            \r\n            /* Subtitle / Filter Context */\r\n            .subtitle { color: #64748b; font-size: 12px; margin-bottom: 12px; font-weight: 500; }\r\n\r\n            /* Table Styles */\r\n            table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }\r\n            th { \r\n                background: linear-gradient(135deg, #0ea5e9, #38bdf8);\r\n                color: white; \r\n                font-weight: 600; \r\n                text-transform: uppercase; \r\n                letter-spacing: 0.05em; \r\n                font-size: 9px;\r\n                padding: 8px 12px; \r\n                border: 1px solid #0284c7;\r\n                text-align: left;\r\n            }\r\n            \r\n            td { \r\n                padding: 8px 12px; \r\n                border: 1px solid #d1d5db; \r\n                color: #374151; \r\n                vertical-align: top;\r\n                font-size: 10px;\r\n                line-height: 1.4;\r\n                background: white;\r\n            }\r\n\r\n            /* Layout specific column widths based on table headers */\r\n            th:nth-child(1), td:nth-child(1) { width: 25%; }\r\n            th:nth-child(2), td:nth-child(2) { width: 10%; text-align: center; }\r\n            th:nth-child(3), td:nth-child(3) { width: 65%; }\r\n\r\n            /* Organization Header Row */\r\n            .org-header-row td { \r\n                background-color: #f3f4f6; \r\n                color: #111827; \r\n                font-weight: 700; \r\n                font-size: 12px; \r\n                padding: 10px 12px; \r\n                border-top: 2px solid #d1d5db;\r\n            }\r\n\r\n            /* Division Header Row */\r\n            .div-header-row td { \r\n                background-color: #f9fafb; \r\n                color: #4b5563; \r\n                font-style: italic; \r\n                font-weight: 600; \r\n                padding: 6px 12px 6px 24px; \r\n                border-bottom: 1px dashed #cbd5e1;\r\n            }\r\n\r\n            /* Utility Classes */\r\n            .text-primary { color: #111827; }\r\n            .text-secondary { color: #4b5563; }\r\n            .text-sm { font-size: 9px; }\r\n            .font-medium { font-weight: 600; color: #111827; }\r\n            .text-center { text-align: center; }\r\n            \r\n            /* Status Dot */\r\n            .status-dot { \r\n                display: inline-block; \r\n                width: 12px; \r\n                height: 12px; \r\n                border-radius: 50%; \r\n                margin-top: 1px;\r\n                border: 1px solid rgba(0,0,0,0.1);\r\n            }\r\n        `;\r\n\r\n        const wrapper = document.createElement('div');\r\n\r\n        // Banner\r\n        const banner = document.createElement('div');\r\n        banner.className = 'banner';\r\n\r\n        const logoDiv = document.createElement('div');\r\n        const logoImg = document.createElement('img');\r\n        logoImg.src = `${window.location.origin}/header-logo.png`;\r\n        logoImg.alt = \"Saskatchewan Health Partners\";\r\n        logoImg.style.height = '45px';\r\n        logoImg.style.maxWidth = '500px';\r\n        logoImg.style.objectFit = 'contain';\r\n        logoDiv.appendChild(logoImg);\r\n\r\n        const titleDiv = document.createElement('div');\r\n        titleDiv.className = 'banner-title';\r\n        titleDiv.textContent = 'Executive Summary';\r\n\r\n        banner.appendChild(logoDiv);\r\n        banner.appendChild(titleDiv);\r\n\r\n        // Subtitle\r\n        const subtitle = document.createElement('div');\r\n        subtitle.className = 'subtitle';\r\n        subtitle.textContent = `${filterTitle} • Generated on ${today}`;\r\n\r\n        // Assemble\r\n        wrapper.appendChild(banner);\r\n        wrapper.appendChild(subtitle);\r\n        wrapper.appendChild(element); // The cloned table\r\n\r\n        container.appendChild(styleEl);\r\n        container.appendChild(wrapper);\r\n\r\n        // Remove React-specific classes or attributes that might interfere (optional, but robust)\r\n        // Since we provided new CSS, the existing utility classes like 'text-primary' won't affect colors unless we define them.\r\n        // We defined .font-medium, .text-center, .text-secondary above to catch the React classes used in the table.\r\n\r\n        html2pdf().set(opt).from(container).save();\r\n    };\r\n\r\n    const [fullReport, setFullReport] = useState(null);\r\n    const [loadingReport, setLoadingReport] = useState(false);\r\n    const [allProjects, setAllProjects] = useState([]);\r\n    const [loadingSummary, setLoadingSummary] = useState(true);\r\n    const [fetchError, setFetchError] = useState(null);\r\n\r\n\r\n    // Fetch the full status report when user clicks a project row\r\n    const handleProjectClick = async (row) => {\r\n        setSelectedProject(row);\r\n        setFullReport(null);\r\n        setLoadingReport(true);\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects/${row.id}/reports`);\r\n            if (res.ok) {\r\n                const reports = await res.json();\r\n                // API returns sorted DESC — first one is the latest\r\n                setFullReport(reports.length > 0 ? reports[0] : null);\r\n            }\r\n        } catch (err) {\r\n            console.error('Error fetching full report:', err);\r\n        } finally {\r\n            setLoadingReport(false);\r\n        }\r\n    };\r\n\r\n    // Helper to get all descendant goal IDs (recursive)\r\n    const getDescendantGoalIds = (goals, parentId) => {\r\n        let descendants = [];\r\n        // Loose equality to handle potential string/number mismatch\r\n        const children = goals.filter(g => g.parentId == parentId);\r\n        children.forEach(child => {\r\n            descendants.push(child.id);\r\n            descendants = [...descendants, ...getDescendantGoalIds(goals, child.id)];\r\n        });\r\n        return descendants;\r\n    };\r\n\r\n    // Helper to get hierarchy for a project\r\n    const getProjectHierarchy = (goalId) => {\r\n        const hierarchy = {\r\n            organization: '-',\r\n            division: '-',\r\n            department: '-',\r\n            branch: '-'\r\n        };\r\n\r\n        if (!goalId) return hierarchy;\r\n\r\n        const path = [];\r\n        // Loose equality for initial find to handle string/number mismatch\r\n        let current = goals.find(g => g.id == goalId);\r\n\r\n        // Traverse up using loose equality for parentId check\r\n        while (current) {\r\n            path.unshift(current);\r\n            if (!current.parentId) break;\r\n            current = goals.find(g => g.id == current.parentId);\r\n        }\r\n\r\n        // Map depth to levels\r\n        if (path[0]) hierarchy.organization = path[0].title;\r\n        if (path[1]) hierarchy.division = path[1].title;\r\n        if (path[2]) hierarchy.department = path[2].title;\r\n        if (path[3]) hierarchy.branch = path[3].title;\r\n\r\n        return hierarchy;\r\n    };\r\n\r\n    // Fetch full executive summary data on mount\r\n    React.useEffect(() => {\r\n        let isMounted = true;\r\n\r\n        const fetchSummary = async () => {\r\n            setLoadingSummary(true);\r\n            setFetchError(null);\r\n            try {\r\n                // Add simple timeout\r\n                const timeoutPromise = new Promise((_, reject) =>\r\n                    setTimeout(() => reject(new Error('Request timed out (8s)')), 8000)\r\n                );\r\n\r\n                const data = await Promise.race([\r\n                    fetchExecSummaryProjects(),\r\n                    timeoutPromise\r\n                ]);\r\n\r\n                if (isMounted) {\r\n                    if (data && Array.isArray(data) && data.length > 0) {\r\n                        console.log(`ExecDashboard: Loaded ${data.length} projects successfully.`);\r\n                        setAllProjects(data);\r\n                    } else {\r\n                        console.warn(\"ExecDashboard: Fetched data was empty or invalid\", data);\r\n                        // Don't show error for empty list, just use fallback\r\n                    }\r\n                }\r\n            } catch (err) {\r\n                console.error(\"ExecDashboard: Error fetching summary:\", err);\r\n                if (isMounted) setFetchError(err.message);\r\n            } finally {\r\n                if (isMounted) setLoadingSummary(false);\r\n            }\r\n        };\r\n\r\n        fetchSummary();\r\n        return () => { isMounted = false; };\r\n    }, [fetchExecSummaryProjects]);\r\n\r\n    // Process data using Cascading Filter logic\r\n    const groupedData = useMemo(() => {\r\n        // Use allProjects if available, otherwise fallback to context projects (paginated)\r\n        const sourceProjects = allProjects.length > 0 ? allProjects : projects;\r\n\r\n        // 1. Filter projects based on selected goal (and descendants)\r\n        // Mimics logic from KanbanView.jsx\r\n        // 1a. Filter by goal\r\n        let filteredProjects = sourceProjects;\r\n\r\n        if (selectedGoalId) {\r\n            const descendantIds = getDescendantGoalIds(goals, selectedGoalId);\r\n            // Normalize IDs to strings for comparison to avoid mismatches\r\n            const targetIds = [selectedGoalId, ...descendantIds].map(id => String(id));\r\n\r\n            console.log(`Filtering: Selected ${selectedGoalId}, Found ${descendantIds.length} descendants.`);\r\n\r\n            filteredProjects = sourceProjects.filter(p => {\r\n                if (!p.goalId) return false;\r\n                return targetIds.includes(String(p.goalId));\r\n            });\r\n\r\n            console.log(`Filtering Result: ${filteredProjects.length} / ${sourceProjects.length} projects match.`);\r\n        }\r\n\r\n        // 1b. Filter by selected tags (AND logic — project must have ALL selected tags)\r\n        if (selectedTags.length > 0) {\r\n            filteredProjects = filteredProjects.filter(p => {\r\n                if (!p.tags || p.tags.length === 0) return false;\r\n                const projectTagIds = p.tags.map(t => String(t.tagId));\r\n                return selectedTags.every(tagId => projectTagIds.includes(String(tagId)));\r\n            });\r\n        }\r\n\r\n        // 2. Process and Map\r\n        const mapped = filteredProjects.map(p => {\r\n            const h = getProjectHierarchy(p.goalId);\r\n            // Use pre-fetched report if available, otherwise try context\r\n            const report = p.report || getLatestStatusReport(p.id);\r\n            return {\r\n                id: p.id,\r\n                title: p.title,\r\n                ...h,\r\n                overallStatus: report ? report.overallStatus : 'unknown',\r\n                execSummary: report ? report.executiveSummary : 'No report filed',\r\n                report: report\r\n            };\r\n        });\r\n\r\n        // 3. Apply Search Filter\r\n        const finalFiltered = mapped.filter(item => {\r\n            const matchesSearch = item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                item.execSummary?.toLowerCase().includes(searchTerm.toLowerCase());\r\n            return matchesSearch;\r\n        });\r\n\r\n        // Group by Organization -> Division\r\n        const groups = {};\r\n\r\n        finalFiltered.forEach(item => {\r\n            if (!groups[item.organization]) {\r\n                groups[item.organization] = {};\r\n            }\r\n            if (!groups[item.organization][item.division]) {\r\n                groups[item.organization][item.division] = [];\r\n            }\r\n            groups[item.organization][item.division].push(item);\r\n        });\r\n\r\n        // Sort items within divisions\r\n        Object.keys(groups).forEach(org => {\r\n            Object.keys(groups[org]).forEach(div => {\r\n                groups[org][div].sort((a, b) => a.title.localeCompare(b.title));\r\n            });\r\n        });\r\n\r\n        return groups;\r\n    }, [projects, allProjects, goals, getLatestStatusReport, searchTerm, selectedGoalId, selectedTags]);\r\n\r\n    const getStatusColor = (status) => {\r\n        switch (status) {\r\n            case 'green': return '#10b981';\r\n            case 'yellow': return '#f59e0b';\r\n            case 'red': return '#ef4444';\r\n            default: return '#9ca3af';\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"exec-dashboard\">\r\n            <div className=\"view-header\">\r\n                <div>\r\n                    <h2>Executive Summary</h2>\r\n                    <p className=\"view-subtitle\">High-level portfolio status overview</p>\r\n                </div>\r\n                <div className=\"header-actions\">\r\n                    <div className=\"search-bar\">\r\n                        <Search size={18} />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"Search projects...\"\r\n                            value={searchTerm}\r\n                            onChange={e => setSearchTerm(e.target.value)}\r\n                        />\r\n                    </div>\r\n                    <button className=\"btn-primary\" onClick={handleExportPDF}>\r\n                        <Download size={16} />\r\n                        Export PDF\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Filters */}\r\n            <FilterBar\r\n                goalFilter={selectedGoalId}\r\n                onGoalFilterChange={setSelectedGoalId}\r\n                selectedTags={selectedTags}\r\n                onTagsChange={setSelectedTags}\r\n                countLabel={`${Object.values(groupedData).reduce((acc, org) => acc + Object.values(org).reduce((acc2, div) => acc2 + div.length, 0), 0)} project(s)`}\r\n            >\r\n                {searchTerm && (\r\n                    <button className=\"btn-secondary btn-sm shared-clear-btn\" onClick={() => setSearchTerm('')}>\r\n                        <X size={14} /> Clear Search\r\n                    </button>\r\n                )}\r\n            </FilterBar>\r\n\r\n            {/* Table */}\r\n            <div className=\"table-container glass\">\r\n                {fetchError && (\r\n                    <div className=\"bg-red-50 border-l-4 border-red-500 p-4 mb-4 mx-4 mt-4\">\r\n                        <div className=\"flex\">\r\n                            <div className=\"flex-shrink-0\">\r\n                                <svg className=\"h-5 w-5 text-red-400\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\r\n                                    <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\" clipRule=\"evenodd\" />\r\n                                </svg>\r\n                            </div>\r\n                            <div className=\"ml-3\">\r\n                                <p className=\"text-sm text-red-700\">\r\n                                    Error loading full portfolio: {fetchError}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n                <table className=\"exec-table\" ref={tableRef}>\r\n                    <thead>\r\n                        <tr>\r\n                            <th style={{ width: '25%' }}>Project Name</th>\r\n                            <th style={{ width: '10%' }} className=\"text-center\">Status</th>\r\n                            <th style={{ width: '55%' }}>Exec Current Status</th>\r\n                            <th style={{ width: '10%' }}>Last Report</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        {loadingSummary ? (\r\n                            // Skeleton Loader Rows\r\n                            Array.from({ length: 5 }).map((_, idx) => (\r\n                                <tr key={`skeleton-${idx}`}>\r\n                                    <td style={{ padding: '1rem' }}>\r\n                                        <div className=\"h-4 bg-gray-200 rounded w-3/4 animate-pulse\"></div>\r\n                                        <div className=\"h-3 bg-gray-100 rounded w-1/2 mt-2 animate-pulse\"></div>\r\n                                    </td>\r\n                                    <td style={{ padding: '1rem' }}>\r\n                                        <div className=\"h-6 w-20 bg-gray-200 rounded mx-auto animate-pulse\"></div>\r\n                                    </td>\r\n                                    <td style={{ padding: '1rem' }}>\r\n                                        <div className=\"space-y-2\">\r\n                                            <div className=\"h-3 bg-gray-200 rounded w-full animate-pulse\"></div>\r\n                                            <div className=\"h-3 bg-gray-200 rounded w-5/6 animate-pulse\"></div>\r\n                                        </div>\r\n                                    </td>\r\n                                    <td style={{ padding: '1rem' }}>\r\n                                        <div className=\"h-3 bg-gray-200 rounded w-24 animate-pulse\"></div>\r\n                                    </td>\r\n                                </tr>\r\n                            ))\r\n                        ) : Object.keys(groupedData).length === 0 ? (\r\n                            <tr>\r\n                                <td colSpan={4} style={{ textAlign: 'center', padding: '2rem', color: 'var(--text-tertiary)' }}>\r\n                                    No projects found matching your filters.\r\n                                </td>\r\n                            </tr>\r\n                        ) : (\r\n                            Object.entries(groupedData)\r\n                                .sort(([a], [b]) => a.localeCompare(b))\r\n                                .map(([orgName, divisions]) => (\r\n                                    <React.Fragment key={orgName}>\r\n                                        {/* Organization Header */}\r\n                                        <tr className=\"org-header-row\">\r\n                                            <td colSpan={4}>{orgName}</td>\r\n                                        </tr>\r\n                                        {/* Divisions */}\r\n                                        {Object.entries(divisions)\r\n                                            .sort(([a], [b]) => a.localeCompare(b))\r\n                                            .map(([divName, projects]) => (\r\n                                                <React.Fragment key={`${orgName}-${divName}`}>\r\n                                                    <tr className=\"div-header-row\">\r\n                                                        <td colSpan={4}>{divName}</td>\r\n                                                    </tr>\r\n                                                    {/* Projects */}\r\n                                                    {projects.map(project => {\r\n                                                        const report = project.report || getLatestStatusReport(project.id);\r\n                                                        const statusColor = report ? getStatusColor(report.overallStatus) : '#e5e7eb';\r\n                                                        const statusLabel = report\r\n                                                            ? (report.overallStatus.charAt(0).toUpperCase() + report.overallStatus.slice(1))\r\n                                                            : 'No Report';\r\n\r\n                                                        const reportCountText = project.reportCount > 0 ? `${project.reportCount} reports` : '';\r\n\r\n                                                        return (\r\n                                                            <tr\r\n                                                                key={project.id}\r\n                                                                className=\"project-row\"\r\n                                                                onClick={() => handleProjectClick(project)}\r\n                                                                style={{ cursor: 'pointer' }}\r\n                                                            >\r\n                                                                <td className=\"font-medium\">\r\n                                                                    <div className=\"project-title\">{project.title}</div>\r\n                                                                    {reportCountText && (\r\n                                                                        <div className=\"text-xs text-gray-500 mt-1\">\r\n                                                                            {reportCountText}\r\n                                                                        </div>\r\n                                                                    )}\r\n                                                                </td>\r\n                                                                <td className=\"text-center\">\r\n                                                                    <div\r\n                                                                        className=\"status-dot\"\r\n                                                                        style={{ backgroundColor: statusColor }}\r\n                                                                        title={statusLabel}\r\n                                                                    />\r\n                                                                </td>\r\n                                                                <td className=\"text-sm text-gray-600 max-w-md truncate-cell\">\r\n                                                                    {report?.executiveSummary || (\r\n                                                                        <span className=\"italic text-gray-400\">No executive summary available</span>\r\n                                                                    )}\r\n                                                                </td>\r\n                                                                <td className=\"text-sm text-gray-500 whitespace-nowrap\">\r\n                                                                    {report ? formatShortDate(report.updatedAt) : '-'}\r\n                                                                </td>\r\n                                                            </tr>\r\n                                                        );\r\n                                                    })}\r\n                                                </React.Fragment>\r\n                                            ))}\r\n                                    </React.Fragment>\r\n                                ))\r\n                        )}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n\r\n            {selectedProject && (\r\n                <Modal\r\n                    isOpen={!!selectedProject}\r\n                    onClose={() => { setSelectedProject(null); setFullReport(null); }}\r\n                    title={`Status Report: ${selectedProject.title}`}\r\n                    size=\"xl\"\r\n                    closeOnOverlayClick={false}\r\n                >\r\n                    <div style={{ maxHeight: '80vh', overflowY: 'auto' }}>\r\n                        {loadingReport ? (\r\n                            <div style={{ padding: '2rem', textAlign: 'center', color: 'var(--text-secondary)' }}>\r\n                                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600\" style={{ margin: '0 auto 1rem' }}></div>\r\n                                Loading full report...\r\n                            </div>\r\n                        ) : fullReport ? (\r\n                            <StatusReportView\r\n                                report={fullReport}\r\n                                projectTitle={selectedProject.title}\r\n                                hideActions={true}\r\n                            />\r\n                        ) : (\r\n                            <div style={{ padding: '2rem', textAlign: 'center', color: 'var(--text-secondary)' }}>\r\n                                <p>No status report has been filed for <strong>{selectedProject.title}</strong> yet.</p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </Modal>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\AddGoalForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\EditGoalForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\GoalItem.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  27 |     useEffect(() => {\n  28 |         if (forceExpand !== null && forceExpand !== undefined) {\n> 29 |             setIsExpanded(forceExpand);\n     |             ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  30 |             setChildrenCollapsed(forceExpand ? null : false);\n  31 |         }\n  32 |     }, [forceExpand]);","line":29,"column":13,"nodeType":null,"endLine":29,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ChevronRight, ChevronDown, Plus, MoreHorizontal, Folder, Edit, Trash2, Activity } from 'lucide-react';\r\nimport { useState, useRef, useEffect } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { useToast } from '../../context/ToastContext';\r\nimport { Modal } from '../UI/Modal';\r\nimport { AddGoalForm } from './AddGoalForm';\r\nimport { EditGoalForm } from './EditGoalForm';\r\nimport { KPIManager } from './KPIManager';\r\nimport './KPI.css';\r\nimport { getDescendantGoalIds } from '../UI/CascadingGoalFilter';\r\n\r\nimport { useAuth } from '../../hooks/useAuth';\r\n\r\nexport function GoalItem({ goal, level = 0, onNavigateToProjects, onNavigateToMetrics, forceExpand, selectedTags = [] }) {\r\n    const { goals, deleteGoal, projects } = useData();\r\n    const { canEdit, canDelete } = useAuth();\r\n    const toast = useToast();\r\n    const [isExpanded, setIsExpanded] = useState(level === 0);\r\n    const [childrenCollapsed, setChildrenCollapsed] = useState(null);\r\n    const [showAddModal, setShowAddModal] = useState(false);\r\n    const [showEditModal, setShowEditModal] = useState(false);\r\n    const [showMenu, setShowMenu] = useState(false);\r\n    const [confirmDelete, setConfirmDelete] = useState(false);\r\n    const menuRef = useRef(null);\r\n\r\n    // Respond to forceExpand prop from parent\r\n    useEffect(() => {\r\n        if (forceExpand !== null && forceExpand !== undefined) {\r\n            setIsExpanded(forceExpand);\r\n            setChildrenCollapsed(forceExpand ? null : false);\r\n        }\r\n    }, [forceExpand]);\r\n\r\n    const childGoals = goals.filter(g => g.parentId === goal.id);\r\n    const hasChildren = childGoals.length > 0;\r\n\r\n    // Use pre-calculated counts from DataContext (server-backed)\r\n    // When tags are selected, compute count client-side from loaded projects\r\n    const projectCount = (() => {\r\n        if (selectedTags.length === 0) return goal.totalProjectCount || 0;\r\n        // Get all goal IDs in this subtree (this goal + descendants)\r\n        const allGoalIds = [goal.id, ...getDescendantGoalIds(goals, goal.id)];\r\n        return projects.filter(p =>\r\n            allGoalIds.includes(p.goalId) &&\r\n            p.tags && p.tags.some(t => selectedTags.includes(String(t.id)))\r\n        ).length;\r\n    })();\r\n\r\n    const typeLabels = {\r\n        org: 'Organization',\r\n        div: 'Division',\r\n        dept: 'Department',\r\n        branch: 'Branch'\r\n    };\r\n\r\n    const typeColors = {\r\n        org: 'var(--accent-primary)',\r\n        div: '#10b981',\r\n        dept: '#f59e0b',\r\n        branch: '#ec4899',\r\n    };\r\n\r\n    useEffect(() => {\r\n        const handleClickOutside = (e) => {\r\n            if (menuRef.current && !menuRef.current.contains(e.target)) {\r\n                setShowMenu(false);\r\n                setConfirmDelete(false);\r\n            }\r\n        };\r\n        document.addEventListener('mousedown', handleClickOutside);\r\n        return () => document.removeEventListener('mousedown', handleClickOutside);\r\n    }, []);\r\n\r\n    const handleProjectCountClick = (e) => {\r\n        e.stopPropagation();\r\n        if (onNavigateToProjects) {\r\n            onNavigateToProjects(goal.id);\r\n        }\r\n    };\r\n\r\n    const handleKpiClick = (e) => {\r\n        e.stopPropagation();\r\n        if (onNavigateToMetrics) {\r\n            onNavigateToMetrics(goal.id);\r\n        }\r\n    };\r\n\r\n    const handleMenuToggle = (e) => {\r\n        e.stopPropagation();\r\n        setShowMenu(!showMenu);\r\n        setConfirmDelete(false);\r\n    };\r\n\r\n    const handleEdit = () => {\r\n        setShowMenu(false);\r\n        setShowEditModal(true);\r\n    };\r\n\r\n    const handleDelete = () => {\r\n        if (confirmDelete) {\r\n            deleteGoal(goal.id);\r\n            toast.success('Goal deleted');\r\n            setShowMenu(false);\r\n        } else {\r\n            setConfirmDelete(true);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"goal-item-container\" style={{ '--level': level }} data-level={level}>\r\n            <div className=\"goal-card glass\">\r\n                <div className=\"goal-header\">\r\n                    <button\r\n                        className={`expand-btn ${hasChildren ? '' : 'hidden'}`}\r\n                        onClick={() => {\r\n                            if (isExpanded) {\r\n                                setChildrenCollapsed(false);\r\n                                setTimeout(() => setChildrenCollapsed(null), 50);\r\n                            }\r\n                            setIsExpanded(!isExpanded);\r\n                        }}\r\n                    >\r\n                        {isExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}\r\n                    </button>\r\n\r\n                    <div className=\"goal-info\">\r\n                        <div className=\"goal-top-row\">\r\n                            <span\r\n                                className=\"goal-type-badge\"\r\n                                style={{ backgroundColor: typeColors[goal.type] || 'gray' }}\r\n                            >\r\n                                {typeLabels[goal.type]}\r\n                            </span>\r\n                            <div className=\"goal-actions\">\r\n                                {/* KPI indicator */}\r\n                                {(goal.totalKpiCount > 0 || (goal.kpis && goal.kpis.length > 0)) && (\r\n                                    <button\r\n                                        className=\"kpi-indicator\"\r\n                                        title={`View ${goal.totalKpiCount} Total KPI(s) (including sub-goals)`}\r\n                                        onClick={handleKpiClick}\r\n                                    >\r\n                                        <Activity size={14} />\r\n                                        <span>{goal.totalKpiCount || goal.kpis?.length || 0}</span>\r\n                                    </button>\r\n                                )}\r\n                                {/* Project count link */}\r\n                                <button\r\n                                    className=\"project-count-btn\"\r\n                                    onClick={handleProjectCountClick}\r\n                                    title={`View ${projectCount} linked project(s)`}\r\n                                >\r\n                                    <Folder size={14} />\r\n                                    <span>{projectCount}</span>\r\n                                </button>\r\n                                {canEdit && goal.type !== 'branch' && (\r\n                                    <button className=\"icon-btn\" onClick={() => setShowAddModal(true)} title=\"Add Sub-goal\">\r\n                                        <Plus size={16} />\r\n                                    </button>\r\n                                )}\r\n\r\n                                {/* Dropdown Menu - only show if canEdit or canDelete */}\r\n                                {(canEdit || canDelete) && (\r\n                                    <div className=\"goal-menu-container\" ref={menuRef}>\r\n                                        <button className=\"icon-btn\" onClick={handleMenuToggle}>\r\n                                            <MoreHorizontal size={16} />\r\n                                        </button>\r\n\r\n                                        {showMenu && (\r\n                                            <div className=\"goal-dropdown-menu\">\r\n                                                {canEdit && (\r\n                                                    <button className=\"menu-item\" onClick={handleEdit}>\r\n                                                        <Edit size={14} />\r\n                                                        Edit Goal\r\n                                                    </button>\r\n                                                )}\r\n                                                {canDelete && (\r\n                                                    <button\r\n                                                        className={`menu-item danger ${confirmDelete ? 'confirm' : ''}`}\r\n                                                        onClick={handleDelete}\r\n                                                    >\r\n                                                        <Trash2 size={14} />\r\n                                                        {confirmDelete ? 'Click to Confirm' : 'Delete Goal'}\r\n                                                    </button>\r\n                                                )}\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                        <h3 className=\"goal-title\">{goal.title}</h3>\r\n                        {goal.description && <p className=\"goal-desc\">{goal.description}</p>}\r\n\r\n\r\n\r\n                        <div className=\"goal-progress-bar\">\r\n                            <div\r\n                                className=\"progress-fill\"\r\n                                style={{ width: `${goal.progress || 0}%`, backgroundColor: typeColors[goal.type] }}\r\n                            ></div>\r\n                        </div>\r\n                        <span className=\"goal-progress-text\">{goal.progress}% Complete</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {isExpanded && hasChildren && (\r\n                <div className=\"goal-children\">\r\n                    {childGoals.map(child => (\r\n                        <GoalItem\r\n                            key={child.id}\r\n                            goal={child}\r\n                            level={level + 1}\r\n                            onNavigateToProjects={onNavigateToProjects}\r\n                            onNavigateToMetrics={onNavigateToMetrics}\r\n                            forceExpand={childrenCollapsed !== null ? childrenCollapsed : forceExpand}\r\n                            selectedTags={selectedTags}\r\n                        />\r\n                    ))}\r\n\r\n                </div>\r\n            )}\r\n\r\n            <Modal\r\n                isOpen={showAddModal}\r\n                onClose={() => setShowAddModal(false)}\r\n                title={`Add Objective under \"${goal.title}\"`}\r\n                closeOnOverlayClick={false}\r\n            >\r\n                <AddGoalForm onClose={() => setShowAddModal(false)} parentId={goal.id} parentType={goal.type} />\r\n            </Modal>\r\n\r\n            <Modal\r\n                isOpen={showEditModal}\r\n                onClose={() => setShowEditModal(false)}\r\n                title=\"Edit Goal\"\r\n                closeOnOverlayClick={false}\r\n            >\r\n                <EditGoalForm goal={goal} onClose={() => setShowEditModal(false)} />\r\n                <KPIManager goalId={goal.id} kpis={goal.kpis || []} />\r\n            </Modal>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\GoalView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\KPIManager.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\IntakeFormBuilder.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\IntakeFormView.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  55 |                 }\n  56 |             });\n> 57 |             setFormData(initialData);\n     |             ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  58 |         }\n  59 |     }, [form, account]);\n  60 |","line":57,"column":13,"nodeType":null,"endLine":57,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react';\r\nimport { CheckCircle, AlertCircle, Send, MessageSquare } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { useAuth } from '../../hooks/useAuth';\r\nimport './Intake.css';\r\n\r\nexport function IntakeFormView({ formId, submissionId }) {\r\n    const {\r\n        intakeForms,\r\n        addIntakeSubmission,\r\n        intakeSubmissions,\r\n        addConversationMessage,\r\n        migrateInfoRequestsToConversation\r\n    } = useData();\r\n    const [formData, setFormData] = useState({});\r\n    const [submitted, setSubmitted] = useState(false);\r\n    const [error, setError] = useState('');\r\n    const [responseText, setResponseText] = useState('');\r\n    const conversationEndRef = useRef(null);\r\n\r\n    const form = intakeForms.find(f => f.id === formId);\r\n    const rawSubmission = submissionId ? intakeSubmissions.find(s => s.id === submissionId) : null;\r\n    const submission = rawSubmission ? migrateInfoRequestsToConversation(rawSubmission) : null;\r\n\r\n    // Check if this is a conversation response (has submission ID)\r\n    const isConversationMode = !!submissionId && !!submission;\r\n    const hasConversation = submission?.conversation?.length > 0;\r\n\r\n    // Auto-scroll to bottom of conversation\r\n    useEffect(() => {\r\n        if (conversationEndRef.current) {\r\n            conversationEndRef.current.scrollIntoView({ behavior: 'smooth' });\r\n        }\r\n    }, [submission?.conversation]);\r\n\r\n    const { account } = useAuth(); // Get current user\r\n\r\n    useEffect(() => {\r\n        // Initialize form data\r\n        if (form) {\r\n            const initialData = {};\r\n            form.fields.forEach(field => {\r\n                // Auto-fill known fields if available\r\n                if (account) {\r\n                    const labelLower = field.label.toLowerCase();\r\n                    if (labelLower.includes('name') && !labelLower.includes('project')) {\r\n                        initialData[field.id] = account.name || '';\r\n                    } else if (labelLower.includes('email')) {\r\n                        initialData[field.id] = account.username || '';\r\n                    } else {\r\n                        initialData[field.id] = '';\r\n                    }\r\n                } else {\r\n                    initialData[field.id] = '';\r\n                }\r\n            });\r\n            setFormData(initialData);\r\n        }\r\n    }, [form, account]);\r\n\r\n    const formatMessageTime = (dateStr) => {\r\n        return new Date(dateStr).toLocaleDateString('en-US', {\r\n            month: 'short',\r\n            day: 'numeric',\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        });\r\n    };\r\n\r\n    if (!form) {\r\n        return (\r\n            <div className=\"intake-public-page\">\r\n                <div className=\"intake-public-card\">\r\n                    <div className=\"intake-success\">\r\n                        <div className=\"intake-success-icon\" style={{ background: 'rgba(239, 68, 68, 0.1)', color: '#ef4444' }}>\r\n                            <AlertCircle size={40} />\r\n                        </div>\r\n                        <h2>Form Not Found</h2>\r\n                        <p>This intake form doesn't exist or has been removed.</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Conversation response mode\r\n    if (isConversationMode) {\r\n        // Check if submission is already closed\r\n        if (submission.status === 'approved' || submission.status === 'rejected') {\r\n            return (\r\n                <div className=\"intake-public-page\">\r\n                    <div className=\"intake-public-card\">\r\n                        <div className=\"intake-success\">\r\n                            <div className=\"intake-success-icon\" style={{\r\n                                background: submission.status === 'approved'\r\n                                    ? 'rgba(16, 185, 129, 0.1)'\r\n                                    : 'rgba(239, 68, 68, 0.1)',\r\n                                color: submission.status === 'approved' ? '#10b981' : '#ef4444'\r\n                            }}>\r\n                                <CheckCircle size={40} />\r\n                            </div>\r\n                            <h2>Request {submission.status === 'approved' ? 'Approved' : 'Closed'}</h2>\r\n                            <p>\r\n                                {submission.status === 'approved'\r\n                                    ? 'Your request has been approved and converted to a project.'\r\n                                    : 'This request has been closed.'}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        const handleConversationResponse = async (e) => {\r\n            e.preventDefault();\r\n            if (!responseText.trim()) return;\r\n            await addConversationMessage(submissionId, responseText, 'requester');\r\n            setResponseText('');\r\n            setSubmitted(true);\r\n        };\r\n\r\n        if (submitted) {\r\n            return (\r\n                <div className=\"intake-public-page\">\r\n                    <div className=\"intake-public-card\">\r\n                        <div className=\"intake-success\">\r\n                            <div className=\"intake-success-icon\">\r\n                                <CheckCircle size={40} />\r\n                            </div>\r\n                            <h2>Response Submitted</h2>\r\n                            <p>Thank you for your response. The team will review it and may follow up with additional questions.</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        return (\r\n            <div className=\"intake-public-page\">\r\n                <div className=\"intake-public-card\">\r\n                    <div className=\"intake-public-header\">\r\n                        <div className=\"intake-header-brand\">Digital Health Atlas</div>\r\n                        <h1>Conversation</h1>\r\n                        <p>View messages and respond to questions about your request.</p>\r\n                    </div>\r\n\r\n                    <div className=\"intake-public-form\">\r\n                        {/* Show conversation history */}\r\n                        {hasConversation && (\r\n                            <div className=\"requester-conversation\">\r\n                                <h3>\r\n                                    <MessageSquare size={18} style={{ marginRight: '0.5rem', verticalAlign: 'middle' }} />\r\n                                    Message History\r\n                                </h3>\r\n                                <div className=\"conversation-thread\">\r\n                                    {submission.conversation.map(msg => (\r\n                                        <div key={msg.id} className={`conversation-message ${msg.type}`}>\r\n                                            <div className=\"message-bubble\">\r\n                                                {msg.message}\r\n                                            </div>\r\n                                            <div className=\"message-meta\">\r\n                                                {msg.type === 'admin' ? 'Project Team' : 'You'} • {formatMessageTime(msg.timestamp)}\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                    <div ref={conversationEndRef} />\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Response input */}\r\n                        <form onSubmit={handleConversationResponse}>\r\n                            <div className=\"intake-field\">\r\n                                <label>Your Response <span className=\"required-star\">*</span></label>\r\n                                <textarea\r\n                                    value={responseText}\r\n                                    onChange={(e) => setResponseText(e.target.value)}\r\n                                    rows={4}\r\n                                    required\r\n                                    placeholder=\"Enter your response...\"\r\n                                />\r\n                            </div>\r\n                            <button type=\"submit\" className=\"btn-primary\" style={{ width: '100%' }}>\r\n                                <Send size={18} /> Send Response\r\n                            </button>\r\n                        </form>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Regular form submission mode\r\n    const handleChange = (fieldId, value) => {\r\n        setFormData(prev => ({ ...prev, [fieldId]: value }));\r\n        setError('');\r\n    };\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n\r\n        // Validate required fields\r\n        const missingFields = form.fields\r\n            .filter(f => f.required && !formData[f.id])\r\n            .map(f => f.label);\r\n\r\n        if (missingFields.length > 0) {\r\n            setError(`Please fill in: ${missingFields.join(', ')}`);\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await addIntakeSubmission({\r\n                formId: form.id,\r\n                formData: formData\r\n            });\r\n            setSubmitted(true);\r\n        } catch (err) {\r\n            console.error(\"Submission failed:\", err);\r\n            setError(\"Failed to submit request. Please try again.\");\r\n        }\r\n    };\r\n\r\n    if (submitted) {\r\n        return (\r\n            <div className=\"intake-public-page\">\r\n                <div className=\"intake-public-card\">\r\n                    <div className=\"intake-success\">\r\n                        <div className=\"intake-success-icon\">\r\n                            <CheckCircle size={40} />\r\n                        </div>\r\n                        <h2>Request Submitted!</h2>\r\n                        <p>Thank you for your submission. Our team will review your request and get back to you soon.</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"intake-public-page\">\r\n            <div className=\"intake-public-card\">\r\n                <div className=\"intake-public-header\">\r\n                    <div className=\"intake-header-brand\">Digital Health Atlas</div>\r\n                    <h1>{form.name}</h1>\r\n                    {form.description && <p>{form.description}</p>}\r\n                </div>\r\n\r\n                <form className=\"intake-public-form\" onSubmit={handleSubmit}>\r\n                    {form.fields.map(field => (\r\n                        <div key={field.id} className=\"intake-field\">\r\n                            <label>\r\n                                {field.label}\r\n                                {field.required && <span className=\"required-star\"> *</span>}\r\n                            </label>\r\n\r\n                            {field.type === 'text' && (\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={formData[field.id] || ''}\r\n                                    onChange={(e) => handleChange(field.id, e.target.value)}\r\n                                    required={field.required}\r\n                                />\r\n                            )}\r\n\r\n                            {field.type === 'textarea' && (\r\n                                <textarea\r\n                                    value={formData[field.id] || ''}\r\n                                    onChange={(e) => handleChange(field.id, e.target.value)}\r\n                                    rows={4}\r\n                                    required={field.required}\r\n                                />\r\n                            )}\r\n\r\n                            {field.type === 'email' && (\r\n                                <input\r\n                                    type=\"email\"\r\n                                    value={formData[field.id] || ''}\r\n                                    onChange={(e) => handleChange(field.id, e.target.value)}\r\n                                    required={field.required}\r\n                                />\r\n                            )}\r\n\r\n                            {field.type === 'number' && (\r\n                                <input\r\n                                    type=\"number\"\r\n                                    value={formData[field.id] || ''}\r\n                                    onChange={(e) => handleChange(field.id, e.target.value)}\r\n                                    required={field.required}\r\n                                />\r\n                            )}\r\n\r\n                            {field.type === 'date' && (\r\n                                <input\r\n                                    type=\"date\"\r\n                                    value={formData[field.id] || ''}\r\n                                    onChange={(e) => handleChange(field.id, e.target.value)}\r\n                                    required={field.required}\r\n                                />\r\n                            )}\r\n\r\n                            {field.type === 'select' && (\r\n                                <select\r\n                                    value={formData[field.id] || ''}\r\n                                    onChange={(e) => handleChange(field.id, e.target.value)}\r\n                                    required={field.required}\r\n                                >\r\n                                    <option value=\"\">Select...</option>\r\n                                    {(field.options || []).map(opt => (\r\n                                        <option key={opt} value={opt}>{opt}</option>\r\n                                    ))}\r\n                                </select>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n\r\n                    {error && (\r\n                        <div style={{ color: '#ef4444', fontSize: '0.875rem' }}>\r\n                            {error}\r\n                        </div>\r\n                    )}\r\n\r\n                    <button type=\"submit\" className=\"btn-primary\" style={{ width: '100%' }}>\r\n                        Submit Request\r\n                    </button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\IntakePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\IntakeRequestsList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\MySubmissionsList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\AddProjectForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\AddTaskForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\CalendarView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\EditProjectForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\GanttView.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has missing dependencies: 'getTaskEndDate' and 'getTaskStartDate'. Either include them or remove the dependency array.","line":197,"column":8,"nodeType":"ArrayExpression","endLine":197,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [sortedTasks, getTaskStartDate, getTaskEndDate, rangeStart, rangeEnd]","fix":{"range":[7231,7266],"text":"[sortedTasks, getTaskStartDate, getTaskEndDate, rangeStart, rangeEnd]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react';\r\nimport { Calendar, ChevronLeft, ChevronRight } from 'lucide-react';\r\nimport './Gantt.css';\r\n\r\nconst STATUS_COLORS = {\r\n    'todo': '#6b7280',\r\n    'in-progress': '#3b82f6',\r\n    'review': '#8b5cf6',\r\n    'done': '#059669'\r\n};\r\n\r\nconst PRIORITY_COLORS = {\r\n    high: '#ef4444',\r\n    medium: '#f59e0b',\r\n    low: '#6b7280'\r\n};\r\n\r\nconst VIEW_PERIODS = {\r\n    week: { label: 'Week', days: 7, showDays: true },\r\n    month: { label: 'Month', days: 28, showDays: true },\r\n    quarter: { label: 'Quarter', days: 91, showDays: false },\r\n    year: { label: 'Year', days: 365, showDays: false }\r\n};\r\n\r\nexport function GanttView({ project, onTaskClick }) {\r\n    const [periodOffset, setPeriodOffset] = useState(0);\r\n    const [viewPeriod, setViewPeriod] = useState('month');\r\n\r\n    const periodConfig = VIEW_PERIODS[viewPeriod];\r\n    const periodDays = periodConfig.days;\r\n    const showDays = periodConfig.showDays;\r\n\r\n    // Get date range for the view\r\n    const dateRange = useMemo(() => {\r\n        const today = new Date();\r\n        today.setHours(0, 0, 0, 0);\r\n\r\n        const startOfWeek = new Date(today);\r\n        startOfWeek.setDate(today.getDate() - today.getDay());\r\n        startOfWeek.setDate(startOfWeek.getDate() + (periodOffset * periodDays));\r\n\r\n        const days = [];\r\n        for (let i = 0; i < periodDays; i++) {\r\n            const date = new Date(startOfWeek);\r\n            date.setDate(startOfWeek.getDate() + i);\r\n            days.push(date);\r\n        }\r\n        return days;\r\n    }, [periodOffset, periodDays]);\r\n\r\n    const rangeStart = dateRange[0];\r\n    const rangeEnd = dateRange[dateRange.length - 1];\r\n\r\n    // Group days by week for week/month views\r\n    const weeks = useMemo(() => {\r\n        if (!showDays) return [];\r\n        const grouped = [];\r\n        for (let i = 0; i < dateRange.length; i += 7) {\r\n            grouped.push(dateRange.slice(i, Math.min(i + 7, dateRange.length)));\r\n        }\r\n        return grouped;\r\n    }, [dateRange, showDays]);\r\n\r\n    // Group days by month for quarter/year views\r\n    const months = useMemo(() => {\r\n        if (showDays) return [];\r\n        const grouped = [];\r\n        let currentMonth = null;\r\n        let currentGroup = [];\r\n\r\n        dateRange.forEach(date => {\r\n            const monthKey = `${date.getFullYear()}-${date.getMonth()}`;\r\n            if (monthKey !== currentMonth) {\r\n                if (currentGroup.length > 0) {\r\n                    grouped.push(currentGroup);\r\n                }\r\n                currentMonth = monthKey;\r\n                currentGroup = [date];\r\n            } else {\r\n                currentGroup.push(date);\r\n            }\r\n        });\r\n        if (currentGroup.length > 0) {\r\n            grouped.push(currentGroup);\r\n        }\r\n        return grouped;\r\n    }, [dateRange, showDays]);\r\n\r\n    const formatDay = (date) => date.getDate();\r\n    const formatDayName = (date) => ['S', 'M', 'T', 'W', 'T', 'F', 'S'][date.getDay()];\r\n    const formatMonth = (date) => date.toLocaleDateString('en-US', { month: 'short' });\r\n    const formatMonthYear = (date) => date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });\r\n\r\n    const isToday = (date) => {\r\n        const today = new Date();\r\n        today.setHours(0, 0, 0, 0);\r\n        const compareDate = new Date(date);\r\n        compareDate.setHours(0, 0, 0, 0);\r\n        return compareDate.getTime() === today.getTime();\r\n    };\r\n\r\n    const isWeekend = (date) => date.getDay() === 0 || date.getDay() === 6;\r\n\r\n    const normalizeDate = (date) => {\r\n        const d = new Date(date);\r\n        // FORCE the local date object to match the UTC date components\r\n        // e.g. 2026-02-04 UTC -> 2026-02-04 Local representation\r\n        return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());\r\n    };\r\n\r\n    const getTaskStartDate = (task) => {\r\n        if (task.startDate) return normalizeDate(task.startDate);\r\n        if (task.dueDate) return normalizeDate(task.dueDate);\r\n        return null;\r\n    };\r\n\r\n    const getTaskEndDate = (task) => {\r\n        if (task.endDate) return normalizeDate(task.endDate);\r\n        if (task.dueDate) return normalizeDate(task.dueDate);\r\n        return null;\r\n    };\r\n\r\n\r\n\r\n    const getTaskBar = (task) => {\r\n        const startDate = getTaskStartDate(task);\r\n        const endDate = getTaskEndDate(task);\r\n        if (!startDate && !endDate) return null;\r\n\r\n        const taskStart = startDate || endDate;\r\n        const taskEnd = endDate || startDate;\r\n\r\n        if (taskEnd < rangeStart || taskStart > rangeEnd) return null;\r\n\r\n        const visibleStart = taskStart < rangeStart ? rangeStart : taskStart;\r\n        const visibleEnd = taskEnd > rangeEnd ? rangeEnd : taskEnd;\r\n\r\n        // Calculate position based on days from start\r\n        const totalDays = (rangeEnd - rangeStart) / (1000 * 60 * 60 * 24) + 1;\r\n        const startDays = (visibleStart - rangeStart) / (1000 * 60 * 60 * 24);\r\n        const durationDays = (visibleEnd - visibleStart) / (1000 * 60 * 60 * 24) + 1;\r\n\r\n        const left = (startDays / totalDays) * 100;\r\n        const width = (durationDays / totalDays) * 100;\r\n\r\n        return {\r\n            left: `${left}%`,\r\n            width: `${Math.max(width, 1)}%`,\r\n            overflowLeft: taskStart < rangeStart,\r\n            overflowRight: taskEnd > rangeEnd\r\n        };\r\n    };\r\n\r\n    const sortedTasks = useMemo(() => {\r\n        const normalize = (date) => {\r\n            const d = new Date(date);\r\n            d.setHours(0, 0, 0, 0);\r\n            return d;\r\n        };\r\n        const getStart = (task) => {\r\n            if (task.startDate) return normalize(task.startDate);\r\n            if (task.dueDate) return normalize(task.dueDate);\r\n            return null;\r\n        };\r\n        const getEnd = (task) => {\r\n            if (task.endDate) return normalize(task.endDate);\r\n            if (task.dueDate) return normalize(task.dueDate);\r\n            return null;\r\n        };\r\n        return [...(project.tasks || [])].sort((a, b) => {\r\n            const aDate = getStart(a) || getEnd(a);\r\n            const bDate = getStart(b) || getEnd(b);\r\n            if (!aDate && !bDate) return 0;\r\n            if (!aDate) return 1;\r\n            if (!bDate) return -1;\r\n            return aDate - bDate;\r\n        });\r\n    }, [project.tasks]);\r\n\r\n    // Memoize task filtering with proper dependencies\r\n    const { visibleTasks, tasksWithDatesButNotVisible, tasksWithoutDates } = useMemo(() => {\r\n        const hasDates = (task) => task.startDate || task.endDate || task.dueDate;\r\n        const isVisible = (task) => {\r\n            const startDate = getTaskStartDate(task);\r\n            const endDate = getTaskEndDate(task);\r\n            if (!startDate && !endDate) return false;\r\n            const taskStart = startDate || endDate;\r\n            const taskEnd = endDate || startDate;\r\n            return taskEnd >= rangeStart && taskStart <= rangeEnd;\r\n        };\r\n\r\n        return {\r\n            visibleTasks: sortedTasks.filter(t => hasDates(t) && isVisible(t)),\r\n            tasksWithDatesButNotVisible: sortedTasks.filter(t => hasDates(t) && !isVisible(t)),\r\n            tasksWithoutDates: sortedTasks.filter(t => !hasDates(t))\r\n        };\r\n    }, [sortedTasks, rangeStart, rangeEnd]);\r\n\r\n    const handlePeriodChange = (newPeriod) => {\r\n        setViewPeriod(newPeriod);\r\n        setPeriodOffset(0);\r\n    };\r\n\r\n    // Render grid cells based on view type\r\n    const renderGridCells = () => {\r\n        if (showDays) {\r\n            return dateRange.map((day, idx) => (\r\n                <div\r\n                    key={idx}\r\n                    className={`gantt-cell ${isToday(day) ? 'today' : ''} ${isWeekend(day) ? 'weekend' : ''}`}\r\n                />\r\n            ));\r\n        } else {\r\n            // For quarter/year, use month-based cells\r\n            return months.map((monthDays, idx) => (\r\n                <div\r\n                    key={idx}\r\n                    className=\"gantt-cell gantt-month-cell\"\r\n                    style={{ flex: monthDays.length }}\r\n                />\r\n            ));\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"gantt-container\">\r\n            {/* Timeline Navigation */}\r\n            <div className=\"gantt-nav\">\r\n                <div className=\"gantt-nav-left\">\r\n                    <button className=\"gantt-nav-btn\" onClick={() => setPeriodOffset(o => o - 1)}>\r\n                        <ChevronLeft size={18} />\r\n                    </button>\r\n                    <button className=\"gantt-nav-btn today-btn\" onClick={() => setPeriodOffset(0)}>\r\n                        <Calendar size={16} />\r\n                        Today\r\n                    </button>\r\n                    <button className=\"gantt-nav-btn\" onClick={() => setPeriodOffset(o => o + 1)}>\r\n                        <ChevronRight size={18} />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* View Period Selector */}\r\n                <div className=\"gantt-period-selector\">\r\n                    {Object.entries(VIEW_PERIODS).map(([key, { label }]) => (\r\n                        <button\r\n                            key={key}\r\n                            className={`gantt-period-btn ${viewPeriod === key ? 'active' : ''}`}\r\n                            onClick={() => handlePeriodChange(key)}\r\n                        >\r\n                            {label}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"gantt-chart\">\r\n                {/* Header */}\r\n                <div className=\"gantt-header\">\r\n                    <div className=\"gantt-task-label\">Task</div>\r\n                    <div className=\"gantt-timeline-header\">\r\n                        {showDays ? (\r\n                            // Week/Month view: show individual days\r\n                            weeks.map((week, weekIdx) => (\r\n                                <div key={weekIdx} className=\"gantt-week\" style={{ flex: week.length }}>\r\n                                    <div className=\"gantt-week-label\">\r\n                                        {formatMonth(week[0])} {formatDay(week[0])} - {formatDay(week[week.length - 1])}\r\n                                    </div>\r\n                                    <div className=\"gantt-days\">\r\n                                        {week.map((day, dayIdx) => (\r\n                                            <div\r\n                                                key={dayIdx}\r\n                                                className={`gantt-day-header ${isToday(day) ? 'today' : ''} ${isWeekend(day) ? 'weekend' : ''}`}\r\n                                            >\r\n                                                <span className=\"day-name\">{formatDayName(day)}</span>\r\n                                                <span className=\"day-num\">{formatDay(day)}</span>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            ))\r\n                        ) : (\r\n                            // Quarter/Year view: show months only\r\n                            months.map((monthDays, monthIdx) => (\r\n                                <div key={monthIdx} className=\"gantt-month\" style={{ flex: monthDays.length }}>\r\n                                    <div className=\"gantt-month-label\">\r\n                                        {formatMonthYear(monthDays[0])}\r\n                                    </div>\r\n                                    <div className=\"gantt-month-days-count\">\r\n                                        {monthDays.length} days\r\n                                    </div>\r\n                                </div>\r\n                            ))\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Tasks */}\r\n                <div className=\"gantt-body\">\r\n                    {visibleTasks.map(task => {\r\n                        const bar = getTaskBar(task);\r\n                        return (\r\n                            <div key={task.id} className=\"gantt-row\" onClick={() => onTaskClick(task)}>\r\n                                <div className=\"gantt-task-info\">\r\n                                    <span\r\n                                        className=\"gantt-priority-dot\"\r\n                                        style={{ background: PRIORITY_COLORS[task.priority] }}\r\n                                    />\r\n                                    <span className=\"gantt-task-title\">{task.title}</span>\r\n                                    <span className=\"gantt-task-status\" style={{ color: STATUS_COLORS[task.status] }}>\r\n                                        {(task.status || 'todo').replace('-', ' ')}\r\n                                    </span>\r\n                                </div>\r\n                                <div className=\"gantt-timeline\">\r\n                                    {renderGridCells()}\r\n                                    {bar && (\r\n                                        <div\r\n                                            className={`gantt-bar ${task.status} ${bar.overflowLeft ? 'overflow-left' : ''} ${bar.overflowRight ? 'overflow-right' : ''}`}\r\n                                            style={{\r\n                                                left: bar.left,\r\n                                                width: bar.width,\r\n                                                background: STATUS_COLORS[task.status]\r\n                                            }}\r\n                                        >\r\n                                            <span className=\"gantt-bar-label\">{task.title}</span>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n\r\n                    {/* Tasks outside visible range */}\r\n                    {tasksWithDatesButNotVisible.length > 0 && (\r\n                        <>\r\n                            <div className=\"gantt-section-divider\">Outside View Range</div>\r\n                            {tasksWithDatesButNotVisible.map(task => (\r\n                                <div key={task.id} className=\"gantt-row out-of-range\" onClick={() => onTaskClick(task)}>\r\n                                    <div className=\"gantt-task-info\">\r\n                                        <span\r\n                                            className=\"gantt-priority-dot\"\r\n                                            style={{ background: PRIORITY_COLORS[task.priority] }}\r\n                                        />\r\n                                        <span className=\"gantt-task-title\">{task.title}</span>\r\n                                        <span className=\"gantt-task-status\" style={{ color: STATUS_COLORS[task.status] }}>\r\n                                            {(task.status || 'todo').replace('-', ' ')}\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className=\"gantt-timeline empty\">\r\n                                        <span className=\"no-date-label\">\r\n                                            {getTaskStartDate(task)?.toLocaleDateString()} - {getTaskEndDate(task)?.toLocaleDateString()}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </>\r\n                    )}\r\n\r\n                    {/* Tasks without dates */}\r\n                    {tasksWithoutDates.length > 0 && (\r\n                        <>\r\n                            <div className=\"gantt-section-divider\">No Dates Set</div>\r\n                            {tasksWithoutDates.map(task => (\r\n                                <div key={task.id} className=\"gantt-row no-date\" onClick={() => onTaskClick(task)}>\r\n                                    <div className=\"gantt-task-info\">\r\n                                        <span\r\n                                            className=\"gantt-priority-dot\"\r\n                                            style={{ background: PRIORITY_COLORS[task.priority] }}\r\n                                        />\r\n                                        <span className=\"gantt-task-title\">{task.title}</span>\r\n                                        <span className=\"gantt-task-status\" style={{ color: STATUS_COLORS[task.status] }}>\r\n                                            {(task.status || 'todo').replace('-', ' ')}\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className=\"gantt-timeline empty\">\r\n                                        <span className=\"no-date-label\">Set start/end dates to show on timeline</span>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </>\r\n                    )}\r\n\r\n                    {project.tasks.length === 0 && (\r\n                        <div className=\"gantt-empty\">\r\n                            <Calendar size={48} />\r\n                            <p>No tasks yet. Add tasks to see them on the timeline.</p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\KanbanBoard.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  72 |             // If task exists and has changed, update local state\n  73 |             if (updatedTask && JSON.stringify(updatedTask) !== JSON.stringify(selectedTask)) {\n> 74 |                 setSelectedTask(updatedTask);\n     |                 ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  75 |             }\n  76 |         }\n  77 |     }, [project.tasks, selectedTask]);","line":74,"column":17,"nodeType":null,"endLine":74,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useMemo } from 'react';\r\nimport { Settings, LayoutGrid, Table, GanttChart, FileText, Calendar, Activity } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { KanbanColumn } from './KanbanColumn';\r\nimport { TaskTableView } from './TaskTableView';\r\nimport { GanttView } from './GanttView';\r\nimport { CalendarView } from './CalendarView';\r\nimport { StatusReportPage } from '../StatusReport/StatusReportPage';\r\nimport { Modal } from '../UI/Modal';\r\nimport { AddTaskForm } from './AddTaskForm';\r\nimport { EditProjectForm } from './EditProjectForm';\r\nimport { TaskDetailPanel } from './TaskDetailPanel';\r\nimport { ProjectActivityFeed } from './ProjectActivityFeed';\r\nimport './Kanban.css';\r\n\r\nconst COLUMNS = [\r\n    { id: 'todo', title: 'To Do', color: 'var(--text-secondary)' },\r\n    { id: 'in-progress', title: 'In Progress', color: '#3b82f6' },\r\n    { id: 'review', title: 'Review', color: '#8b5cf6' },\r\n    { id: 'done', title: 'Done', color: '#10b981' }\r\n];\r\n\r\nconst PRIORITY_ORDER = { high: 0, medium: 1, low: 2 };\r\n\r\nimport { useAuth } from '../../hooks/useAuth';\r\n\r\nexport function KanbanBoard({ project, onBack, goalTitle }) {\r\n    const { moveTask: _moveTask } = useData();\r\n    const { canEdit } = useAuth();\r\n    const [showAddModal, setShowAddModal] = useState(false);\r\n    const [showEditModal, setShowEditModal] = useState(false);\r\n    const [selectedTask, setSelectedTask] = useState(null);\r\n    const [viewMode, setViewMode] = useState('table'); // 'table', 'gantt', 'kanban', 'reports'\r\n\r\n    const sortTasks = useCallback((tasks) => {\r\n        return [...tasks].sort((a, b) => {\r\n            const priorityDiff = (PRIORITY_ORDER[a.priority] || 2) - (PRIORITY_ORDER[b.priority] || 2);\r\n            if (priorityDiff !== 0) return priorityDiff;\r\n            // Use endDate, fallback to dueDate for legacy support\r\n            const aEnd = a.endDate || a.dueDate;\r\n            const bEnd = b.endDate || b.dueDate;\r\n            if (aEnd && bEnd) return new Date(aEnd) - new Date(bEnd);\r\n            if (aEnd) return -1;\r\n            if (bEnd) return 1;\r\n            return 0;\r\n        });\r\n    }, []);\r\n\r\n    const tasksByStatus = useMemo(() => {\r\n        return COLUMNS.reduce((acc, col) => {\r\n            const columnTasks = (project.tasks || []).filter(t => t.status === col.id);\r\n            acc[col.id] = sortTasks(columnTasks);\r\n            return acc;\r\n        }, {});\r\n    }, [project.tasks, sortTasks]);\r\n\r\n    const handleEditClose = useCallback((wasDeleted) => {\r\n        setShowEditModal(false);\r\n        if (wasDeleted) {\r\n            onBack();\r\n        }\r\n    }, [onBack]);\r\n\r\n    const handleTaskClick = useCallback((task) => {\r\n        setSelectedTask(task);\r\n    }, []);\r\n\r\n    // Keep selectedTask in sync with project updates (e.g. after editing)\r\n    useEffect(() => {\r\n        if (selectedTask) {\r\n            const updatedTask = project.tasks.find(t => t.id === selectedTask.id);\r\n            // If task exists and has changed, update local state\r\n            if (updatedTask && JSON.stringify(updatedTask) !== JSON.stringify(selectedTask)) {\r\n                setSelectedTask(updatedTask);\r\n            }\r\n        }\r\n    }, [project.tasks, selectedTask]);\r\n\r\n    return (\r\n        <div className=\"kanban-board-container\">\r\n            <div className=\"board-header\">\r\n                <button onClick={onBack} className=\"back-btn\">← Projects</button>\r\n                <div className=\"board-title\">\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>\r\n                        <h2>{project.title}</h2>\r\n                        {canEdit && (\r\n                            <button\r\n                                onClick={() => setShowEditModal(true)}\r\n                                className=\"icon-btn\"\r\n                                title=\"Edit Project\"\r\n                            >\r\n                                <Settings size={18} />\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                    <div className=\"board-meta\">\r\n                        <span className=\"meta-item\">🎯 {goalTitle || 'Unlinked'}</span>\r\n                        <span className=\"meta-divider\">•</span>\r\n                        <span className=\"meta-item\">{project.completion}% Complete</span>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"board-actions\">\r\n                    {/* View Toggle */}\r\n                    <div className=\"view-toggle\">\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'table' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('table')}\r\n                            title=\"Table View\"\r\n                        >\r\n                            <Table size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'calendar' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('calendar')}\r\n                            title=\"Calendar View\"\r\n                        >\r\n                            <Calendar size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'gantt' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('gantt')}\r\n                            title=\"Gantt View\"\r\n                        >\r\n                            <GanttChart size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'kanban' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('kanban')}\r\n                            title=\"Kanban View\"\r\n                        >\r\n                            <LayoutGrid size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'reports' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('reports')}\r\n                            title=\"Status Reports\"\r\n                        >\r\n                            <FileText size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'activity' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('activity')}\r\n                            title=\"Activity History\"\r\n                        >\r\n                            <Activity size={18} />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {viewMode !== 'reports' && viewMode !== 'activity' && canEdit && (\r\n                        <button className=\"btn-primary\" onClick={() => setShowAddModal(true)}>New Task</button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {viewMode === 'kanban' && (\r\n                <div className=\"kanban-columns\">\r\n                    {COLUMNS.map(col => (\r\n                        <KanbanColumn\r\n                            key={col.id}\r\n                            column={col}\r\n                            tasks={tasksByStatus[col.id] || []}\r\n                            projectId={project.id}\r\n                            onTaskClick={handleTaskClick}\r\n                        />\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {viewMode === 'table' && (\r\n                <TaskTableView\r\n                    project={project}\r\n                    onTaskClick={handleTaskClick}\r\n                />\r\n            )}\r\n\r\n            {viewMode === 'calendar' && (\r\n                <CalendarView\r\n                    project={project}\r\n                    onTaskClick={handleTaskClick}\r\n                />\r\n            )}\r\n\r\n            {viewMode === 'gantt' && (\r\n                <GanttView\r\n                    project={project}\r\n                    onTaskClick={handleTaskClick}\r\n                />\r\n            )}\r\n\r\n            {viewMode === 'reports' && (\r\n                <StatusReportPage\r\n                    project={project}\r\n                    onClose={() => setViewMode('kanban')}\r\n                />\r\n            )}\r\n\r\n            {viewMode === 'activity' && (\r\n                <ProjectActivityFeed projectId={project.id} />\r\n            )}\r\n\r\n            <Modal\r\n                isOpen={showAddModal}\r\n                onClose={() => setShowAddModal(false)}\r\n                title={`Add Task to ${project.title}`}\r\n                closeOnOverlayClick={false}\r\n            >\r\n                <AddTaskForm onClose={() => setShowAddModal(false)} projectId={project.id} />\r\n            </Modal>\r\n\r\n            <Modal\r\n                isOpen={showEditModal}\r\n                onClose={handleEditClose}\r\n                title=\"Edit Project\"\r\n                size=\"large\"\r\n                closeOnOverlayClick={false}\r\n            >\r\n                <EditProjectForm project={project} onClose={handleEditClose} />\r\n            </Modal>\r\n\r\n            {selectedTask && (\r\n                <TaskDetailPanel\r\n                    task={selectedTask}\r\n                    projectId={project.id}\r\n                    onClose={() => setSelectedTask(null)}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\KanbanCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\KanbanColumn.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\KanbanView.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'hasActiveFilters'. Either include it or remove the dependency array.","line":104,"column":8,"nodeType":"ArrayExpression","endLine":104,"endColumn":83,"suggestions":[{"desc":"Update the dependencies array to be: [goalFilter, selectedTags, searchTerm, goals, authFetch, buildFilterParams, hasActiveFilters]","fix":{"range":[4310,4385],"text":"[goalFilter, selectedTags, searchTerm, goals, authFetch, buildFilterParams, hasActiveFilters]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { KanbanBoard } from './KanbanBoard';\r\nimport { Plus, Folder, Target, Search, X } from 'lucide-react';\r\nimport { Modal } from '../UI/Modal';\r\nimport { AddProjectForm } from './AddProjectForm';\r\nimport { getDescendantGoalIds } from '../UI/CascadingGoalFilter';\r\nimport { FilterBar } from '../UI/FilterBar';\r\nimport { ProjectTagBadges } from '../UI/ProjectTagSelector';\r\nimport './KanbanView.css';\r\n\r\nimport { useAuth } from '../../hooks/useAuth';\r\n\r\nimport { API_BASE } from '../../apiClient';\r\n\r\nexport default function KanbanView({ initialGoalFilter, onClearFilter }) {\r\n    const { projects, goals, loadProjectDetails, loading, loadMoreProjects, projectsPagination, loadingMore, authFetch } = useData();\r\n    const { canEdit } = useAuth();\r\n\r\n    // Persist selected project to survive remounts/refresh\r\n    const [selectedProjectId, setSelectedProjectIdState] = useState(() => {\r\n        const saved = localStorage.getItem('dha_selected_project_id');\r\n        return saved || null;\r\n    });\r\n\r\n    const setSelectedProjectId = (id) => {\r\n        if (id) {\r\n            localStorage.setItem('dha_selected_project_id', id);\r\n        } else {\r\n            localStorage.removeItem('dha_selected_project_id');\r\n        }\r\n        setSelectedProjectIdState(id);\r\n    };\r\n\r\n    const [showProjectModal, setShowProjectModal] = useState(false);\r\n    const [goalFilter, setGoalFilter] = useState(initialGoalFilter || '');\r\n    const [selectedTags, setSelectedTags] = useState([]);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [isLoadingDetails, setIsLoadingDetails] = useState(false);\r\n\r\n    // Server-side filtered projects state\r\n    const [filteredServerProjects, setFilteredServerProjects] = useState(null);\r\n    const [filteredPagination, setFilteredPagination] = useState(null);\r\n    const [filterLoading, setFilterLoading] = useState(false);\r\n    const [filteredLoadingMore, setFilteredLoadingMore] = useState(false);\r\n\r\n    const hasActiveFilters = !!(goalFilter || selectedTags.length > 0 || searchTerm.trim());\r\n\r\n    // Sync with external filter changes\r\n    useEffect(() => {\r\n        if (initialGoalFilter) {\r\n            setGoalFilter(initialGoalFilter);\r\n        }\r\n    }, [initialGoalFilter]);\r\n\r\n    // Build filter query params (shared by initial fetch and load-more)\r\n    const buildFilterParams = useCallback((page = 1) => {\r\n        const params = new URLSearchParams({ page: String(page), limit: '100' });\r\n        if (goalFilter) {\r\n            const descendantIds = getDescendantGoalIds(goals, goalFilter);\r\n            const allGoalIds = [String(goalFilter), ...descendantIds.map(String)];\r\n            params.set('goalIds', allGoalIds.join(','));\r\n        }\r\n        if (selectedTags.length > 0) {\r\n            params.set('tagIds', selectedTags.join(','));\r\n        }\r\n        if (searchTerm.trim()) {\r\n            params.set('search', searchTerm.trim());\r\n        }\r\n        return params;\r\n    }, [goalFilter, selectedTags, searchTerm, goals]);\r\n\r\n    // Fetch filtered projects from server when filters change\r\n    useEffect(() => {\r\n        if (!hasActiveFilters) {\r\n            setFilteredServerProjects(null);\r\n            setFilteredPagination(null);\r\n            return;\r\n        }\r\n\r\n        let cancelled = false;\r\n        async function fetchFiltered() {\r\n            setFilterLoading(true);\r\n            try {\r\n                const params = buildFilterParams(1);\r\n                const res = await authFetch(`${API_BASE}/projects?${params.toString()}`);\r\n                if (!res.ok) throw new Error('Failed to fetch filtered projects');\r\n                const data = await res.json();\r\n\r\n                if (!cancelled) {\r\n                    setFilteredServerProjects(data.projects || []);\r\n                    setFilteredPagination(data.pagination || null);\r\n                }\r\n            } catch (err) {\r\n                console.error('Error fetching filtered projects:', err);\r\n                if (!cancelled) setFilteredServerProjects([]);\r\n            } finally {\r\n                if (!cancelled) setFilterLoading(false);\r\n            }\r\n        }\r\n\r\n        fetchFiltered();\r\n        return () => { cancelled = true; };\r\n    }, [goalFilter, selectedTags, searchTerm, goals, authFetch, buildFilterParams]);\r\n\r\n    // Load more filtered projects\r\n    const loadMoreFilteredProjects = useCallback(async () => {\r\n        if (!filteredPagination?.hasMore || filteredLoadingMore) return;\r\n        setFilteredLoadingMore(true);\r\n        try {\r\n            const nextPage = filteredPagination.page + 1;\r\n            const params = buildFilterParams(nextPage);\r\n            const res = await authFetch(`${API_BASE}/projects?${params.toString()}`);\r\n            if (!res.ok) throw new Error('Failed to load more filtered projects');\r\n            const data = await res.json();\r\n            setFilteredServerProjects(prev => [...(prev || []), ...(data.projects || [])]);\r\n            setFilteredPagination(data.pagination || null);\r\n        } catch (err) {\r\n            console.error('Error loading more filtered projects:', err);\r\n        } finally {\r\n            setFilteredLoadingMore(false);\r\n        }\r\n    }, [filteredPagination, filteredLoadingMore, buildFilterParams, authFetch]);\r\n\r\n    // Load full details when a project is selected\r\n    useEffect(() => {\r\n        if (selectedProjectId) {\r\n            const project = projects.find(p => p.id == selectedProjectId);\r\n            if (project && !project._detailsLoaded) {\r\n                setIsLoadingDetails(true);\r\n                loadProjectDetails(selectedProjectId).finally(() => {\r\n                    setIsLoadingDetails(false);\r\n                });\r\n            }\r\n        }\r\n    }, [selectedProjectId, projects, loadProjectDetails]);\r\n\r\n    const selectedProject = projects.find(p => p.id == selectedProjectId);\r\n\r\n    // Use server-filtered projects when filters are active, otherwise global paginated projects\r\n    const displayProjects = hasActiveFilters ? (filteredServerProjects || []) : projects;\r\n\r\n    // Get goal title by ID\r\n    const getGoalTitle = (goalId) => {\r\n        const goal = goals.find(g => g.id === goalId);\r\n        return goal ? goal.title : 'Unlinked';\r\n    };\r\n\r\n    const handleFilterChange = (newGoalId) => {\r\n        setGoalFilter(newGoalId);\r\n        if (!newGoalId && onClearFilter) onClearFilter();\r\n    };\r\n\r\n    // Show loading state if we have a selected ID but no project found yet (likely initial load)\r\n    if (selectedProjectId && !selectedProject) {\r\n        if (loading) {\r\n            return (\r\n                <div className=\"flex justify-center items-center h-full\">\r\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600\"></div>\r\n                    <span className=\"ml-2 text-gray-500\">Restoring project...</span>\r\n                </div>\r\n            );\r\n        }\r\n    }\r\n\r\n    if (selectedProject) {\r\n        if (isLoadingDetails) {\r\n            return (\r\n                <div className=\"flex justify-center items-center h-64\">\r\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600\"></div>\r\n                    <span className=\"ml-2 text-gray-500\">Loading project details...</span>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        return (\r\n            <KanbanBoard\r\n                project={selectedProject}\r\n                onBack={() => setSelectedProjectId(null)}\r\n                goalTitle={getGoalTitle(selectedProject.goalId)}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"kanban-view\">\r\n            <div className=\"view-header\">\r\n                <div>\r\n                    <h2>Projects</h2>\r\n                    <p className=\"view-subtitle\">Manage tasks across your initiatives.</p>\r\n                </div>\r\n                <div className=\"header-actions\">\r\n                    <div className=\"search-bar\">\r\n                        <Search size={18} />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"Search projects...\"\r\n                            value={searchTerm}\r\n                            onChange={e => setSearchTerm(e.target.value)}\r\n                        />\r\n                    </div>\r\n                    {canEdit && (\r\n                        <button className=\"btn-primary\" onClick={() => setShowProjectModal(true)}>\r\n                            <Plus size={18} />\r\n                            New Project\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Filters */}\r\n            <FilterBar\r\n                goalFilter={goalFilter}\r\n                onGoalFilterChange={handleFilterChange}\r\n                selectedTags={selectedTags}\r\n                onTagsChange={setSelectedTags}\r\n                countLabel={hasActiveFilters\r\n                    ? `${displayProjects.length} of ${filteredPagination?.total || displayProjects.length} project(s)`\r\n                    : `${displayProjects.length} project(s)`\r\n                }\r\n            >\r\n                {searchTerm && (\r\n                    <button className=\"btn-secondary btn-sm shared-clear-btn\" onClick={() => setSearchTerm('')}>\r\n                        <X size={14} /> Clear Search\r\n                    </button>\r\n                )}\r\n            </FilterBar>\r\n\r\n            {filterLoading && (\r\n                <div className=\"filter-loading-indicator\" style={{ textAlign: 'center', padding: '1rem', color: 'var(--text-secondary)' }}>\r\n                    Loading filtered projects...\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"projects-grid\">\r\n                {displayProjects.length === 0 && !filterLoading ? (\r\n                    <div className=\"empty-state glass\">\r\n                        <p>No projects found{goalFilter ? ' for this goal' : ''}.</p>\r\n                    </div>\r\n                ) : (\r\n                    displayProjects.map(project => (\r\n                        <div\r\n                            key={project.id}\r\n                            className=\"project-card\"\r\n                            onClick={() => setSelectedProjectId(project.id)}\r\n                        >\r\n                            <div className=\"project-card-header\">\r\n                                <div className=\"project-icon\">\r\n                                    <Folder size={22} />\r\n                                </div>\r\n                                <span className=\"project-task-count\">\r\n                                    {project.taskCount || project.tasks?.length || 0} Tasks\r\n                                </span>\r\n                            </div>\r\n\r\n                            <h3 className=\"project-title\">{project.title}</h3>\r\n                            <p className=\"project-description\">{project.description || 'No description'}</p>\r\n\r\n                            {project.tags && project.tags.length > 0 && (\r\n                                <ProjectTagBadges tags={project.tags} maxDisplay={3} />\r\n                            )}\r\n\r\n                            <div className=\"project-goal-link\">\r\n                                <Target size={14} />\r\n                                <span>{getGoalTitle(project.goalId)}</span>\r\n                            </div>\r\n\r\n                            <div className=\"project-progress\">\r\n                                <div className=\"progress-bar-track\">\r\n                                    <div\r\n                                        className=\"progress-bar-fill\"\r\n                                        style={{ width: `${project.completion || 0}%` }}\r\n                                    ></div>\r\n                                </div>\r\n                                <span className=\"progress-label\">{project.completion || 0}% Complete</span>\r\n                            </div>\r\n                        </div>\r\n                    ))\r\n                )}\r\n            </div>\r\n\r\n            {/* Pagination Controls */}\r\n            <div className=\"pagination-controls-wrapper\">\r\n                <div className=\"pagination-info\">\r\n                    Showing {displayProjects.length} of {hasActiveFilters ? (filteredPagination?.total || displayProjects.length) : (projectsPagination?.total || 0)} projects\r\n                </div>\r\n\r\n                {hasActiveFilters ? (\r\n                    filteredPagination?.hasMore && (\r\n                        <button\r\n                            className=\"btn-secondary load-more-btn\"\r\n                            onClick={loadMoreFilteredProjects}\r\n                            disabled={filteredLoadingMore}\r\n                        >\r\n                            {filteredLoadingMore ? (\r\n                                <span className=\"flex items-center\">\r\n                                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2\"></div>\r\n                                    Loading...\r\n                                </span>\r\n                            ) : (\r\n                                'Load More Projects'\r\n                            )}\r\n                        </button>\r\n                    )\r\n                ) : (\r\n                    projectsPagination?.hasMore && (\r\n                        <button\r\n                            className=\"btn-secondary load-more-btn\"\r\n                            onClick={loadMoreProjects}\r\n                            disabled={loadingMore}\r\n                        >\r\n                            {loadingMore ? (\r\n                                <span className=\"flex items-center\">\r\n                                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2\"></div>\r\n                                    Loading...\r\n                                </span>\r\n                            ) : (\r\n                                'Load More Projects'\r\n                            )}\r\n                        </button>\r\n                    )\r\n                )}\r\n            </div>\r\n\r\n            <Modal\r\n                isOpen={showProjectModal}\r\n                onClose={() => setShowProjectModal(false)}\r\n                title=\"Create New Project\"\r\n            >\r\n                <AddProjectForm onClose={() => setShowProjectModal(false)} />\r\n            </Modal>\r\n        </div>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\ProjectActivityFeed.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\TaskDetailPanel.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  44 |     // Sync state with task props when they change\n  45 |     useEffect(() => {\n> 46 |         setTitle(task.title);\n     |         ^^^^^^^^ Avoid calling setState() directly within an effect\n  47 |         setDescription(task.description || '');\n  48 |         setPriority(task.priority);\n  49 |         setStatus(task.status || 'todo');","line":46,"column":9,"nodeType":null,"endLine":46,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { X, Calendar, Flag, Clock, Edit, Trash2, AlignLeft, CheckCircle2 } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { useToast } from '../../context/ToastContext';\r\nimport './TaskDetail.css';\r\n\r\nimport { useAuth } from '../../hooks/useAuth';\r\n\r\nexport function TaskDetailPanel({ task, projectId, onClose }) {\r\n    const { updateTask, deleteTask } = useData();\r\n    const { success } = useToast();\r\n    const { canEdit, canDelete } = useAuth();\r\n    const [isEditing, setIsEditing] = useState(false);\r\n\r\n    // Helper to format date for input (YYYY-MM-DD)\r\n    // - Preserves YYYY-MM-DD strings as-is\r\n    // - Converts ISO strings using UTC components to avoid timezone shift\r\n    const formatDateForInput = (dateStr) => {\r\n        if (!dateStr) return '';\r\n        try {\r\n            if (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr)) {\r\n                return dateStr;\r\n            }\r\n\r\n            const date = new Date(dateStr);\r\n            // Use UTC methods to ensure we get the date as stored on server\r\n            const year = date.getUTCFullYear();\r\n            const month = String(date.getUTCMonth() + 1).padStart(2, '0');\r\n            const day = String(date.getUTCDate()).padStart(2, '0');\r\n            return `${year}-${month}-${day}`;\r\n        } catch (_e) {\r\n            return '';\r\n        }\r\n    };\r\n\r\n    const [title, setTitle] = useState(task.title);\r\n    const [description, setDescription] = useState(task.description || '');\r\n    const [priority, setPriority] = useState(task.priority);\r\n    const [status, setStatus] = useState(task.status || 'todo');\r\n    const [startDate, setStartDate] = useState(formatDateForInput(task.startDate || task.dueDate));\r\n    const [endDate, setEndDate] = useState(formatDateForInput(task.endDate || task.dueDate));\r\n    const [confirmDelete, setConfirmDelete] = useState(false);\r\n\r\n    // Sync state with task props when they change\r\n    useEffect(() => {\r\n        setTitle(task.title);\r\n        setDescription(task.description || '');\r\n        setPriority(task.priority);\r\n        setStatus(task.status || 'todo');\r\n        setStartDate(formatDateForInput(task.startDate || task.dueDate));\r\n        setEndDate(formatDateForInput(task.endDate || task.dueDate));\r\n    }, [task]);\r\n\r\n    const handleSave = async () => {\r\n        await updateTask(projectId, task.id, {\r\n            title,\r\n            description,\r\n            priority,\r\n            status,\r\n            startDate: startDate || null,\r\n            endDate: endDate || null\r\n        });\r\n        success('Task updated successfully');\r\n        setIsEditing(false);\r\n    };\r\n\r\n    const handleDelete = () => {\r\n        if (confirmDelete) {\r\n            deleteTask(projectId, task.id);\r\n            success('Task deleted');\r\n            onClose();\r\n        } else {\r\n            setConfirmDelete(true);\r\n        }\r\n    };\r\n\r\n    // Helper to format date for display without UTC shift\r\n    const formatDateForDisplay = (dateStr) => {\r\n        if (!dateStr) return 'Not set';\r\n        try {\r\n            // If strictly YYYY-MM-DD\r\n            if (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr)) {\r\n                const [year, month, day] = dateStr.split('-').map(Number);\r\n                // Create local date at midnight\r\n                const date = new Date(year, month - 1, day);\r\n                return date.toLocaleDateString();\r\n            }\r\n            // For ISO strings, use UTC timezone to prevent shift\r\n            return new Date(dateStr).toLocaleDateString(undefined, { timeZone: 'UTC' });\r\n        } catch (_e) {\r\n            return dateStr;\r\n        }\r\n    };\r\n\r\n\r\n    const priorityColors = {\r\n        high: '#ef4444',\r\n        medium: '#f59e0b',\r\n        low: '#10b981'\r\n    };\r\n\r\n    const statusColors = {\r\n        'todo': '#64748b',\r\n        'in-progress': '#3b82f6',\r\n        'review': '#8b5cf6',\r\n        'done': '#22c55e'\r\n    };\r\n\r\n    const statusLabels = {\r\n        'todo': 'To Do',\r\n        'in-progress': 'In Progress',\r\n        'review': 'Review',\r\n        'done': 'Done'\r\n    };\r\n\r\n    // Get display dates (support legacy dueDate field)\r\n    const displayStartDate = task.startDate || task.dueDate;\r\n    const displayEndDate = task.endDate || task.dueDate;\r\n    const currentStatus = task.status || 'todo';\r\n\r\n    return (\r\n        <div className=\"task-detail-overlay\" onClick={onClose}>\r\n            <div className=\"task-detail-panel\" onClick={e => e.stopPropagation()}>\r\n                <div className=\"panel-header\">\r\n                    <h3>{isEditing ? 'Edit Task' : 'Task Details'}</h3>\r\n                    <button className=\"close-btn\" onClick={onClose}>\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"panel-content\">\r\n                    {isEditing ? (\r\n                        <>\r\n                            <div className=\"form-group\">\r\n                                <label>Title</label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={title}\r\n                                    onChange={e => setTitle(e.target.value)}\r\n                                    className=\"form-input\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label>Description</label>\r\n                                <textarea\r\n                                    value={description}\r\n                                    onChange={e => setDescription(e.target.value)}\r\n                                    className=\"form-textarea\"\r\n                                    rows={3}\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-row\">\r\n                                <div className=\"form-group\">\r\n                                    <label>Status</label>\r\n                                    <select value={status} onChange={e => setStatus(e.target.value)} className=\"form-select\">\r\n                                        <option value=\"todo\">To Do</option>\r\n                                        <option value=\"in-progress\">In Progress</option>\r\n                                        <option value=\"review\">Review</option>\r\n                                        <option value=\"done\">Done</option>\r\n                                    </select>\r\n                                </div>\r\n                                <div className=\"form-group\">\r\n                                    <label>Priority</label>\r\n                                    <select value={priority} onChange={e => setPriority(e.target.value)} className=\"form-select\">\r\n                                        <option value=\"low\">Low</option>\r\n                                        <option value=\"medium\">Medium</option>\r\n                                        <option value=\"high\">High</option>\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"form-row\">\r\n                                <div className=\"form-group\">\r\n                                    <label>Start Date</label>\r\n                                    <input\r\n                                        type=\"date\"\r\n                                        value={startDate}\r\n                                        onChange={e => setStartDate(e.target.value)}\r\n                                        className=\"form-input\"\r\n                                    />\r\n                                </div>\r\n                                <div className=\"form-group\">\r\n                                    <label>End Date</label>\r\n                                    <input\r\n                                        type=\"date\"\r\n                                        value={endDate}\r\n                                        onChange={e => setEndDate(e.target.value)}\r\n                                        className=\"form-input\"\r\n                                        min={startDate}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            <h2 className=\"task-title-display\">{task.title}</h2>\r\n\r\n                            <div className=\"meta-grid\">\r\n                                <div className=\"meta-item\">\r\n                                    <span className=\"meta-label\">Status</span>\r\n                                    <div className=\"meta-value\">\r\n                                        <span className=\"status-badge-lg\" style={{\r\n                                            backgroundColor: `${statusColors[currentStatus]}20`,\r\n                                            color: statusColors[currentStatus]\r\n                                        }}>\r\n                                            <CheckCircle2 size={14} />\r\n                                            {statusLabels[currentStatus]}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"meta-item\">\r\n                                    <span className=\"meta-label\">Priority</span>\r\n                                    <div className=\"meta-value\">\r\n                                        <Flag size={16} style={{ color: priorityColors[task.priority] }} />\r\n                                        <span style={{ color: priorityColors[task.priority], textTransform: 'capitalize' }}>\r\n                                            {task.priority}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"meta-item\">\r\n                                    <span className=\"meta-label\">Start Date</span>\r\n                                    <div className=\"meta-value\">\r\n                                        <Calendar size={16} className=\"text-muted\" />\r\n                                        {formatDateForDisplay(displayStartDate)}\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"meta-item\">\r\n                                    <span className=\"meta-label\">Due Date</span>\r\n                                    <div className=\"meta-value\">\r\n                                        <Calendar size={16} className=\"text-muted\" />\r\n                                        {formatDateForDisplay(displayEndDate)}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"section-label\">\r\n                                <AlignLeft size={16} />\r\n                                Description\r\n                            </div>\r\n                            <div className=\"task-description-display\">\r\n                                {task.description || 'No description provided for this task.'}\r\n                            </div>\r\n                        </>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"panel-actions\">\r\n                    {isEditing ? (\r\n                        <>\r\n                            <button className=\"btn-secondary\" onClick={() => setIsEditing(false)}>Cancel</button>\r\n                            <button className=\"btn-primary\" onClick={handleSave}>Save Changes</button>\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            {canDelete && (\r\n                                <button\r\n                                    className={`btn-danger ${confirmDelete ? 'confirm' : ''}`}\r\n                                    onClick={handleDelete}\r\n                                >\r\n                                    <Trash2 size={16} />\r\n                                    {confirmDelete ? 'Confirm Delete' : 'Delete'}\r\n                                </button>\r\n                            )}\r\n                            {canEdit && (\r\n                                <button className=\"btn-primary\" onClick={() => setIsEditing(true)}>\r\n                                    <Edit size={16} />\r\n                                    Edit\r\n                                </button>\r\n                            )}\r\n                        </>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\TaskTableView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Layout\\Layout.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  43 |     // Set initial sidebar state on mount\n  44 |     useEffect(() => {\n> 45 |         setIsSidebarOpen(window.innerWidth > 992);\n     |         ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  46 |     }, []);\n  47 |\n  48 |     const allNavItems = [","line":45,"column":9,"nodeType":null,"endLine":45,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { LayoutDashboard, Target, Folder, BarChart3, Menu, X, Inbox, FileText, Shield, TrendingUp } from 'lucide-react';\r\nimport { useState, useEffect } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { useAuth } from '../../hooks/useAuth';\r\nimport { ThemeToggle } from '../UI/ThemeToggle';\r\nimport './Layout.css';\r\n\r\n// ... UserProfile component ...\r\nfunction UserProfile() {\r\n    const { instance, account, userRoles } = useAuth();\r\n    const name = account?.name || 'User';\r\n    // Display the highest role for debugging/info\r\n    const roleDisplay = userRoles.length > 0 ? userRoles[0] : 'No Role';\r\n\r\n    const handleLogout = () => {\r\n        instance.logoutRedirect({\r\n            postLogoutRedirectUri: \"/\",\r\n            mainWindowRedirectUri: \"/\"\r\n        });\r\n    };\r\n\r\n    return (\r\n        <div className=\"user-profile\">\r\n            <div className=\"user-info\">\r\n                <span className=\"user-name\">{name}</span>\r\n                <span className=\"user-role\">{roleDisplay}</span>\r\n            </div>\r\n            <button onClick={handleLogout} className=\"sign-out-btn\">\r\n                Sign Out\r\n            </button>\r\n            <div className=\"user-avatar\">\r\n                {name.charAt(0)}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport function Layout({ children, currentView, onViewChange }) {\r\n    const [isSidebarOpen, setIsSidebarOpen] = useState(false);\r\n    const { isAppAdmin } = useAuth();\r\n    const { hasPermission } = useData();\r\n\r\n    // Set initial sidebar state on mount\r\n    useEffect(() => {\r\n        setIsSidebarOpen(window.innerWidth > 992);\r\n    }, []);\r\n\r\n    const allNavItems = [\r\n        { id: 'exec-dashboard', label: 'Executive Summary', icon: LayoutDashboard, permission: 'can_view_exec_dashboard' },\r\n        { id: 'dashboard', label: 'Dashboard', icon: BarChart3, permission: 'can_view_dashboard' },\r\n        { id: 'goals', label: 'Goals', icon: Target, permission: 'can_view_goals' },\r\n        { id: 'metrics', label: 'Metrics', icon: TrendingUp, permission: 'can_view_metrics' },\r\n        { id: 'projects', label: 'Projects', icon: Folder, permission: 'can_view_projects' },\r\n        { id: 'reports', label: 'Reports', icon: FileText, permission: 'can_view_reports' },\r\n        { id: 'intake', label: 'Intake', icon: Inbox, permission: 'can_view_intake' },\r\n    ];\r\n\r\n    const navItems = allNavItems.filter(item => {\r\n        if (!item.permission) return true;\r\n        return hasPermission(item.permission);\r\n    });\r\n\r\n    if (isAppAdmin) {\r\n        navItems.push({ id: 'admin', label: 'Admin Panel', icon: Shield });\r\n    }\r\n\r\n    const handleNavClick = (viewId) => {\r\n        onViewChange(viewId);\r\n        // Auto-close sidebar on mobile after clicking a link\r\n        if (window.innerWidth <= 992) {\r\n            setIsSidebarOpen(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"layout\">\r\n            {/* Sidebar Overlay for Mobile */}\r\n            {isSidebarOpen && window.innerWidth <= 992 && (\r\n                <div className=\"sidebar-overlay\" onClick={() => setIsSidebarOpen(false)}></div>\r\n            )}\r\n\r\n            {/* Sidebar */}\r\n            <aside className={`sidebar ${isSidebarOpen ? 'open' : 'closed'}`}>\r\n                <div className=\"sidebar-header\">\r\n                    <div className=\"logo\">\r\n                        <div className=\"logo-icon\">DHA</div>\r\n                        {/* Text removed as requested, keeping only logo icon */}\r\n                    </div>\r\n                    <button\r\n                        className=\"toggle-sidebar-btn\"\r\n                        onClick={() => setIsSidebarOpen(!isSidebarOpen)}\r\n                    >\r\n                        {isSidebarOpen ? <X size={20} /> : <Menu size={20} />}\r\n                    </button>\r\n                </div>\r\n\r\n                <nav className=\"nav-menu\">\r\n                    {navItems.map(item => (\r\n                        <button\r\n                            key={item.id}\r\n                            className={`nav-item ${currentView === item.id ? 'active' : ''}`}\r\n                            onClick={() => handleNavClick(item.id)}\r\n                        >\r\n                            <item.icon size={22} />\r\n                            {isSidebarOpen && <span>{item.label}</span>}\r\n                        </button>\r\n                    ))}\r\n                </nav>\r\n            </aside>\r\n\r\n\r\n            {/* Main Content */}\r\n            <main className=\"main-content\">\r\n                <header className=\"top-header\">\r\n                    {/* Mobile Menu Button */}\r\n                    <button\r\n                        className=\"mobile-menu-btn\"\r\n                        onClick={() => setIsSidebarOpen(!isSidebarOpen)}\r\n                        aria-label=\"Toggle Menu\"\r\n                    >\r\n                        <Menu size={24} />\r\n                    </button>\r\n\r\n                    <h2 className=\"page-title\">Digital Health Atlas</h2>\r\n\r\n                    <div className=\"header-actions\">\r\n\r\n                        <ThemeToggle />\r\n                        <UserProfile />\r\n                    </div>\r\n                </header>\r\n\r\n                <div className=\"content-scrollable\">\r\n                    {children}\r\n                </div>\r\n            </main>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Metrics\\MetricsPage.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  16 |     useEffect(() => {\n  17 |         if (initialGoalFilter) {\n> 18 |             setGoalFilter(initialGoalFilter);\n     |             ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  19 |         }\n  20 |     }, [initialGoalFilter]);\n  21 |","line":18,"column":13,"nodeType":null,"endLine":18,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { useState, useMemo, useEffect } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { getDescendantGoalIds } from '../UI/CascadingGoalFilter';\r\nimport { FilterBar } from '../UI/FilterBar';\r\nimport { TrendingUp, Target, BarChart2 } from 'lucide-react';\r\nimport { formatKpiValue } from '../../utils';\r\nimport './MetricsPage.css';\r\n\r\nexport function MetricsPage({ initialGoalFilter, onClearFilter }) {\r\n    const { goals, projects, hasPermission } = useData();\r\n    const [goalFilter, setGoalFilter] = useState(initialGoalFilter || '');\r\n    const [selectedTags, setSelectedTags] = useState([]);\r\n\r\n    // Sync with external filter changes\r\n    useEffect(() => {\r\n        if (initialGoalFilter) {\r\n            setGoalFilter(initialGoalFilter);\r\n        }\r\n    }, [initialGoalFilter]);\r\n\r\n    const handleFilterChange = (newGoalId) => {\r\n        setGoalFilter(newGoalId);\r\n        if (!newGoalId && onClearFilter) onClearFilter();\r\n    };\r\n\r\n    // Flatten all KPIs from goals into a single list with context\r\n    const allMetrics = useMemo(() => {\r\n        return goals.flatMap(goal => {\r\n            if (!goal.kpis) return [];\r\n            return goal.kpis.map(kpi => ({\r\n                ...kpi,\r\n                goalId: goal.id,\r\n                goalTitle: goal.title,\r\n                goalType: goal.type\r\n            }));\r\n        });\r\n    }, [goals]);\r\n\r\n    // Filter metrics based on cascading goal selection and tags\r\n    const filteredMetrics = useMemo(() => {\r\n        let metrics = allMetrics;\r\n\r\n        // Filter by goal\r\n        if (goalFilter) {\r\n            const descendantIds = getDescendantGoalIds(goals, goalFilter);\r\n            const relevantGoalIds = [String(goalFilter), ...descendantIds.map(String)];\r\n            metrics = metrics.filter(m => relevantGoalIds.includes(String(m.goalId)));\r\n        }\r\n\r\n        // Filter by tags: only show metrics from goals that have tagged projects\r\n        if (selectedTags.length > 0) {\r\n            // Find all goal IDs that have at least one project with a matching tag\r\n            const goalsWithTaggedProjects = new Set();\r\n            projects.forEach(p => {\r\n                if (p.tags && p.tags.some(t => selectedTags.includes(String(t.id)))) {\r\n                    if (p.goalId) goalsWithTaggedProjects.add(String(p.goalId));\r\n                }\r\n            });\r\n            // Also include ancestor goals so parent-level KPIs still show\r\n            const expandedGoalIds = new Set(goalsWithTaggedProjects);\r\n            goalsWithTaggedProjects.forEach(gId => {\r\n                let current = goals.find(g => String(g.id) === gId);\r\n                while (current && current.parentId) {\r\n                    expandedGoalIds.add(String(current.parentId));\r\n                    current = goals.find(g => String(g.id) === String(current.parentId));\r\n                }\r\n            });\r\n            metrics = metrics.filter(m => expandedGoalIds.has(String(m.goalId)));\r\n        }\r\n\r\n        return metrics;\r\n    }, [allMetrics, goalFilter, selectedTags, goals, projects]);\r\n\r\n    // Calculate progress helper\r\n    const calcProgress = (current, target) => {\r\n        if (!target) return 0;\r\n        return Math.min(100, Math.round((current / target) * 100));\r\n    };\r\n\r\n\r\n    if (!hasPermission('can_view_metrics')) {\r\n        return (\r\n            <div className=\"access-denied\">\r\n                <h2>Access Denied</h2>\r\n                <p>You do not have permission to view the Metrics Dashboard.</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"metrics-page\">\r\n            <div className=\"metrics-header\">\r\n                <div>\r\n                    <h1><BarChart2 size={24} style={{ display: 'inline', marginRight: '0.5rem' }} /> Metrics Dashboard</h1>\r\n                    <p className=\"subtitle\">Track Key Performance Indicators across the organization.</p>\r\n                </div>\r\n            </div>\r\n\r\n            <FilterBar\r\n                goalFilter={goalFilter}\r\n                onGoalFilterChange={handleFilterChange}\r\n                selectedTags={selectedTags}\r\n                onTagsChange={setSelectedTags}\r\n                countLabel={`${filteredMetrics.length} Metrics Found`}\r\n            />\r\n\r\n            {filteredMetrics.length === 0 ? (\r\n                <div className=\"empty-metrics\">\r\n                    <TrendingUp size={48} style={{ marginBottom: '1rem', opacity: 0.5 }} />\r\n                    <p>No metrics found matching your criteria.</p>\r\n                </div>\r\n            ) : (\r\n                <div className=\"metrics-grid\">\r\n                    {filteredMetrics.map(metric => {\r\n                        const progress = calcProgress(metric.current, metric.target);\r\n                        const isOnTrack = progress >= 50;\r\n                        const _goalId = String(metric.goalId); // ensure string\r\n\r\n                        return (\r\n                            <div key={metric.id} className=\"metric-card\">\r\n                                <div className=\"metric-card-header\">\r\n                                    <span className=\"metric-name\">{metric.name}</span>\r\n                                    <span className=\"metric-goal-badge\" title={`Goal: ${metric.goalTitle}`}>\r\n                                        {metric.goalTitle}\r\n                                    </span>\r\n                                </div>\r\n\r\n                                <div className=\"metric-values\">\r\n                                    <div className=\"metric-current-container\">\r\n                                        <span className=\"metric-current\">\r\n                                            {formatKpiValue(metric.current, metric.unit === '$' ? '$' : '')}\r\n                                        </span>\r\n                                        <span className=\"metric-separator\" style={{ margin: '0 0.5rem', color: 'var(--text-tertiary)' }}>/</span>\r\n                                        <span className=\"metric-target\">\r\n                                            {formatKpiValue(metric.target, metric.unit)}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"metric-progress\">\r\n                                    <div\r\n                                        className={`metric-progress-fill ${isOnTrack ? 'on-track' : 'behind'}`}\r\n                                        style={{ width: `${progress}%` }}\r\n                                    ></div>\r\n                                </div>\r\n\r\n                                <div className={`metric-status ${isOnTrack ? 'on-track' : 'behind'}`}>\r\n                                    {progress}%\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Reports\\ReportFilterTree.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has missing dependencies: 'buildTree' and 'hasProjects'. Either include them or remove the dependency array.","line":73,"column":8,"nodeType":"ArrayExpression","endLine":73,"endColumn":47,"suggestions":[{"desc":"Update the dependencies array to be: [buildTree, selectedTags.length, hasProjects]","fix":{"range":[2959,2998],"text":"[buildTree, selectedTags.length, hasProjects]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo } from 'react';\r\nimport { ChevronRight, ChevronDown, Folder, CheckSquare, Square, Tag, X } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { getDescendantGoalIds } from '../UI/CascadingGoalFilter';\r\nimport '../UI/ProjectTagSelector.css';\r\n\r\nexport function ReportFilterTree({ onSelectionChange, allProjects = [] }) {\r\n    const { goals, projects, tagGroups } = useData();\r\n    const [selectedIds, setSelectedIds] = useState(new Set());\r\n    const [expandedIds, setExpandedIds] = useState(new Set());\r\n    const [selectedTags, setSelectedTags] = useState([]);\r\n    const [showTagFilter, setShowTagFilter] = useState(false);\r\n\r\n    // Get only active tags grouped for the filter UI\r\n    const activeTags = useMemo(() => {\r\n        if (!tagGroups || tagGroups.length === 0) return [];\r\n        return tagGroups\r\n            .map(group => ({\r\n                ...group,\r\n                tags: (group.tags || []).filter(t => t.status?.toLowerCase() === 'active')\r\n            }))\r\n            .filter(group => group.tags.length > 0);\r\n    }, [tagGroups]);\r\n\r\n    const toggleTag = (tagId) => {\r\n        setSelectedTags(prev =>\r\n            prev.includes(tagId)\r\n                ? prev.filter(id => id !== tagId)\r\n                : [...prev, tagId]\r\n        );\r\n    };\r\n\r\n    // Filter projects by selected tags\r\n    const filteredProjects = useMemo(() => {\r\n        // Use allProjects if loaded, otherwise fallback to context projects\r\n        const source = allProjects.length > 0 ? allProjects : projects;\r\n\r\n        if (selectedTags.length === 0) return source;\r\n        return source.filter(p => {\r\n            if (!p.tags || p.tags.length === 0) return false;\r\n            const projectTagIds = p.tags.map(t => String(t.tagId));\r\n            return selectedTags.every(tagId => projectTagIds.includes(String(tagId)));\r\n        });\r\n    }, [projects, allProjects, selectedTags]);\r\n\r\n    // Build hierarchy tree using filtered projects\r\n    const buildTree = (parentId) => {\r\n        return goals\r\n            .filter(g => g.parentId === parentId)\r\n            .map(goal => ({\r\n                ...goal,\r\n                children: buildTree(goal.id),\r\n                projects: filteredProjects.filter(p => p.goalId === goal.id)\r\n            }));\r\n    };\r\n\r\n    // Helper: check if a tree node has any projects (direct or nested)\r\n    const hasProjects = (node) => {\r\n        if (node.projects.length > 0) return true;\r\n        return node.children.some(child => hasProjects(child));\r\n    };\r\n\r\n    const treeData = useMemo(() => {\r\n        const raw = buildTree(null);\r\n        // When tags are active, hide empty branches\r\n        if (selectedTags.length > 0) {\r\n            const prune = (nodes) => nodes\r\n                .filter(n => hasProjects(n))\r\n                .map(n => ({ ...n, children: prune(n.children) }));\r\n            return prune(raw);\r\n        }\r\n        return raw;\r\n    }, [goals, filteredProjects, selectedTags]);\r\n\r\n    // Toggle expansion\r\n    const toggleExpand = (id) => {\r\n        const newExpanded = new Set(expandedIds);\r\n        if (newExpanded.has(id)) newExpanded.delete(id);\r\n        else newExpanded.add(id);\r\n        setExpandedIds(newExpanded);\r\n    };\r\n\r\n    // Recursive selection\r\n    const toggleSelection = (item, isSelected) => {\r\n        const newSelected = new Set(selectedIds);\r\n\r\n        const toggleRecursive = (node, select) => {\r\n            const goalNodeId = `goal-${node.id}`;\r\n            if (select) {\r\n                newSelected.add(goalNodeId); // Goal ID\r\n                node.projects.forEach(p => newSelected.add(`project-${p.id}`)); // Project IDs\r\n            } else {\r\n                newSelected.delete(goalNodeId);\r\n                node.projects.forEach(p => newSelected.delete(`project-${p.id}`));\r\n            }\r\n            node.children.forEach(child => toggleRecursive(child, select));\r\n        };\r\n\r\n        toggleRecursive(item, isSelected);\r\n        setSelectedIds(newSelected);\r\n        onSelectionChange(Array.from(newSelected));\r\n    };\r\n\r\n    // Toggle individual project\r\n    const toggleProject = (projectId, isSelected) => {\r\n        const projectNodeId = `project-${projectId}`;\r\n        const newSelected = new Set(selectedIds);\r\n        if (isSelected) newSelected.add(projectNodeId);\r\n        else newSelected.delete(projectNodeId);\r\n        setSelectedIds(newSelected);\r\n        onSelectionChange(Array.from(newSelected));\r\n    };\r\n\r\n    const TreeNode = ({ node, level = 0 }) => {\r\n        const goalNodeId = `goal-${node.id}`;\r\n        const isExpanded = expandedIds.has(goalNodeId);\r\n        const isSelected = selectedIds.has(goalNodeId);\r\n\r\n        // Calculate available reports (Own + Descendants)\r\n        const descendantIds = getDescendantGoalIds(goals, node.id);\r\n        const allRelatedGoalIds = [node.id, ...descendantIds];\r\n        const linkedProjects = filteredProjects.filter(p => allRelatedGoalIds.includes(p.goalId));\r\n        const availableReports = linkedProjects.reduce((sum, p) => sum + (p.reportCount || 0), 0);\r\n\r\n        return (\r\n            <div className=\"tree-node\" style={{ marginLeft: `${level * 12}px` }}>\r\n                <div className=\"tree-item-content\">\r\n                    {node.children.length > 0 ? (\r\n                        <button\r\n                            className=\"btn-icon-sm\"\r\n                            onClick={(e) => { e.stopPropagation(); toggleExpand(goalNodeId); }}\r\n                            style={{ background: 'transparent', border: 'none', padding: 0, cursor: 'pointer' }}\r\n                        >\r\n                            {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}\r\n                        </button>\r\n                    ) : <span style={{ width: 14 }} />}\r\n\r\n                    <div\r\n                        onClick={() => toggleSelection(node, !isSelected)}\r\n                        style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}\r\n                    >\r\n                        {isSelected ? <CheckSquare size={16} className=\"text-primary\" /> : <Square size={16} />}\r\n                        <Folder size={16} className=\"text-secondary\" />\r\n                        <span className=\"tree-label\">{node.title}</span>\r\n                        {availableReports > 0 && (\r\n                            <span className=\"tree-count\" title={`${availableReports} projects with reports available in this hierarchy`}>\r\n                                {availableReports} Reports\r\n                            </span>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {isExpanded && (\r\n                    <div className=\"tree-children-nodes\">\r\n                        {/* Projects */}\r\n                        {node.projects.map(p => {\r\n                            const reportCount = p.reportCount || 0;\r\n                            return (\r\n                                <div key={p.id} className=\"tree-item-content\" style={{ marginLeft: '24px' }}>\r\n                                    <div\r\n                                        onClick={() => toggleProject(p.id, !selectedIds.has(`project-${p.id}`))}\r\n                                        style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}\r\n                                    >\r\n                                        {selectedIds.has(`project-${p.id}`) ? <CheckSquare size={16} className=\"text-primary\" /> : <Square size={16} />}\r\n                                        <span className=\"tree-label\" style={{ fontSize: '0.85rem' }}>{p.title}</span>\r\n                                        {reportCount > 0 && (\r\n                                            <span className=\"tree-count\" style={{ fontSize: '0.7em', background: '#ecfdf5', color: '#059669' }}>\r\n                                                {reportCount}\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })}\r\n                        {/* Sub-goals */}\r\n                        {node.children.map(child => (\r\n                            <TreeNode key={child.id} node={child} level={level + 1} />\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    return (\r\n        <div className=\"report-filter-tree\">\r\n            {/* Tag filter toggle */}\r\n            <div className=\"report-tag-filter-header\">\r\n                <button\r\n                    className={`btn-secondary btn-sm report-tag-toggle ${showTagFilter ? 'active' : ''} ${selectedTags.length > 0 ? 'has-selection' : ''}`}\r\n                    onClick={() => setShowTagFilter(!showTagFilter)}\r\n                >\r\n                    <Tag size={14} />\r\n                    Filter by Tags\r\n                    {selectedTags.length > 0 && <span className=\"report-tag-count\">{selectedTags.length}</span>}\r\n                </button>\r\n                {selectedTags.length > 0 && (\r\n                    <button\r\n                        className=\"btn-secondary btn-sm report-clear-tags\"\r\n                        onClick={() => setSelectedTags([])}\r\n                    >\r\n                        <X size={12} /> Clear\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            {showTagFilter && activeTags.length > 0 && (\r\n                <div className=\"report-tag-panel\">\r\n                    {activeTags.map(group => (\r\n                        <div key={group.id} className=\"report-tag-group\">\r\n                            <span className=\"report-tag-group-label\">{group.name}</span>\r\n                            <div className=\"report-tag-options\">\r\n                                {group.tags.map(tag => (\r\n                                    <button\r\n                                        key={tag.id}\r\n                                        className={`exec-tag-pill ${selectedTags.includes(String(tag.id)) ? 'selected' : ''}`}\r\n                                        onClick={() => toggleTag(String(tag.id))}\r\n                                        style={{ '--tag-color': tag.color || '#6366f1' }}\r\n                                    >\r\n                                        <span className=\"exec-tag-dot\" style={{ background: tag.color || '#6366f1' }}></span>\r\n                                        {tag.name}\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {treeData.map(node => (\r\n                <TreeNode key={node.id} node={node} />\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Reports\\ReportPreview.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'authFetch'. Either include it or remove the dependency array.","line":60,"column":8,"nodeType":"ArrayExpression","endLine":60,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [reportProjects, fullReports, authFetch]","fix":{"range":[2654,2683],"text":"[reportProjects, fullReports, authFetch]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useRef, useState, useEffect } from 'react';\r\nimport { Download, Printer, CheckSquare, Square } from 'lucide-react';\r\nimport html2pdf from 'html2pdf.js';\r\nimport { StatusReportView } from '../StatusReport/StatusReportView';\r\nimport { useData } from '../../context/DataContext';\r\n\r\nimport { API_BASE } from '../../apiClient';\r\n\r\nexport function ReportPreview({ selectedProjectIds, allProjects = [] }) {\r\n    const { projects, goals, getLatestStatusReport, authFetch } = useData();\r\n    const [includeAppendix, setIncludeAppendix] = useState(false);\r\n    const [fullReports, setFullReports] = useState({});\r\n    const [loadingFullReports, setLoadingFullReports] = useState(false);\r\n    const printRef = useRef(null);\r\n\r\n    // Use allProjects (full list with embedded reports) if available, fallback to context\r\n    const sourceProjects = allProjects.length > 0 ? allProjects : projects;\r\n\r\n    // Filter projects\r\n    const reportProjects = sourceProjects.filter(p => selectedProjectIds.includes(`project-${p.id}`));\r\n\r\n    // Fetch full reports for ALL selected projects to ensure we have milestones/details for the main view\r\n    useEffect(() => {\r\n        if (reportProjects.length === 0) return;\r\n\r\n        const fetchFullReports = async () => {\r\n            setLoadingFullReports(true);\r\n            const newReports = {};\r\n            try {\r\n                // Determine which reports we still need to fetch\r\n                const projectsToFetch = reportProjects.filter(p => !fullReports[p.id]);\r\n\r\n                if (projectsToFetch.length === 0) {\r\n                    setLoadingFullReports(false);\r\n                    return;\r\n                }\r\n\r\n                await Promise.all(\r\n                    projectsToFetch.map(async (project) => {\r\n                        try {\r\n                            const res = await authFetch(`${API_BASE}/projects/${project.id}/reports`);\r\n                            if (res.ok) {\r\n                                const reports = await res.json();\r\n                                if (reports.length > 0) {\r\n                                    newReports[project.id] = reports[0]; // Latest report\r\n                                }\r\n                            }\r\n                        } catch (err) {\r\n                            console.error(`Error fetching report for project ${project.id}:`, err);\r\n                        }\r\n                    })\r\n                );\r\n                setFullReports(prev => ({ ...prev, ...newReports }));\r\n            } finally {\r\n                setLoadingFullReports(false);\r\n            }\r\n        };\r\n\r\n        fetchFullReports();\r\n    }, [reportProjects, fullReports]); // dependency on reportProjects encompasses selectedProjectIds changes\r\n\r\n    // Helper: Find the Division level (second level in hierarchy, child of root organization) for a project\r\n    const getDivision = (goalId) => {\r\n        let current = goals.find(g => g.id === goalId);\r\n        if (!current) return null;\r\n\r\n        // Build the path from current goal up to root\r\n        const path = [current];\r\n        while (current && current.parentId) {\r\n            const parent = goals.find(g => g.id === current.parentId);\r\n            if (!parent) break;\r\n            path.unshift(parent);\r\n            current = parent;\r\n        }\r\n\r\n        // path[0] is Organization (root), path[1] is Division\r\n        // Return the Division level (index 1), or the project's direct goal if hierarchy is shallow\r\n        return path.length >= 2 ? path[1] : path[0];\r\n    };\r\n\r\n    // Group projects by Division (second level in hierarchy)\r\n    const groupedProjects = {};\r\n\r\n    reportProjects.forEach(p => {\r\n        const division = getDivision(p.goalId);\r\n        const groupName = division ? division.title : 'Uncategorized';\r\n        if (!groupedProjects[groupName]) {\r\n            groupedProjects[groupName] = {\r\n                division: division,\r\n                projects: []\r\n            };\r\n        }\r\n        groupedProjects[groupName].projects.push(p);\r\n    });\r\n\r\n    // Sort groups alphabetically by department name\r\n    const sortedGroupEntries = Object.entries(groupedProjects).sort((a, b) =>\r\n        a[0].localeCompare(b[0])\r\n    );\r\n\r\n    // Helper to get Status Color\r\n    const getStatusColor = (status) => {\r\n        switch (status) {\r\n            case 'green': return '#10b981';\r\n            case 'yellow': return '#f59e0b';\r\n            case 'red': return '#ef4444';\r\n            default: return '#6b7280';\r\n        }\r\n    };\r\n\r\n    const getStatusGradient = (status) => {\r\n        switch (status) {\r\n            case 'green': return 'linear-gradient(135deg, #059669, #10b981)';\r\n            case 'yellow': return 'linear-gradient(135deg, #d97706, #f59e0b)';\r\n            case 'red': return 'linear-gradient(135deg, #dc2626, #ef4444)';\r\n            default: return 'linear-gradient(135deg, #4b5563, #6b7280)';\r\n        }\r\n    };\r\n\r\n    const formatDate = (dateStr) => {\r\n        if (!dateStr) return '-';\r\n        return new Date(dateStr).toLocaleDateString('en-US', {\r\n            month: 'long',\r\n            day: 'numeric',\r\n            year: 'numeric'\r\n        });\r\n    };\r\n\r\n    const formatShortDate = (dateStr) => {\r\n        if (!dateStr) return '-';\r\n        return new Date(dateStr).toLocaleDateString('en-US', {\r\n            month: '2-digit',\r\n            day: '2-digit',\r\n            year: 'numeric'\r\n        });\r\n    };\r\n\r\n    const handleExportPdf = async () => {\r\n        if (!printRef.current) return;\r\n        const element = printRef.current;\r\n        const opt = {\r\n            margin: [0.3, 0.3, 0.3, 0.3],\r\n            filename: `Portfolio_Report_${new Date().toISOString().split('T')[0]}.pdf`,\r\n            image: { type: 'jpeg', quality: 0.98 },\r\n            html2canvas: {\r\n                scale: 2,\r\n                useCORS: true,\r\n                letterRendering: true,\r\n                scrollY: 0, // Critical for capturing full height\r\n                windowHeight: element.scrollHeight\r\n            },\r\n            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },\r\n            pagebreak: { mode: ['css', 'legacy'] }\r\n        };\r\n        await html2pdf().set(opt).from(element).save();\r\n    };\r\n\r\n    // Render a single Summary Card\r\n    const SummaryCard = ({ project }) => {\r\n        // Use embedded report from exec-summary data first, fallback to context\r\n        // BUT for the main view, we want the FULL report if possible.\r\n        // The user wants the screenshot view which has milestones etc. \r\n        // We might need to fetch full reports for the main view too if they are not already there?\r\n        // Actually, ExecDashboard uses lightweight reports and shows basic info. \r\n        // The screenshot shows \"Key Milestones\" which are usually in the full report.\r\n        // Let's use the full report if we have it (from the appendix fetch), otherwise fallback.\r\n        // Wait, the appendix fetch only happens if includeAppendix is true. \r\n        // If the user wants full details in the MAIN view, we should fetch them by default?\r\n        // The screenshot shows \"Key Milestones\", so yes, we need full data.\r\n\r\n        // HOWEVER, for now let's just restore the card.\r\n        // If the lightweight report has milestones (it might), then it works.\r\n        // If not, we might need to fetch full reports for EVERYTHING selected.\r\n\r\n        const report = fullReports[project.id] || project.report || getLatestStatusReport(project.id);\r\n        const statusColor = report ? getStatusColor(report.overallStatus) : '#d1d5db';\r\n        const statusGradient = report ? getStatusGradient(report.overallStatus) : 'linear-gradient(135deg, #4b5563, #6b7280)';\r\n\r\n        const infoTableStyle = {\r\n            width: '100%',\r\n            borderCollapse: 'collapse',\r\n            marginTop: '0'\r\n        };\r\n\r\n        const infoThStyle = {\r\n            background: 'linear-gradient(135deg, #0ea5e9, #38bdf8)',\r\n            color: 'white',\r\n            padding: '6px 8px',\r\n            textAlign: 'left',\r\n            fontWeight: '600',\r\n            fontSize: '10px',\r\n            border: '1px solid #0284c7'\r\n        };\r\n\r\n        const infoTdStyle = {\r\n            padding: '6px 8px',\r\n            border: '1px solid #d1d5db',\r\n            background: 'white',\r\n            verticalAlign: 'top',\r\n            fontSize: '10px'\r\n        };\r\n\r\n        const labelCellStyle = {\r\n            background: '#f3f4f6',\r\n            fontWeight: '600',\r\n            color: '#374151',\r\n            padding: '6px 8px',\r\n            border: '1px solid #d1d5db',\r\n            verticalAlign: 'top',\r\n            fontSize: '10px'\r\n        };\r\n\r\n        const bannerStyle = {\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'space-between',\r\n            padding: '8px 12px',\r\n            border: '2px solid #1f2937',\r\n            borderBottom: 'none',\r\n            overflow: 'hidden',\r\n            marginTop: '1rem'\r\n        };\r\n\r\n        const statusBarStyle = {\r\n            height: '24px',\r\n            width: '100%',\r\n            borderRadius: '2px',\r\n            backgroundColor: statusColor\r\n        };\r\n\r\n        return (\r\n            <div style={{ breakInside: 'avoid' }}>\r\n                {/* Header Banner */}\r\n                <div style={bannerStyle}>\r\n                    <div style={{ flex: '1', minWidth: 0 }}>\r\n                        {/* Placeholder for Logo if needed, user screenshot has it */}\r\n                    </div>\r\n                    <div style={{\r\n                        background: statusGradient,\r\n                        color: 'white',\r\n                        padding: '6px 20px',\r\n                        fontSize: '14px',\r\n                        fontWeight: '600',\r\n                        borderRadius: '4px',\r\n                        flexShrink: 0\r\n                    }}>\r\n                        Status Update\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Project Info Table */}\r\n                <table style={infoTableStyle}>\r\n                    <thead>\r\n                        <tr>\r\n                            <th style={{ ...infoThStyle, width: '25%' }}>Project Name</th>\r\n                            <th style={{ ...infoThStyle, width: '20%' }}>Report Date</th>\r\n                            <th style={{ ...infoThStyle, width: '20%' }}>Prepared By</th>\r\n                            <th style={{ ...infoThStyle, width: '35%' }}>Overall Status</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        <tr>\r\n                            <td style={infoTdStyle}>{project.title}</td>\r\n                            <td style={infoTdStyle}>{report ? formatDate(report.reportDate) : '-'}</td>\r\n                            <td style={infoTdStyle}>{report ? report.createdBy : '-'}</td>\r\n                            <td style={infoTdStyle}>\r\n                                <div style={statusBarStyle} />\r\n                            </td>\r\n                        </tr>\r\n                    </tbody>\r\n                </table>\r\n\r\n                {report && (\r\n                    <>\r\n                        {/* Project Purpose */}\r\n                        {report.purpose && (\r\n                            <table style={infoTableStyle}>\r\n                                <tbody>\r\n                                    <tr>\r\n                                        <td style={{ ...labelCellStyle, width: '15%' }}>Project Purpose:</td>\r\n                                        <td style={infoTdStyle}>{report.purpose}</td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n\r\n                        {/* Executive Summary */}\r\n                        {report.executiveSummary && (\r\n                            <table style={infoTableStyle}>\r\n                                <tbody>\r\n                                    <tr>\r\n                                        <td style={{ ...labelCellStyle, width: '15%' }}>Executive Summary - Current State:</td>\r\n                                        <td style={infoTdStyle}>{report.executiveSummary}</td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n\r\n                        {/* Key Contacts */}\r\n                        {report.contacts?.length > 0 && (\r\n                            <table style={infoTableStyle}>\r\n                                <tbody>\r\n                                    <tr>\r\n                                        <td style={{ ...labelCellStyle, width: '15%' }}>Key Contact(s):</td>\r\n                                        <td style={infoTdStyle}>\r\n                                            {report.contacts.map((c, i) => (\r\n                                                <span key={i}>\r\n                                                    {c.name}\r\n                                                    {i < report.contacts.length - 1 ? ', ' : ''}\r\n                                                </span>\r\n                                            ))}\r\n                                        </td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n\r\n                        {/* Milestones */}\r\n                        {report.milestones?.some(m => m.date) && (\r\n                            <div>\r\n                                <div style={{\r\n                                    background: 'linear-gradient(135deg, #059669, #10b981)',\r\n                                    color: 'white',\r\n                                    padding: '6px 12px',\r\n                                    fontWeight: '600',\r\n                                    fontSize: '11px',\r\n                                    borderRadius: '2px 2px 0 0'\r\n                                }}>\r\n                                    Key Milestones\r\n                                </div>\r\n                                <div style={{\r\n                                    border: '1px solid #d1d5db',\r\n                                    borderTop: 'none',\r\n                                    padding: '16px 8px',\r\n                                    background: 'white'\r\n                                }}>\r\n                                    <div style={{ display: 'flex', justifyContent: 'space-around', position: 'relative', padding: '10px 0' }}>\r\n                                        <div style={{\r\n                                            position: 'absolute', top: '50%', left: '5%', right: '5%', height: '3px',\r\n                                            background: '#374151', transform: 'translateY(-50%)', zIndex: 0\r\n                                        }} />\r\n                                        {report.milestones.filter(m => m.date).map((m, idx) => (\r\n                                            <div key={idx} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', zIndex: 1, flex: 1, textAlign: 'center' }}>\r\n                                                <div style={{ fontSize: '10px', color: '#1f2937', marginBottom: '8px', fontWeight: '600' }}>\r\n                                                    {formatShortDate(m.date)}\r\n                                                </div>\r\n                                                <div style={{\r\n                                                    width: '12px', height: '12px', transform: 'rotate(45deg)',\r\n                                                    background: m.status === 'complete' ? '#10b981' : (m.status === 'in-progress' ? '#f59e0b' : 'white'),\r\n                                                    border: `2px solid ${m.status === 'complete' ? '#10b981' : (m.status === 'in-progress' ? '#f59e0b' : '#374151')}`,\r\n                                                    boxShadow: '0 1px 2px rgba(0,0,0,0.1)'\r\n                                                }} />\r\n                                                <div style={{ fontSize: '9px', color: '#4b5563', marginTop: '8px', maxWidth: '80px', lineHeight: '1.2' }}>\r\n                                                    {m.name}\r\n                                                </div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                    </>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    if (reportProjects.length === 0) {\r\n        return (\r\n            <div className=\"report-preview-pane\">\r\n                <div className=\"preview-content\">\r\n                    <div style={{ color: 'white' }}>Select projects from the left to generate report.</div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"report-preview-pane\">\r\n            <div className=\"preview-header\">\r\n                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>\r\n                    <h3>Report Preview ({reportProjects.length} Projects)</h3>\r\n                    <button\r\n                        className=\"btn-secondary\"\r\n                        onClick={() => setIncludeAppendix(!includeAppendix)}\r\n                    >\r\n                        {includeAppendix ? <CheckSquare size={16} className=\"text-primary\" /> : <Square size={16} />}\r\n                        Include Detailed Appendices\r\n                    </button>\r\n                </div>\r\n                <div className=\"preview-actions\">\r\n                    <button className=\"btn-secondary\" onClick={() => window.print()}>\r\n                        <Printer size={16} /> Print\r\n                    </button>\r\n                    <button className=\"btn-primary\" onClick={handleExportPdf}>\r\n                        <Download size={16} /> Export PDF\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"preview-content\">\r\n                <div className=\"preview-sheet\" id=\"report-print-content\" ref={printRef}>\r\n\r\n                    {/* PART 1: PROJECT SUMMARIES (CARDS) */}\r\n                    <div className=\"report-summary-header\" style={{\r\n                        background: '#1f2937',\r\n                        color: 'white',\r\n                        padding: '1rem',\r\n                        textAlign: 'center',\r\n                        fontSize: '1.5rem',\r\n                        fontWeight: '700',\r\n                        marginBottom: '2rem'\r\n                    }}>\r\n                        Portfolio Status Report\r\n                        <div style={{ fontSize: '1rem', fontWeight: '400', marginTop: '0.5rem' }}>\r\n                            {formatDate(new Date())}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {sortedGroupEntries.map(([groupName, { projects }]) => (\r\n                        <div key={groupName} className=\"hierarchy-section\">\r\n                            <div className=\"hierarchy-header\">{groupName}</div>\r\n                            {projects.map(project => (\r\n                                <SummaryCard key={project.id} project={project} />\r\n                            ))}\r\n                        </div>\r\n                    ))}\r\n\r\n                    {/* PART 2: DETAILED APPENDICES */}\r\n                    {includeAppendix && (\r\n                        <>\r\n                            <div style={{ pageBreakBefore: 'always' }} />\r\n\r\n                            <div className=\"report-summary-header\" style={{\r\n                                background: '#1f2937',\r\n                                color: 'white',\r\n                                padding: '1rem',\r\n                                textAlign: 'center',\r\n                                fontSize: '1.5rem',\r\n                                fontWeight: '700',\r\n                                marginBottom: '0'\r\n                            }}>\r\n                                Appendix: Detailed Reports\r\n                            </div>\r\n\r\n                            {loadingFullReports && (\r\n                                <div style={{ padding: '2rem', textAlign: 'center', color: '#6b7280' }}>\r\n                                    Loading full reports...\r\n                                </div>\r\n                            )}\r\n\r\n                            {sortedGroupEntries.map(([groupName, { projects: groupProjects }]) => (\r\n                                <div key={groupName}>\r\n                                    {/* Division Subheader */}\r\n                                    <div style={{\r\n                                        background: 'linear-gradient(135deg, #374151, #4b5563)',\r\n                                        color: 'white',\r\n                                        padding: '8px 12px',\r\n                                        fontSize: '1rem',\r\n                                        fontWeight: '600'\r\n                                    }}>\r\n                                        {groupName}\r\n                                    </div>\r\n\r\n                                    {groupProjects.map((project) => {\r\n                                        // Use full report if available, fallback to embedded/context report\r\n                                        const report = fullReports[project.id] || project.report || getLatestStatusReport(project.id);\r\n                                        if (!report) return null;\r\n                                        return (\r\n                                            <div key={project.id}>\r\n                                                <StatusReportView\r\n                                                    report={report}\r\n                                                    projectTitle={project.title}\r\n                                                    onExportPdf={() => { }}\r\n                                                    hideActions={true}\r\n                                                />\r\n                                            </div>\r\n                                        );\r\n                                    })}\r\n                                </div>\r\n                            ))}\r\n                        </>\r\n                    )}\r\n\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Reports\\ReportsView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportCompare.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportEditor.jsx","messages":[],"suppressedMessages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_/u.","line":184,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":184,"endColumn":54,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[6340,6346],"text":""},"desc":"Remove unused variable 'Icon'."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportHistory.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportPage.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchReports'. Either include it or remove the dependency array.","line":44,"column":8,"nodeType":"ArrayExpression","endLine":44,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [fetchReports, project.id]","fix":{"range":[1776,1788],"text":"[fetchReports, project.id]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { Plus, FileText, History, Eye, RefreshCw } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\n\r\nimport { Modal } from '../UI/Modal';\r\nimport { StatusReportEditor } from './StatusReportEditor';\r\nimport { StatusReportView } from './StatusReportView';\r\nimport { StatusReportHistory } from './StatusReportHistory';\r\nimport { StatusReportCompare } from './StatusReportCompare';\r\nimport './StatusReport.css';\r\n\r\nimport { API_BASE } from '../../apiClient';\r\n\r\nexport function StatusReportPage({ project, onClose: _onClose }) {\r\n    const { authFetch } = useData();\r\n    const [reports, setReports] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [activeTab, setActiveTab] = useState('current'); // 'current', 'history', 'edit'\r\n    const [viewingReport, setViewingReport] = useState(null);\r\n    const [comparingReports, setComparingReports] = useState(null);\r\n\r\n    // Fetch reports on mount\r\n    const fetchReports = async () => {\r\n        // console.log(\"StatusReportPage: Fetching reports for project\", project.id);\r\n        setLoading(true);\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects/${project.id}/reports`);\r\n            if (res.ok) {\r\n                const data = await res.json();\r\n                // console.log(\"StatusReportPage: Fetched reports:\", data);\r\n                setReports(data);\r\n            } else {\r\n                console.error(\"StatusReportPage: Fetch failed status:\", res.status);\r\n            }\r\n        } catch (err) {\r\n            console.error(\"Failed to load reports:\", err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchReports();\r\n    }, [project.id]);\r\n\r\n    const latestReport = reports.length > 0 ? reports[0] : null; // API returns sorted DESC\r\n    useEffect(() => {\r\n        // console.log(\"StatusReportPage: latestReport:\", latestReport);\r\n    }, [latestReport]);\r\n\r\n    const handleViewReport = (report) => {\r\n        setViewingReport(report);\r\n        setActiveTab('view');\r\n    };\r\n\r\n    const handleCompare = (report1, report2) => {\r\n        // Ensure older version is first\r\n        const sorted = [report1, report2].sort((a, b) => a.version - b.version);\r\n        setComparingReports(sorted);\r\n        setActiveTab('compare');\r\n    };\r\n\r\n    const handleCreateNew = () => {\r\n        setActiveTab('edit');\r\n    };\r\n\r\n    const handleSaveComplete = () => {\r\n        fetchReports();\r\n        setActiveTab('current');\r\n        setViewingReport(null);\r\n    };\r\n\r\n    return (\r\n        <div className=\"status-report-page\">\r\n            {/* Tabs with New Report button */}\r\n            <div className=\"report-tabs\">\r\n                <button\r\n                    className={`report-tab ${activeTab === 'current' ? 'active' : ''}`}\r\n                    onClick={() => { setActiveTab('current'); setViewingReport(null); }}\r\n                >\r\n                    <Eye size={16} /> Current\r\n                </button>\r\n                <button\r\n                    className={`report-tab ${activeTab === 'history' ? 'active' : ''}`}\r\n                    onClick={() => setActiveTab('history')}\r\n                >\r\n                    <History size={16} /> History ({reports.length})\r\n                </button>\r\n                <button className=\"btn-primary btn-new-report\" onClick={handleCreateNew}>\r\n                    <Plus size={16} /> New Report\r\n                </button>\r\n            </div>\r\n\r\n            {loading ? (\r\n                <div style={{ padding: '2rem', textAlign: 'center', color: 'var(--text-secondary)' }}>\r\n                    <RefreshCw className=\"spin\" size={24} /> Loading reports...\r\n                </div>\r\n            ) : (\r\n                /* Content Area - Scrollable */\r\n                <div className=\"report-content-area\">\r\n                    {activeTab === 'current' && (\r\n                        <>\r\n                            {latestReport ? (\r\n                                <StatusReportView\r\n                                    report={latestReport}\r\n                                    projectTitle={project.title}\r\n                                />\r\n                            ) : (\r\n                                <div className=\"empty-reports\">\r\n                                    <FileText size={48} />\r\n                                    <p>No status reports yet. Create your first report to establish a governance baseline.</p>\r\n                                    <button className=\"btn-primary\" onClick={handleCreateNew}>\r\n                                        <Plus size={16} /> Create First Report\r\n                                    </button>\r\n                                </div>\r\n                            )}\r\n                        </>\r\n                    )}\r\n\r\n                    {activeTab === 'history' && (\r\n                        <StatusReportHistory\r\n                            projectId={project.id}\r\n                            reports={reports}\r\n                            onViewReport={handleViewReport}\r\n                            onCompare={handleCompare}\r\n                        />\r\n                    )}\r\n\r\n                    {activeTab === 'view' && viewingReport && (\r\n                        <StatusReportView\r\n                            report={viewingReport}\r\n                            projectTitle={project.title}\r\n                        />\r\n                    )}\r\n\r\n                    {activeTab === 'compare' && comparingReports && (\r\n                        <StatusReportCompare\r\n                            report1={comparingReports[0]}\r\n                            report2={comparingReports[1]}\r\n                            projectTitle={project.title}\r\n                            onClose={() => setActiveTab('history')}\r\n                        />\r\n                    )}\r\n                </div>\r\n            )}\r\n            {activeTab === 'edit' && (\r\n                <Modal\r\n                    isOpen={true}\r\n                    onClose={() => setActiveTab(latestReport ? 'current' : 'current')}\r\n                    title={`Create Status Report v${reports.length + 1}`}\r\n                    size=\"xl\"\r\n                    closeOnOverlayClick={false}\r\n                >\r\n                    <StatusReportEditor\r\n                        projectId={project.id}\r\n                        projectTitle={project.title}\r\n                        previousReport={latestReport}\r\n                        onSave={handleSaveComplete}\r\n                        onCancel={() => setActiveTab(latestReport ? 'current' : 'current')}\r\n                    />\r\n                </Modal>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\CascadingGoalFilter.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  78 |     useEffect(() => {\n  79 |         if (!value) {\n> 80 |             setSelections({ org: '', division: '', department: '', branch: '' });\n     |             ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  81 |             return;\n  82 |         }\n  83 |","line":80,"column":13,"nodeType":null,"endLine":80,"endColumn":26},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":190,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":190,"endColumn":37}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { Filter, X } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport './CascadingGoalFilter.css';\r\n\r\nconst LEVEL_NAMES = ['Organization', 'Division', 'Department', 'Branch'];\r\n\r\nexport function CascadingGoalFilter({ value, onChange }) {\r\n    const { goals } = useData();\r\n\r\n    // Track selections at each level\r\n    const [selections, setSelections] = useState({\r\n        org: '',\r\n        division: '',\r\n        department: '',\r\n        branch: ''\r\n    });\r\n\r\n    // Get goals at each level\r\n    const getGoalsAtLevel = (level, parentId = null) => {\r\n        if (level === 0) {\r\n            // Root level - no parent\r\n            return goals.filter(g => !g.parentId);\r\n        }\r\n        // Child level - filter by parent\r\n        if (!parentId) return [];\r\n        return goals.filter(g => g.parentId === parentId);\r\n    };\r\n\r\n    // Get available options for each dropdown\r\n    const orgGoals = getGoalsAtLevel(0);\r\n    const divisionGoals = getGoalsAtLevel(1, selections.org);\r\n    const departmentGoals = getGoalsAtLevel(2, selections.division);\r\n    const branchGoals = getGoalsAtLevel(3, selections.department);\r\n\r\n    // Handle selection change at a level\r\n    const handleChange = (level, goalIdValue) => {\r\n        // IDs are strings from API, so keep them as strings to match\r\n        const goalId = goalIdValue || '';\r\n        const newSelections = { ...selections };\r\n\r\n        switch (level) {\r\n            case 'org':\r\n                newSelections.org = goalId;\r\n                newSelections.division = '';\r\n                newSelections.department = '';\r\n                newSelections.branch = '';\r\n                break;\r\n            case 'division':\r\n                newSelections.division = goalId;\r\n                newSelections.department = '';\r\n                newSelections.branch = '';\r\n                break;\r\n            case 'department':\r\n                newSelections.department = goalId;\r\n                newSelections.branch = '';\r\n                break;\r\n            case 'branch':\r\n                newSelections.branch = goalId;\r\n                break;\r\n        }\r\n\r\n        setSelections(newSelections);\r\n\r\n        // Return the most specific (deepest) selection\r\n        const selectedId = newSelections.branch || newSelections.department ||\r\n            newSelections.division || newSelections.org || '';\r\n        onChange(selectedId);\r\n    };\r\n\r\n    // Clear all filters\r\n    const handleClear = () => {\r\n        setSelections({ org: '', division: '', department: '', branch: '' });\r\n        onChange('');\r\n    };\r\n\r\n    // Sync external value changes\r\n    useEffect(() => {\r\n        if (!value) {\r\n            setSelections({ org: '', division: '', department: '', branch: '' });\r\n            return;\r\n        }\r\n\r\n        // Find the goal and trace its ancestry\r\n        // Use loose equality or parsing to match string/number\r\n        const goal = goals.find(g => g.id == value);\r\n        if (!goal) return;\r\n\r\n        // Build ancestry chain\r\n        const ancestry = [];\r\n        let current = goal;\r\n        while (current) {\r\n            ancestry.unshift(current.id);\r\n            // Ensure parentId lookup is robust\r\n            current = goals.find(g => g.id === current.parentId);\r\n        }\r\n\r\n        // Set selections based on ancestry\r\n        setSelections({\r\n            org: ancestry[0] || '',\r\n            division: ancestry[1] || '',\r\n            department: ancestry[2] || '',\r\n            branch: ancestry[3] || ''\r\n        });\r\n    }, [value, goals]);\r\n\r\n    const hasAnySelection = selections.org || selections.division ||\r\n        selections.department || selections.branch;\r\n\r\n    return (\r\n        <div className=\"cascading-filter\">\r\n            <div className=\"cascading-filter-row\">\r\n                <Filter size={16} className=\"filter-icon\" />\r\n\r\n                {/* Organization */}\r\n                <select\r\n                    value={selections.org}\r\n                    onChange={e => handleChange('org', e.target.value)}\r\n                    className=\"form-select\"\r\n                    style={{ minWidth: '160px', width: 'auto' }}\r\n                >\r\n                    <option value=\"\">All Organizations</option>\r\n                    {orgGoals.map(g => (\r\n                        <option key={g.id} value={g.id}>{g.title}</option>\r\n                    ))}\r\n                </select>\r\n\r\n                {/* Division - only show if org selected */}\r\n                {selections.org && divisionGoals.length > 0 && (\r\n                    <select\r\n                        value={selections.division}\r\n                        onChange={e => handleChange('division', e.target.value)}\r\n                        className=\"form-select\"\r\n                        style={{ minWidth: '160px', width: 'auto' }}\r\n                    >\r\n                        <option value=\"\">All Divisions</option>\r\n                        {divisionGoals.map(g => (\r\n                            <option key={g.id} value={g.id}>{g.title}</option>\r\n                        ))}\r\n                    </select>\r\n                )}\r\n\r\n                {/* Department - only show if division selected */}\r\n                {selections.division && departmentGoals.length > 0 && (\r\n                    <select\r\n                        value={selections.department}\r\n                        onChange={e => handleChange('department', e.target.value)}\r\n                        className=\"form-select\"\r\n                        style={{ minWidth: '160px', width: 'auto' }}\r\n                    >\r\n                        <option value=\"\">All Departments</option>\r\n                        {departmentGoals.map(g => (\r\n                            <option key={g.id} value={g.id}>{g.title}</option>\r\n                        ))}\r\n                    </select>\r\n                )}\r\n\r\n                {/* Branch - only show if department selected */}\r\n                {selections.department && branchGoals.length > 0 && (\r\n                    <select\r\n                        value={selections.branch}\r\n                        onChange={e => handleChange('branch', e.target.value)}\r\n                        className=\"form-select\"\r\n                        style={{ minWidth: '160px', width: 'auto' }}\r\n                    >\r\n                        <option value=\"\">All Branches</option>\r\n                        {branchGoals.map(g => (\r\n                            <option key={g.id} value={g.id}>{g.title}</option>\r\n                        ))}\r\n                    </select>\r\n                )}\r\n\r\n                {/* Clear button */}\r\n                {hasAnySelection && (\r\n                    <button\r\n                        className=\"btn-secondary\"\r\n                        onClick={handleClear}\r\n                        title=\"Clear filters\"\r\n                        style={{ padding: '0.6rem', display: 'flex', alignItems: 'center', justifyContent: 'center' }}\r\n                    >\r\n                        <X size={16} />\r\n                    </button>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\n// Helper function to get all descendant goal IDs\r\nexport function getDescendantGoalIds(goals, parentId) {\r\n    const descendants = [];\r\n    // Use loose equality to match string IDs with number parentIds if needed\r\n    const children = goals.filter(g => g.parentId == parentId);\r\n\r\n    for (const child of children) {\r\n        descendants.push(child.id);\r\n        descendants.push(...getDescendantGoalIds(goals, child.id));\r\n    }\r\n\r\n    return descendants;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\ErrorBoundary.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\FilterBar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\Modal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\ProjectTagSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\ThemeToggle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\Toast.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\context\\DataContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":955,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":955,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useEffect, useState, useMemo, useCallback } from 'react';\r\nimport { useMsal } from '@azure/msal-react';\r\nimport { apiRequest } from '../authConfig';\r\nimport { fetchWithAuth, ApiError, API_BASE } from '../apiClient';\r\n\r\nconst DataContext = createContext();\r\n\r\n// Helper: Calculate project completion percentage\r\nfunction calcProjectCompletion(project) {\r\n    // ... (unchanged)\r\n    if (!project._detailsLoaded) return project.completion || 0;\r\n    if (!project.tasks || project.tasks.length === 0) return 0;\r\n    const doneCount = project.tasks.filter(t => t.status === 'done').length;\r\n    return Math.round((doneCount / project.tasks.length) * 100);\r\n}\r\n\r\nexport function DataProvider({ children }) {\r\n    // ... State definitions (unchanged)\r\n    const [goals, setGoals] = useState([]);\r\n    const [projects, setProjects] = useState([]);\r\n    const [projectsPagination, setProjectsPagination] = useState({\r\n        page: 1, limit: 50, total: 0, totalPages: 0, hasMore: false\r\n    });\r\n    const [intakeForms, setIntakeForms] = useState([]);\r\n    const [intakeSubmissions, setIntakeSubmissions] = useState([]);\r\n    const [tagGroups, setTagGroups] = useState([]);\r\n    const [permissions, setPermissions] = useState([]);\r\n    const { instance } = useMsal();\r\n    const [loading, setLoading] = useState(true);\r\n    const [loadingMore, setLoadingMore] = useState(false);\r\n    const [error, setError] = useState(null);\r\n\r\n    // Helper: Authenticated fetch wrapper using centralized client\r\n    const authFetch = useCallback(async (url, options = {}) => {\r\n        let token = null;\r\n        try {\r\n            const account = instance.getActiveAccount();\r\n            if (account) {\r\n                const response = await instance.acquireTokenSilent({\r\n                    ...apiRequest,\r\n                    account: account\r\n                });\r\n                token = response.accessToken;\r\n            }\r\n        } catch (error) {\r\n            console.error('Token acquisition failed', error);\r\n            // Proceed without token (backend will reject 401 if strict)\r\n        }\r\n\r\n        return fetchWithAuth(url, token, options);\r\n    }, [instance]);\r\n\r\n    // Load more projects (pagination)\r\n    const loadMoreProjects = useCallback(async () => {\r\n        if (!projectsPagination.hasMore || loadingMore) return;\r\n\r\n        setLoadingMore(true);\r\n        try {\r\n            const nextPage = projectsPagination.page + 1;\r\n            const res = await authFetch(`${API_BASE}/projects?page=${nextPage}&limit=${projectsPagination.limit}`);\r\n            // fetchWithAuth throws on error, so res is OK here\r\n            const data = await res.json();\r\n            setProjects(prev => [...prev, ...data.projects]);\r\n            setProjectsPagination(data.pagination);\r\n        } catch (err) {\r\n            console.error('Error loading more projects:', err);\r\n        } finally {\r\n            setLoadingMore(false);\r\n        }\r\n    }, [projectsPagination, loadingMore, authFetch]);\r\n\r\n    // Fetch Exec Summary (All Projects)\r\n    const fetchExecSummaryProjects = useCallback(async () => {\r\n        const res = await authFetch(`${API_BASE}/projects/exec-summary`);\r\n        return await res.json();\r\n    }, [authFetch]);\r\n\r\n    // Fetch all data on mount (Permission-Aware)\r\n    useEffect(() => {\r\n        async function fetchData() {\r\n            try {\r\n                console.log(\"DataContext: Starting data fetch...\");\r\n                setLoading(true);\r\n\r\n                // 1. Fetch Permissions FIRST to determine what else to fetch\r\n                let currentPermissions = [];\r\n                try {\r\n                    const permsRes = await authFetch(`${API_BASE}/admin/permissions`);\r\n                    currentPermissions = await permsRes.json();\r\n                    setPermissions(currentPermissions);\r\n                } catch (err) {\r\n                    console.warn(\"DataContext: Failed to load permissions\", err);\r\n                    // If 403/401, permissions remain empty\r\n                }\r\n\r\n                // Helper to check permission against the JUST loaded permissions\r\n                // (State update hasn't propagated yet)\r\n                const account = instance.getActiveAccount();\r\n                const roles = account?.idTokenClaims?.roles || [];\r\n                const checkPerm = (permKey) => {\r\n                    if (roles.includes('Admin')) return true;\r\n                    // Check if any user role has the permission allowed\r\n                    return currentPermissions.some(p => roles.includes(p.role) && p.permission === permKey && p.isAllowed);\r\n                };\r\n\r\n                // 2. Fetch Core Data (Goals, Projects)\r\n                // We use Promise.allSettled to allow partial failures\r\n                const [goalsResult, projectsResult] = await Promise.allSettled([\r\n                    checkPerm('can_view_goals') ? authFetch(`${API_BASE}/goals`) : Promise.reject('skipped'),\r\n                    checkPerm('can_view_projects') ? authFetch(`${API_BASE}/projects?page=1&limit=50`) : Promise.reject('skipped')\r\n                ]);\r\n\r\n                if (goalsResult.status === 'fulfilled') {\r\n                    setGoals(await goalsResult.value.json());\r\n                } else if (goalsResult.reason !== 'skipped') {\r\n                    // Check if it was 403 (shouldn't happen if checkPerm works, but fallback)\r\n                    if (goalsResult.reason?.status === 403) {\r\n                        setGoals([]);\r\n                    } else {\r\n                        console.error(\"Failed to load goals\", goalsResult.reason);\r\n                    }\r\n                }\r\n\r\n                if (projectsResult.status === 'fulfilled') {\r\n                    const projectsData = await projectsResult.value.json();\r\n                    setProjects(projectsData.projects || projectsData);\r\n                    if (projectsData.pagination) setProjectsPagination(projectsData.pagination);\r\n                } else if (projectsResult.reason !== 'skipped') {\r\n                    if (projectsResult.reason?.status === 403) {\r\n                        setProjects([]);\r\n                    } else {\r\n                        console.error(\"Failed to load projects\", projectsResult.reason);\r\n                    }\r\n                }\r\n\r\n                console.log(\"DataContext: Critical data loaded. Unblocking render.\");\r\n                setLoading(false);\r\n\r\n                // 3. Fetch Secondary Data (Intake, Tags) - Background\r\n                const secondaryPromises = [];\r\n\r\n                // Tags (generally public/authenticated)\r\n                secondaryPromises.push(authFetch(`${API_BASE}/tags`).then(r => r.json()).then(setTagGroups).catch(e => console.warn('Tags fetch failed', e)));\r\n\r\n                // Intake Forms (if can view/manage)\r\n                if (checkPerm('can_view_intake') || checkPerm('can_manage_intake')) {\r\n                    secondaryPromises.push(authFetch(`${API_BASE}/intake/forms`).then(r => r.json()).then(setIntakeForms).catch(e => console.warn('Intake forms failed', e)));\r\n                }\r\n\r\n                // Submissions - ONLY if allowed\r\n                // 'can_view_incoming_requests' -> All submissions\r\n                if (checkPerm('can_view_incoming_requests')) {\r\n                    secondaryPromises.push(authFetch(`${API_BASE}/intake/submissions`).then(r => r.json()).then(setIntakeSubmissions).catch(e => console.warn('Submissions fetch failed', e)));\r\n                }\r\n\r\n                // My Submissions - Always allowed for authenticated users\r\n                if (account) {\r\n                    secondaryPromises.push(authFetch(`${API_BASE}/intake/my-submissions`).then(r => r.json()).then(setMySubmissions).catch(e => console.warn('My Submissions failed', e)));\r\n                }\r\n\r\n                await Promise.allSettled(secondaryPromises);\r\n\r\n                setError(null);\r\n            } catch (err) {\r\n                console.error('Error fetching data:', err);\r\n                setError(err.message);\r\n                setLoading(false);\r\n            }\r\n        }\r\n\r\n        const account = instance.getActiveAccount();\r\n        if (account) {\r\n            fetchData();\r\n        }\r\n    }, [instance, authFetch]);\r\n\r\n\r\n    const updatePermissionsBulk = useCallback(async (updates) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/admin/permissions/bulk`, {\r\n                method: 'POST',\r\n                body: JSON.stringify({ updates })\r\n            });\r\n            if (!res.ok) throw new Error('Failed to update permissions');\r\n\r\n            // Update local state\r\n            setPermissions(prev => {\r\n                const newPerms = [...prev];\r\n                updates.forEach(u => {\r\n                    const idx = newPerms.findIndex(p => p.role === u.role && p.permission === u.permission);\r\n                    if (idx >= 0) {\r\n                        newPerms[idx] = { ...newPerms[idx], isAllowed: u.isAllowed };\r\n                    } else {\r\n                        newPerms.push({ role: u.role, permission: u.permission, isAllowed: u.isAllowed });\r\n                    }\r\n                });\r\n                return newPerms;\r\n            });\r\n            return true;\r\n        } catch (err) {\r\n            console.error(err);\r\n            return false;\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // Derived: Projects with completion %\r\n    const projectsWithCompletion = useMemo(() => {\r\n        return projects.map(p => ({\r\n            ...p,\r\n            completion: calcProjectCompletion(p)\r\n        }));\r\n    }, [projects]);\r\n\r\n    // Derived: Goals with progress calculated from server-provided stats (recursive aggregation)\r\n    const goalsWithProgress = useMemo(() => {\r\n        if (goals.length === 0) return [];\r\n\r\n        // 1. Goal Hierarchy Lookup (O(G)) - Parent -> Children\r\n        const goalChildrenMap = {};\r\n        goals.forEach(g => {\r\n            if (g.parentId) {\r\n                if (!goalChildrenMap[g.parentId]) goalChildrenMap[g.parentId] = [];\r\n                goalChildrenMap[g.parentId].push(g.id);\r\n            }\r\n        });\r\n\r\n        // 2. Recursive Stats Aggregation with Memoization\r\n        const statsCache = {}; // Stores { count, sum, kpiCount } for each goal (including descendants)\r\n\r\n        const getGoalStats = (goalId) => {\r\n            if (statsCache[goalId] !== undefined) return statsCache[goalId];\r\n\r\n            // Prevent infinite recursion\r\n            statsCache[goalId] = { count: 0, sum: 0, kpiCount: 0 };\r\n\r\n            const goal = goals.find(g => g.id === goalId);\r\n            if (!goal) return { count: 0, sum: 0, kpiCount: 0 };\r\n\r\n            // Start with direct/server stats\r\n            let totalCount = goal.directProjectCount || 0;\r\n            let totalSum = goal.directCompletionSum || 0;\r\n            let totalKpiCount = (goal.kpis ? goal.kpis.length : 0);\r\n\r\n            // Add stats from child goals\r\n            const childGoalIds = goalChildrenMap[goalId] || [];\r\n            childGoalIds.forEach(childId => {\r\n                const childStats = getGoalStats(childId);\r\n                totalCount += childStats.count;\r\n                totalSum += childStats.sum;\r\n                totalKpiCount += childStats.kpiCount;\r\n            });\r\n\r\n            const result = { count: totalCount, sum: totalSum, kpiCount: totalKpiCount };\r\n            statsCache[goalId] = result;\r\n            return result;\r\n        };\r\n\r\n        return goals.map(goal => {\r\n            // Get aggregated stats\r\n            const stats = getGoalStats(goal.id);\r\n\r\n            // Calculate progress\r\n            let progress = 0;\r\n            if (stats.count > 0) {\r\n                progress = Math.round(stats.sum / stats.count);\r\n            }\r\n\r\n            return {\r\n                ...goal,\r\n                progress,\r\n                linkedProjectCount: goal.directProjectCount || 0, // Direct only\r\n                totalProjectCount: stats.count,                   // Rolling up count\r\n                totalKpiCount: stats.kpiCount                     // Rolling up KPI count\r\n            };\r\n        });\r\n    }, [goals]);\r\n\r\n    // Optimization: Pre-calculate user permissions into a Set for O(1) lookup\r\n    const userPermissions = useMemo(() => {\r\n        const account = instance.getActiveAccount();\r\n        if (!account || !account.idTokenClaims || !account.idTokenClaims.roles) return new Set();\r\n\r\n        const roles = account.idTokenClaims.roles;\r\n\r\n        // Admin bypass - Efficiently handle admins\r\n        if (roles.includes('Admin')) return 'ALL';\r\n\r\n        const allowed = new Set();\r\n        // Iterate permissions once to build the lookup set\r\n        permissions.forEach(p => {\r\n            // If user has the role and permission is allowed, add to set\r\n            if (roles.includes(p.role) && p.isAllowed) {\r\n                allowed.add(p.permission);\r\n            }\r\n        });\r\n        return allowed;\r\n    }, [instance, permissions]);\r\n\r\n    // Optimized O(1) permission check\r\n    const hasPermission = useCallback((permissionKey) => {\r\n        if (userPermissions === 'ALL') return true;\r\n        return userPermissions.has(permissionKey);\r\n    }, [userPermissions]);\r\n\r\n    // ==================== GOALS ====================\r\n\r\n    const addGoal = useCallback(async (goal) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/goals`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(goal)\r\n            });\r\n            const newGoal = await res.json();\r\n            setGoals(prev => [...prev, newGoal]);\r\n            return newGoal.id;\r\n        } catch (err) {\r\n            console.error('Error adding goal:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateGoal = useCallback(async (id, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/goals/${id}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setGoals(prev => prev.map(g => g.id === id ? { ...g, ...updates } : g));\r\n        } catch (err) {\r\n            console.error('Error updating goal:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const deleteGoal = useCallback(async (id) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/goals/${id}`, { method: 'DELETE' });\r\n            setGoals(prev => prev.filter(g => g.id !== id));\r\n        } catch (err) {\r\n            console.error('Error deleting goal:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== KPIs ====================\r\n\r\n    const addKpi = useCallback(async (goalId, kpi) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/goals/${goalId}/kpis`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(kpi)\r\n            });\r\n            const newKpi = await res.json();\r\n            setGoals(prev => prev.map(g => {\r\n                if (g.id !== goalId) return g;\r\n                return { ...g, kpis: [...(g.kpis || []), newKpi] };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error adding KPI:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateKpi = useCallback(async (goalId, kpiId, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/kpis/${kpiId}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setGoals(prev => prev.map(g => {\r\n                if (g.id !== goalId) return g;\r\n                return {\r\n                    ...g,\r\n                    kpis: (g.kpis || []).map(k => k.id === kpiId ? { ...k, ...updates } : k)\r\n                };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error updating KPI:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const deleteKpi = useCallback(async (goalId, kpiId) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/kpis/${kpiId}`, { method: 'DELETE' });\r\n            setGoals(prev => prev.map(g => {\r\n                if (g.id !== goalId) return g;\r\n                return { ...g, kpis: (g.kpis || []).filter(k => k.id !== kpiId) };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error deleting KPI:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== PROJECTS ====================\r\n\r\n    // Fetch full project details (tasks, reports, etc.) on demand\r\n    const loadProjectDetails = useCallback(async (projectId) => {\r\n        try {\r\n            setLoading(true);\r\n            const res = await authFetch(`${API_BASE}/projects/${projectId}`);\r\n            if (!res.ok) throw new Error('Failed to load project details');\r\n\r\n            const detailedProject = await res.json();\r\n\r\n            if (detailedProject) {\r\n                // Update local state with the detailed version\r\n                setProjects(prev => prev.map(p =>\r\n                    p.id === projectId ? { ...p, ...detailedProject, _detailsLoaded: true } : p\r\n                ));\r\n            }\r\n\r\n            return detailedProject;\r\n        } catch (err) {\r\n            console.error('Error loading project details:', err);\r\n            return null;\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const addProject = useCallback(async (project) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(project)\r\n            });\r\n            if (!res.ok) {\r\n                const errData = await res.json().catch(() => ({}));\r\n                throw new Error(errData.error || `Failed to create project (HTTP ${res.status})`);\r\n            }\r\n            const newProject = await res.json();\r\n            setProjects(prev => [...prev, newProject]);\r\n            return newProject.id;\r\n        } catch (err) {\r\n            console.error('Error adding project:', err);\r\n            throw err;\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateProject = useCallback(async (id, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/projects/${id}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setProjects(prev => prev.map(p => p.id === id ? { ...p, ...updates } : p));\r\n        } catch (err) {\r\n            console.error('Error updating project:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const deleteProject = useCallback(async (id) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/projects/${id}`, { method: 'DELETE' });\r\n            setProjects(prev => prev.filter(p => p.id !== id));\r\n        } catch (err) {\r\n            console.error('Error deleting project:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== TASKS ====================\r\n\r\n    const addTask = useCallback(async (projectId, task) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects/${projectId}/tasks`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(task)\r\n            });\r\n            const newTask = await res.json();\r\n            setProjects(prev => prev.map(p => {\r\n                if (String(p.id) !== String(projectId)) return p;\r\n                // If tasks array exists, update it. If not, just update count/metadata if needed\r\n                if (!p.tasks) return { ...p, taskCount: (p.taskCount || 0) + 1 };\r\n\r\n                return { ...p, tasks: [...p.tasks, newTask], taskCount: p.tasks.length + 1 };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error adding task:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateTask = useCallback(async (projectId, taskId, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/tasks/${taskId}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setProjects(prev => prev.map(p => {\r\n                if (String(p.id) !== String(projectId)) return p;\r\n                if (!p.tasks) return p; // Tasks not loaded, nothing to update in state\r\n\r\n                return {\r\n                    ...p,\r\n                    tasks: p.tasks.map(t => String(t.id) === String(taskId) ? { ...t, ...updates } : t)\r\n                };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error updating task:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const moveTask = useCallback(async (projectId, taskId, newStatus) => {\r\n        await updateTask(projectId, taskId, { status: newStatus });\r\n    }, [updateTask]);\r\n\r\n    const deleteTask = useCallback(async (projectId, taskId) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/tasks/${taskId}`, { method: 'DELETE' });\r\n            setProjects(prev => prev.map(p => {\r\n                if (String(p.id) !== String(projectId)) return p;\r\n                if (!p.tasks) return { ...p, taskCount: Math.max(0, (p.taskCount || 1) - 1) };\r\n\r\n                return {\r\n                    ...p,\r\n                    tasks: p.tasks.filter(t => String(t.id) !== String(taskId)),\r\n                    taskCount: p.tasks.length - 1\r\n                };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error deleting task:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== STATUS REPORTS ====================\r\n\r\n    const addStatusReport = useCallback(async (projectId, reportData) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects/${projectId}/reports`, {\r\n                method: 'POST',\r\n                body: JSON.stringify({ reportData, createdBy: reportData.createdBy })\r\n            });\r\n            const newReport = await res.json();\r\n            setProjects(prev => prev.map(p => {\r\n                if (p.id !== projectId) return p;\r\n                return {\r\n                    ...p,\r\n                    statusReports: [...(p.statusReports || []), newReport],\r\n                    latestReport: newReport,\r\n                    reportCount: (p.reportCount || 0) + 1\r\n                };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error adding status report:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const getLatestStatusReport = useCallback((projectId) => {\r\n        const project = projects.find(p => p.id === projectId);\r\n        if (!project) return null;\r\n        // optimization: check pre-fetched latestReport\r\n        if (project.latestReport) return project.latestReport;\r\n        // fallback: check statusReports array if loaded\r\n        if (project.statusReports?.length) return project.statusReports[project.statusReports.length - 1];\r\n        return null;\r\n    }, [projects]);\r\n\r\n    const restoreStatusReport = useCallback(async (projectId, reportId, author) => {\r\n        const project = projects.find(p => p.id === projectId);\r\n        const reportToRestore = project?.statusReports?.find(r => r.id === reportId);\r\n        if (!reportToRestore) return;\r\n\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects/${projectId}/reports`, {\r\n                method: 'POST',\r\n                body: JSON.stringify({\r\n                    reportData: reportToRestore,\r\n                    createdBy: author,\r\n                    restoredFrom: reportToRestore.version\r\n                })\r\n            });\r\n            const newReport = await res.json();\r\n            setProjects(prev => prev.map(p => {\r\n                if (p.id !== projectId) return p;\r\n                return { ...p, statusReports: [...(p.statusReports || []), newReport] };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error restoring status report:', err);\r\n        }\r\n    }, [projects, authFetch]);\r\n\r\n    // ==================== INTAKE FORMS ====================\r\n\r\n    const addIntakeForm = useCallback(async (form) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/intake/forms`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(form)\r\n            });\r\n            const newForm = await res.json();\r\n            setIntakeForms(prev => [...prev, newForm]);\r\n            return newForm.id;\r\n        } catch (err) {\r\n            console.error('Error adding intake form:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateIntakeForm = useCallback(async (id, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/intake/forms/${id}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setIntakeForms(prev => prev.map(f => f.id === id ? { ...f, ...updates } : f));\r\n        } catch (err) {\r\n            console.error('Error updating intake form:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const deleteIntakeForm = useCallback(async (id) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/intake/forms/${id}`, { method: 'DELETE' });\r\n            setIntakeForms(prev => prev.filter(f => f.id !== id));\r\n        } catch (err) {\r\n            console.error('Error deleting intake form:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== INTAKE SUBMISSIONS ====================\r\n\r\n    const [mySubmissions, setMySubmissions] = useState([]);\r\n\r\n    // ... (existing code)\r\n\r\n    // Helper: Authenticated fetch wrapper\r\n    // ...\r\n\r\n\r\n\r\n    // ...\r\n\r\n    // ==================== INTAKE SUBMISSIONS ====================\r\n\r\n    const addIntakeSubmission = useCallback(async (submission) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/intake/submissions`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(submission)\r\n            });\r\n            const newSubmission = await res.json();\r\n\r\n            // Update both lists\r\n            setIntakeSubmissions(prev => [...prev, newSubmission]);\r\n            setMySubmissions(prev => [newSubmission, ...prev]); // Add to top of my list\r\n\r\n            return newSubmission.id;\r\n        } catch (err) {\r\n            console.error('Error adding submission:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateIntakeSubmission = useCallback(async (id, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/intake/submissions/${id}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n\r\n            // Update both lists\r\n            setIntakeSubmissions(prev => prev.map(s => s.id === id ? { ...s, ...updates } : s));\r\n            setMySubmissions(prev => prev.map(s => s.id === id ? { ...s, ...updates } : s));\r\n\r\n        } catch (err) {\r\n            console.error('Error updating submission:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const addConversationMessage = useCallback(async (submissionId, message, senderType) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/intake/submissions/${submissionId}/message`, {\r\n                method: 'POST',\r\n                body: JSON.stringify({ message })\r\n            });\r\n\r\n            if (!res.ok) throw new Error('Failed to send message');\r\n\r\n            const { conversation } = await res.json();\r\n\r\n            const newStatus = senderType === 'admin' ? 'awaiting-response' : 'pending';\r\n\r\n            // Optimistic update or refetch - here taking the returned conversation\r\n            const updateLocal = (prev) => prev.map(s => {\r\n                if (s.id !== submissionId) return s;\r\n                return {\r\n                    ...s,\r\n                    status: newStatus,\r\n                    conversation: conversation\r\n                };\r\n            });\r\n\r\n            setIntakeSubmissions(prev => updateLocal(prev));\r\n            setMySubmissions(prev => updateLocal(prev));\r\n\r\n        } catch (err) {\r\n            console.error('Error sending message:', err);\r\n            throw err;\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const markConversationRead = useCallback(async (submissionId) => {\r\n        const submission = intakeSubmissions.find(s => s.id === submissionId);\r\n        if (!submission?.conversation) return;\r\n\r\n        const updatedConversation = submission.conversation.map(msg => ({\r\n            ...msg,\r\n            read: true\r\n        }));\r\n\r\n        await updateIntakeSubmission(submissionId, {\r\n            conversation: updatedConversation\r\n        });\r\n    }, [intakeSubmissions, updateIntakeSubmission]);\r\n\r\n    // Legacy support: migrate old infoRequests to conversation format\r\n    const migrateInfoRequestsToConversation = useCallback((submission) => {\r\n        if (!submission.infoRequests || submission.conversation) return submission;\r\n\r\n        const conversation = [];\r\n        submission.infoRequests.forEach(ir => {\r\n            // Add admin question\r\n            conversation.push({\r\n                id: `msg-${ir.id}-q`,\r\n                type: 'admin',\r\n                message: ir.question,\r\n                timestamp: ir.askedAt,\r\n                read: true\r\n            });\r\n            // Add requester response if exists\r\n            if (ir.response) {\r\n                conversation.push({\r\n                    id: `msg-${ir.id}-r`,\r\n                    type: 'requester',\r\n                    message: ir.response,\r\n                    timestamp: ir.respondedAt,\r\n                    read: true\r\n                });\r\n            }\r\n        });\r\n\r\n        return { ...submission, conversation };\r\n    }, []);\r\n\r\n\r\n\r\n    const convertSubmissionToProject = useCallback(async (submissionId, projectData) => {\r\n        const projectId = await addProject(projectData);\r\n        if (!projectId) {\r\n            throw new Error('Project creation failed — no project ID returned');\r\n        }\r\n        await updateIntakeSubmission(submissionId, {\r\n            status: 'approved',\r\n            convertedProjectId: projectId\r\n        });\r\n        return projectId;\r\n    }, [addProject, updateIntakeSubmission]);\r\n\r\n    // ==================== TAG MANAGEMENT ====================\r\n\r\n    const refreshTags = useCallback(async () => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/tags`);\r\n            if (res.ok) setTagGroups(await res.json());\r\n        } catch (err) {\r\n            console.error('Failed to refresh tags:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const addTagGroup = useCallback(async (groupData) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tag-groups`, {\r\n            method: 'POST',\r\n            body: JSON.stringify(groupData)\r\n        });\r\n        if (!res.ok) throw new Error('Failed to create tag group');\r\n        const newGroup = await res.json();\r\n        setTagGroups(prev => [...prev, newGroup]);\r\n        return newGroup;\r\n    }, [authFetch]);\r\n\r\n    const updateTagGroup = useCallback(async (id, groupData) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tag-groups/${id}`, {\r\n            method: 'PUT',\r\n            body: JSON.stringify(groupData)\r\n        });\r\n        if (!res.ok) throw new Error('Failed to update tag group');\r\n        await refreshTags();\r\n    }, [authFetch, refreshTags]);\r\n\r\n    const deleteTagGroup = useCallback(async (id) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tag-groups/${id}`, {\r\n            method: 'DELETE'\r\n        });\r\n        if (!res.ok) throw new Error('Failed to delete tag group');\r\n        setTagGroups(prev => prev.filter(g => g.id !== id));\r\n    }, [authFetch]);\r\n\r\n    const addTag = useCallback(async (tagData) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tags`, {\r\n            method: 'POST',\r\n            body: JSON.stringify(tagData)\r\n        });\r\n        if (!res.ok) throw new Error('Failed to create tag');\r\n        const newTag = await res.json();\r\n        setTagGroups(prev => prev.map(g =>\r\n            g.id === tagData.groupId ? { ...g, tags: [...g.tags, newTag] } : g\r\n        ));\r\n        return newTag;\r\n    }, [authFetch]);\r\n\r\n    const updateTag = useCallback(async (id, tagData) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tags/${id}`, {\r\n            method: 'PUT',\r\n            body: JSON.stringify(tagData)\r\n        });\r\n        if (!res.ok) throw new Error('Failed to update tag');\r\n        await refreshTags();\r\n    }, [authFetch, refreshTags]);\r\n\r\n    const deleteTag = useCallback(async (id) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tags/${id}`, {\r\n            method: 'DELETE'\r\n        });\r\n        if (!res.ok) throw new Error('Failed to delete tag');\r\n        setTagGroups(prev => prev.map(g => ({\r\n            ...g,\r\n            tags: g.tags.filter(t => t.id !== id)\r\n        })));\r\n    }, [authFetch]);\r\n\r\n    const updateProjectTags = useCallback(async (projectId, tags) => {\r\n        const res = await authFetch(`${API_BASE}/projects/${projectId}/tags`, {\r\n            method: 'PUT',\r\n            body: JSON.stringify({ tags })\r\n        });\r\n        if (!res.ok) {\r\n            const errData = await res.json().catch(() => ({}));\r\n            throw new Error(errData.error || 'Failed to update project tags');\r\n        }\r\n        // Optimistically update the project's tags in state\r\n        setProjects(prev => prev.map(p => {\r\n            if (p.id === projectId) {\r\n                // We need to resolve tag names from tagGroups\r\n                const allTags = tagGroups.flatMap(g => g.tags);\r\n                const resolvedTags = tags.map(t => {\r\n                    const tag = allTags.find(at => at.id === t.tagId);\r\n                    return tag ? {\r\n                        tagId: t.tagId,\r\n                        name: tag.name,\r\n                        slug: tag.slug,\r\n                        color: tag.color,\r\n                        groupId: tag.groupId,\r\n                        isPrimary: t.isPrimary,\r\n                        tagStatus: tag.status\r\n                    } : null;\r\n                }).filter(Boolean);\r\n                return { ...p, tags: resolvedTags };\r\n            }\r\n            return p;\r\n        }));\r\n        return true;\r\n    }, [authFetch, tagGroups]);\r\n\r\n    // Show loading state\r\n    if (loading) {\r\n        return (\r\n            <div style={{\r\n                display: 'flex',\r\n                justifyContent: 'center',\r\n                alignItems: 'center',\r\n                height: '100vh',\r\n                color: 'var(--text-secondary)'\r\n            }}>\r\n                Loading data from database...\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Show error state\r\n    if (error) {\r\n        const isAuthError = typeof error === 'string' && (error.includes('401') || error.includes('Session'));\r\n\r\n        return (\r\n            <div style={{\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                justifyContent: 'center',\r\n                alignItems: 'center',\r\n                height: '100vh',\r\n                gap: '1rem',\r\n                color: 'var(--text-secondary)'\r\n            }}>\r\n                {isAuthError ? (\r\n                    <>\r\n                        <h2 style={{ color: '#f59e0b' }}>Session Expired</h2>\r\n                        <p>Your session has expired or is invalid. Please sign in again.</p>\r\n                        <button\r\n                            onClick={() => instance.loginRedirect(apiRequest)}\r\n                            style={{\r\n                                padding: '0.6rem 1.2rem',\r\n                                background: '#2563eb',\r\n                                color: 'white',\r\n                                border: 'none',\r\n                                borderRadius: '6px',\r\n                                fontSize: '1rem',\r\n                                cursor: 'pointer',\r\n                                marginTop: '0.5rem',\r\n                                fontWeight: '500'\r\n                            }}\r\n                        >\r\n                            Sign In Again\r\n                        </button>\r\n                    </>\r\n                ) : (\r\n                    <>\r\n                        <h2 style={{ color: '#ef4444' }}>Connection Error</h2>\r\n                        <p><strong>Error:</strong> {error}</p>\r\n                        <div style={{ fontSize: '0.9rem', color: '#666' }}>\r\n                            <p>Possible causes:</p>\r\n                            <ul style={{ listStyle: 'none', padding: 0 }}>\r\n                                <li>1. Backend server is not running on port 3001</li>\r\n                                <li>2. Authentication failed (401 Unauthorized)</li>\r\n                                <li>3. Network/CORS connectivity issue</li>\r\n                            </ul>\r\n                        </div>\r\n                        <p>Make sure the API server is running on port 3001</p>\r\n                        <code>cd server && npm start</code>\r\n                    </>\r\n                )}\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <DataContext.Provider value={{\r\n            goals: goalsWithProgress,\r\n            addGoal, updateGoal, deleteGoal,\r\n            addKpi, updateKpi, deleteKpi,\r\n            projects: projectsWithCompletion,\r\n            projectsPagination,\r\n            loadMoreProjects,\r\n            loading,\r\n            loadingMore,\r\n            moveTask, addTask, addProject, updateProject, deleteProject, loadProjectDetails,\r\n            updateTask, deleteTask,\r\n            intakeForms, addIntakeForm, updateIntakeForm, deleteIntakeForm,\r\n            intakeSubmissions, mySubmissions, addIntakeSubmission, updateIntakeSubmission,\r\n            addConversationMessage, markConversationRead, migrateInfoRequestsToConversation, convertSubmissionToProject,\r\n            addStatusReport, getLatestStatusReport, restoreStatusReport,\r\n            authFetch, fetchExecSummaryProjects,\r\n\r\n            permissions, hasPermission, updatePermissionsBulk,\r\n\r\n            tagGroups, addTagGroup, updateTagGroup, deleteTagGroup,\r\n            addTag, updateTag, deleteTag, updateProjectTags\r\n        }}>\r\n            {children}\r\n        </DataContext.Provider>\r\n    );\r\n}\r\n\r\nexport const useData = () => useContext(DataContext);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\context\\ThemeContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":30,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":30,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useEffect, useState } from 'react';\r\n\r\nconst ThemeContext = createContext();\r\n\r\nexport function ThemeProvider({ children }) {\r\n    const [theme, setTheme] = useState(() => {\r\n        // Check local storage or system preference\r\n        const saved = localStorage.getItem('theme');\r\n        if (saved) return saved;\r\n        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';\r\n    });\r\n\r\n    useEffect(() => {\r\n        // Apply theme to document\r\n        document.documentElement.setAttribute('data-theme', theme);\r\n        localStorage.setItem('theme', theme);\r\n    }, [theme]);\r\n\r\n    const toggleTheme = () => {\r\n        setTheme(prev => prev === 'light' ? 'dark' : 'light');\r\n    };\r\n\r\n    return (\r\n        <ThemeContext.Provider value={{ theme, toggleTheme }}>\r\n            {children}\r\n        </ThemeContext.Provider>\r\n    );\r\n}\r\n\r\nexport const useTheme = () => useContext(ThemeContext);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\context\\ToastContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":5,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":5,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useState, useCallback } from 'react';\r\n\r\nconst ToastContext = createContext();\r\n\r\nexport function useToast() {\r\n    const context = useContext(ToastContext);\r\n    if (!context) {\r\n        throw new Error('useToast must be used within a ToastProvider');\r\n    }\r\n    return context;\r\n}\r\n\r\nexport function ToastProvider({ children }) {\r\n    const [toasts, setToasts] = useState([]);\r\n\r\n    const addToast = useCallback((message, type = 'success', duration = 3000) => {\r\n        const id = Date.now() + Math.random();\r\n        const toast = { id, message, type };\r\n\r\n        setToasts(prev => [...prev, toast]);\r\n\r\n        // Auto-remove after duration\r\n        setTimeout(() => {\r\n            setToasts(prev => prev.filter(t => t.id !== id));\r\n        }, duration);\r\n\r\n        return id;\r\n    }, []);\r\n\r\n    const removeToast = useCallback((id) => {\r\n        setToasts(prev => prev.filter(t => t.id !== id));\r\n    }, []);\r\n\r\n    // Convenience methods\r\n    const success = useCallback((message, duration) => addToast(message, 'success', duration), [addToast]);\r\n    const error = useCallback((message, duration) => addToast(message, 'error', duration), [addToast]);\r\n    const info = useCallback((message, duration) => addToast(message, 'info', duration), [addToast]);\r\n    const warning = useCallback((message, duration) => addToast(message, 'warning', duration), [addToast]);\r\n\r\n    return (\r\n        <ToastContext.Provider value={{ toasts, addToast, removeToast, success, error, info, warning }}>\r\n            {children}\r\n        </ToastContext.Provider>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\hooks\\useAuth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\utils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\vite.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]