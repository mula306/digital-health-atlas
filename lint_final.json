[{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\auth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\db.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\middleware\\authMiddleware.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\admin.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\dashboard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\goals.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\intake.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\kpis.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\projects.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\tags.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\routes\\tasks.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\run_audit_migration.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\run_migration.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\scripts\\restore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\scripts\\seed_performance.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\scripts\\snapshot.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\auditLogger.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\cache.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\errorHandler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\seedPermissions.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\server\\utils\\sqlHelpers.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\App.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\apiClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\authConfig.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Admin\\AdminPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Admin\\AuditLogView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Admin\\TagManager.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\AppContent.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Auth\\LoginPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Dashboard\\Dashboard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Dashboard\\ExecDashboard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\AddGoalForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\EditGoalForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\GoalItem.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\GoalView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Goals\\KPIManager.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\IntakeFormBuilder.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\IntakeFormView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\IntakePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\IntakeRequestsList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Intake\\MySubmissionsList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\AddProjectForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\AddTaskForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\CalendarView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\EditProjectForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\GanttView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\KanbanBoard.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  72 |             // If task exists and has changed, update local state\n  73 |             if (updatedTask && JSON.stringify(updatedTask) !== JSON.stringify(selectedTask)) {\n> 74 |                 setSelectedTask(updatedTask);\n     |                 ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  75 |             }\n  76 |         }\n  77 |     }, [project.tasks, selectedTask]);","line":74,"column":17,"nodeType":null,"endLine":74,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useMemo } from 'react';\r\nimport { Settings, LayoutGrid, Table, GanttChart, FileText, Calendar, Activity } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { KanbanColumn } from './KanbanColumn';\r\nimport { TaskTableView } from './TaskTableView';\r\nimport { GanttView } from './GanttView';\r\nimport { CalendarView } from './CalendarView';\r\nimport { StatusReportPage } from '../StatusReport/StatusReportPage';\r\nimport { Modal } from '../UI/Modal';\r\nimport { AddTaskForm } from './AddTaskForm';\r\nimport { EditProjectForm } from './EditProjectForm';\r\nimport { TaskDetailPanel } from './TaskDetailPanel';\r\nimport { ProjectActivityFeed } from './ProjectActivityFeed';\r\nimport './Kanban.css';\r\n\r\nconst COLUMNS = [\r\n    { id: 'todo', title: 'To Do', color: 'var(--text-secondary)' },\r\n    { id: 'in-progress', title: 'In Progress', color: '#3b82f6' },\r\n    { id: 'review', title: 'Review', color: '#8b5cf6' },\r\n    { id: 'done', title: 'Done', color: '#10b981' }\r\n];\r\n\r\nconst PRIORITY_ORDER = { high: 0, medium: 1, low: 2 };\r\n\r\nimport { useAuth } from '../../hooks/useAuth';\r\n\r\nexport function KanbanBoard({ project, onBack, goalTitle }) {\r\n    const { moveTask: _moveTask } = useData();\r\n    const { canEdit } = useAuth();\r\n    const [showAddModal, setShowAddModal] = useState(false);\r\n    const [showEditModal, setShowEditModal] = useState(false);\r\n    const [selectedTask, setSelectedTask] = useState(null);\r\n    const [viewMode, setViewMode] = useState('table'); // 'table', 'gantt', 'kanban', 'reports'\r\n\r\n    const sortTasks = useCallback((tasks) => {\r\n        return [...tasks].sort((a, b) => {\r\n            const priorityDiff = (PRIORITY_ORDER[a.priority] || 2) - (PRIORITY_ORDER[b.priority] || 2);\r\n            if (priorityDiff !== 0) return priorityDiff;\r\n            // Use endDate, fallback to dueDate for legacy support\r\n            const aEnd = a.endDate || a.dueDate;\r\n            const bEnd = b.endDate || b.dueDate;\r\n            if (aEnd && bEnd) return new Date(aEnd) - new Date(bEnd);\r\n            if (aEnd) return -1;\r\n            if (bEnd) return 1;\r\n            return 0;\r\n        });\r\n    }, []);\r\n\r\n    const tasksByStatus = useMemo(() => {\r\n        return COLUMNS.reduce((acc, col) => {\r\n            const columnTasks = (project.tasks || []).filter(t => t.status === col.id);\r\n            acc[col.id] = sortTasks(columnTasks);\r\n            return acc;\r\n        }, {});\r\n    }, [project.tasks, sortTasks]);\r\n\r\n    const handleEditClose = useCallback((wasDeleted) => {\r\n        setShowEditModal(false);\r\n        if (wasDeleted) {\r\n            onBack();\r\n        }\r\n    }, [onBack]);\r\n\r\n    const handleTaskClick = useCallback((task) => {\r\n        setSelectedTask(task);\r\n    }, []);\r\n\r\n    // Keep selectedTask in sync with project updates (e.g. after editing)\r\n    useEffect(() => {\r\n        if (selectedTask) {\r\n            const updatedTask = project.tasks.find(t => t.id === selectedTask.id);\r\n            // If task exists and has changed, update local state\r\n            if (updatedTask && JSON.stringify(updatedTask) !== JSON.stringify(selectedTask)) {\r\n                setSelectedTask(updatedTask);\r\n            }\r\n        }\r\n    }, [project.tasks, selectedTask]);\r\n\r\n    return (\r\n        <div className=\"kanban-board-container\">\r\n            <div className=\"board-header\">\r\n                <button onClick={onBack} className=\"back-btn\">‚Üê Projects</button>\r\n                <div className=\"board-title\">\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>\r\n                        <h2>{project.title}</h2>\r\n                        {canEdit && (\r\n                            <button\r\n                                onClick={() => setShowEditModal(true)}\r\n                                className=\"icon-btn\"\r\n                                title=\"Edit Project\"\r\n                            >\r\n                                <Settings size={18} />\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                    <div className=\"board-meta\">\r\n                        <span className=\"meta-item\">üéØ {goalTitle || 'Unlinked'}</span>\r\n                        <span className=\"meta-divider\">‚Ä¢</span>\r\n                        <span className=\"meta-item\">{project.completion}% Complete</span>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"board-actions\">\r\n                    {/* View Toggle */}\r\n                    <div className=\"view-toggle\">\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'table' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('table')}\r\n                            title=\"Table View\"\r\n                        >\r\n                            <Table size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'calendar' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('calendar')}\r\n                            title=\"Calendar View\"\r\n                        >\r\n                            <Calendar size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'gantt' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('gantt')}\r\n                            title=\"Gantt View\"\r\n                        >\r\n                            <GanttChart size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'kanban' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('kanban')}\r\n                            title=\"Kanban View\"\r\n                        >\r\n                            <LayoutGrid size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'reports' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('reports')}\r\n                            title=\"Status Reports\"\r\n                        >\r\n                            <FileText size={18} />\r\n                        </button>\r\n                        <button\r\n                            className={`view-toggle-btn ${viewMode === 'activity' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('activity')}\r\n                            title=\"Activity History\"\r\n                        >\r\n                            <Activity size={18} />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {viewMode !== 'reports' && viewMode !== 'activity' && canEdit && (\r\n                        <button className=\"btn-primary\" onClick={() => setShowAddModal(true)}>New Task</button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {viewMode === 'kanban' && (\r\n                <div className=\"kanban-columns\">\r\n                    {COLUMNS.map(col => (\r\n                        <KanbanColumn\r\n                            key={col.id}\r\n                            column={col}\r\n                            tasks={tasksByStatus[col.id] || []}\r\n                            projectId={project.id}\r\n                            onTaskClick={handleTaskClick}\r\n                        />\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {viewMode === 'table' && (\r\n                <TaskTableView\r\n                    project={project}\r\n                    onTaskClick={handleTaskClick}\r\n                />\r\n            )}\r\n\r\n            {viewMode === 'calendar' && (\r\n                <CalendarView\r\n                    project={project}\r\n                    onTaskClick={handleTaskClick}\r\n                />\r\n            )}\r\n\r\n            {viewMode === 'gantt' && (\r\n                <GanttView\r\n                    project={project}\r\n                    onTaskClick={handleTaskClick}\r\n                />\r\n            )}\r\n\r\n            {viewMode === 'reports' && (\r\n                <StatusReportPage\r\n                    project={project}\r\n                    onClose={() => setViewMode('kanban')}\r\n                />\r\n            )}\r\n\r\n            {viewMode === 'activity' && (\r\n                <ProjectActivityFeed projectId={project.id} />\r\n            )}\r\n\r\n            <Modal\r\n                isOpen={showAddModal}\r\n                onClose={() => setShowAddModal(false)}\r\n                title={`Add Task to ${project.title}`}\r\n                closeOnOverlayClick={false}\r\n            >\r\n                <AddTaskForm onClose={() => setShowAddModal(false)} projectId={project.id} />\r\n            </Modal>\r\n\r\n            <Modal\r\n                isOpen={showEditModal}\r\n                onClose={handleEditClose}\r\n                title=\"Edit Project\"\r\n                size=\"large\"\r\n                closeOnOverlayClick={false}\r\n            >\r\n                <EditProjectForm project={project} onClose={handleEditClose} />\r\n            </Modal>\r\n\r\n            {selectedTask && (\r\n                <TaskDetailPanel\r\n                    task={selectedTask}\r\n                    projectId={project.id}\r\n                    onClose={() => setSelectedTask(null)}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\KanbanCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\KanbanColumn.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\KanbanView.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'hasActiveFilters'. Either include it or remove the dependency array.","line":104,"column":8,"nodeType":"ArrayExpression","endLine":104,"endColumn":83,"suggestions":[{"desc":"Update the dependencies array to be: [goalFilter, selectedTags, searchTerm, goals, authFetch, buildFilterParams, hasActiveFilters]","fix":{"range":[4310,4385],"text":"[goalFilter, selectedTags, searchTerm, goals, authFetch, buildFilterParams, hasActiveFilters]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { KanbanBoard } from './KanbanBoard';\r\nimport { Plus, Folder, Target, Search, X } from 'lucide-react';\r\nimport { Modal } from '../UI/Modal';\r\nimport { AddProjectForm } from './AddProjectForm';\r\nimport { getDescendantGoalIds } from '../UI/CascadingGoalFilter';\r\nimport { FilterBar } from '../UI/FilterBar';\r\nimport { ProjectTagBadges } from '../UI/ProjectTagSelector';\r\nimport './KanbanView.css';\r\n\r\nimport { useAuth } from '../../hooks/useAuth';\r\n\r\nimport { API_BASE } from '../../apiClient';\r\n\r\nexport default function KanbanView({ initialGoalFilter, onClearFilter }) {\r\n    const { projects, goals, loadProjectDetails, loading, loadMoreProjects, projectsPagination, loadingMore, authFetch } = useData();\r\n    const { canEdit } = useAuth();\r\n\r\n    // Persist selected project to survive remounts/refresh\r\n    const [selectedProjectId, setSelectedProjectIdState] = useState(() => {\r\n        const saved = localStorage.getItem('dha_selected_project_id');\r\n        return saved || null;\r\n    });\r\n\r\n    const setSelectedProjectId = (id) => {\r\n        if (id) {\r\n            localStorage.setItem('dha_selected_project_id', id);\r\n        } else {\r\n            localStorage.removeItem('dha_selected_project_id');\r\n        }\r\n        setSelectedProjectIdState(id);\r\n    };\r\n\r\n    const [showProjectModal, setShowProjectModal] = useState(false);\r\n    const [goalFilter, setGoalFilter] = useState(initialGoalFilter || '');\r\n    const [selectedTags, setSelectedTags] = useState([]);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [isLoadingDetails, setIsLoadingDetails] = useState(false);\r\n\r\n    // Server-side filtered projects state\r\n    const [filteredServerProjects, setFilteredServerProjects] = useState(null);\r\n    const [filteredPagination, setFilteredPagination] = useState(null);\r\n    const [filterLoading, setFilterLoading] = useState(false);\r\n    const [filteredLoadingMore, setFilteredLoadingMore] = useState(false);\r\n\r\n    const hasActiveFilters = !!(goalFilter || selectedTags.length > 0 || searchTerm.trim());\r\n\r\n    // Sync with external filter changes\r\n    useEffect(() => {\r\n        if (initialGoalFilter) {\r\n            setGoalFilter(initialGoalFilter);\r\n        }\r\n    }, [initialGoalFilter]);\r\n\r\n    // Build filter query params (shared by initial fetch and load-more)\r\n    const buildFilterParams = useCallback((page = 1) => {\r\n        const params = new URLSearchParams({ page: String(page), limit: '100' });\r\n        if (goalFilter) {\r\n            const descendantIds = getDescendantGoalIds(goals, goalFilter);\r\n            const allGoalIds = [String(goalFilter), ...descendantIds.map(String)];\r\n            params.set('goalIds', allGoalIds.join(','));\r\n        }\r\n        if (selectedTags.length > 0) {\r\n            params.set('tagIds', selectedTags.join(','));\r\n        }\r\n        if (searchTerm.trim()) {\r\n            params.set('search', searchTerm.trim());\r\n        }\r\n        return params;\r\n    }, [goalFilter, selectedTags, searchTerm, goals]);\r\n\r\n    // Fetch filtered projects from server when filters change\r\n    useEffect(() => {\r\n        if (!hasActiveFilters) {\r\n            setFilteredServerProjects(null);\r\n            setFilteredPagination(null);\r\n            return;\r\n        }\r\n\r\n        let cancelled = false;\r\n        async function fetchFiltered() {\r\n            setFilterLoading(true);\r\n            try {\r\n                const params = buildFilterParams(1);\r\n                const res = await authFetch(`${API_BASE}/projects?${params.toString()}`);\r\n                if (!res.ok) throw new Error('Failed to fetch filtered projects');\r\n                const data = await res.json();\r\n\r\n                if (!cancelled) {\r\n                    setFilteredServerProjects(data.projects || []);\r\n                    setFilteredPagination(data.pagination || null);\r\n                }\r\n            } catch (err) {\r\n                console.error('Error fetching filtered projects:', err);\r\n                if (!cancelled) setFilteredServerProjects([]);\r\n            } finally {\r\n                if (!cancelled) setFilterLoading(false);\r\n            }\r\n        }\r\n\r\n        fetchFiltered();\r\n        return () => { cancelled = true; };\r\n    }, [goalFilter, selectedTags, searchTerm, goals, authFetch, buildFilterParams]);\r\n\r\n    // Load more filtered projects\r\n    const loadMoreFilteredProjects = useCallback(async () => {\r\n        if (!filteredPagination?.hasMore || filteredLoadingMore) return;\r\n        setFilteredLoadingMore(true);\r\n        try {\r\n            const nextPage = filteredPagination.page + 1;\r\n            const params = buildFilterParams(nextPage);\r\n            const res = await authFetch(`${API_BASE}/projects?${params.toString()}`);\r\n            if (!res.ok) throw new Error('Failed to load more filtered projects');\r\n            const data = await res.json();\r\n            setFilteredServerProjects(prev => [...(prev || []), ...(data.projects || [])]);\r\n            setFilteredPagination(data.pagination || null);\r\n        } catch (err) {\r\n            console.error('Error loading more filtered projects:', err);\r\n        } finally {\r\n            setFilteredLoadingMore(false);\r\n        }\r\n    }, [filteredPagination, filteredLoadingMore, buildFilterParams, authFetch]);\r\n\r\n    // Load full details when a project is selected\r\n    useEffect(() => {\r\n        if (selectedProjectId) {\r\n            const project = projects.find(p => p.id == selectedProjectId);\r\n            if (project && !project._detailsLoaded) {\r\n                setIsLoadingDetails(true);\r\n                loadProjectDetails(selectedProjectId).finally(() => {\r\n                    setIsLoadingDetails(false);\r\n                });\r\n            }\r\n        }\r\n    }, [selectedProjectId, projects, loadProjectDetails]);\r\n\r\n    const selectedProject = projects.find(p => p.id == selectedProjectId);\r\n\r\n    // Use server-filtered projects when filters are active, otherwise global paginated projects\r\n    const displayProjects = hasActiveFilters ? (filteredServerProjects || []) : projects;\r\n\r\n    // Get goal title by ID\r\n    const getGoalTitle = (goalId) => {\r\n        const goal = goals.find(g => g.id === goalId);\r\n        return goal ? goal.title : 'Unlinked';\r\n    };\r\n\r\n    const handleFilterChange = (newGoalId) => {\r\n        setGoalFilter(newGoalId);\r\n        if (!newGoalId && onClearFilter) onClearFilter();\r\n    };\r\n\r\n    // Show loading state if we have a selected ID but no project found yet (likely initial load)\r\n    if (selectedProjectId && !selectedProject) {\r\n        if (loading) {\r\n            return (\r\n                <div className=\"flex justify-center items-center h-full\">\r\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600\"></div>\r\n                    <span className=\"ml-2 text-gray-500\">Restoring project...</span>\r\n                </div>\r\n            );\r\n        }\r\n    }\r\n\r\n    if (selectedProject) {\r\n        if (isLoadingDetails) {\r\n            return (\r\n                <div className=\"flex justify-center items-center h-64\">\r\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600\"></div>\r\n                    <span className=\"ml-2 text-gray-500\">Loading project details...</span>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        return (\r\n            <KanbanBoard\r\n                project={selectedProject}\r\n                onBack={() => setSelectedProjectId(null)}\r\n                goalTitle={getGoalTitle(selectedProject.goalId)}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"kanban-view\">\r\n            <div className=\"view-header\">\r\n                <div>\r\n                    <h2>Projects</h2>\r\n                    <p className=\"view-subtitle\">Manage tasks across your initiatives.</p>\r\n                </div>\r\n                <div className=\"header-actions\">\r\n                    <div className=\"search-bar\">\r\n                        <Search size={18} />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"Search projects...\"\r\n                            value={searchTerm}\r\n                            onChange={e => setSearchTerm(e.target.value)}\r\n                        />\r\n                    </div>\r\n                    {canEdit && (\r\n                        <button className=\"btn-primary\" onClick={() => setShowProjectModal(true)}>\r\n                            <Plus size={18} />\r\n                            New Project\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Filters */}\r\n            <FilterBar\r\n                goalFilter={goalFilter}\r\n                onGoalFilterChange={handleFilterChange}\r\n                selectedTags={selectedTags}\r\n                onTagsChange={setSelectedTags}\r\n                countLabel={hasActiveFilters\r\n                    ? `${displayProjects.length} of ${filteredPagination?.total || displayProjects.length} project(s)`\r\n                    : `${displayProjects.length} project(s)`\r\n                }\r\n            >\r\n                {searchTerm && (\r\n                    <button className=\"btn-secondary btn-sm shared-clear-btn\" onClick={() => setSearchTerm('')}>\r\n                        <X size={14} /> Clear Search\r\n                    </button>\r\n                )}\r\n            </FilterBar>\r\n\r\n            {filterLoading && (\r\n                <div className=\"filter-loading-indicator\" style={{ textAlign: 'center', padding: '1rem', color: 'var(--text-secondary)' }}>\r\n                    Loading filtered projects...\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"projects-grid\">\r\n                {displayProjects.length === 0 && !filterLoading ? (\r\n                    <div className=\"empty-state glass\">\r\n                        <p>No projects found{goalFilter ? ' for this goal' : ''}.</p>\r\n                    </div>\r\n                ) : (\r\n                    displayProjects.map(project => (\r\n                        <div\r\n                            key={project.id}\r\n                            className=\"project-card\"\r\n                            onClick={() => setSelectedProjectId(project.id)}\r\n                        >\r\n                            <div className=\"project-card-header\">\r\n                                <div className=\"project-icon\">\r\n                                    <Folder size={22} />\r\n                                </div>\r\n                                <span className=\"project-task-count\">\r\n                                    {project.taskCount || project.tasks?.length || 0} Tasks\r\n                                </span>\r\n                            </div>\r\n\r\n                            <h3 className=\"project-title\">{project.title}</h3>\r\n                            <p className=\"project-description\">{project.description || 'No description'}</p>\r\n\r\n                            {project.tags && project.tags.length > 0 && (\r\n                                <ProjectTagBadges tags={project.tags} maxDisplay={3} />\r\n                            )}\r\n\r\n                            <div className=\"project-goal-link\">\r\n                                <Target size={14} />\r\n                                <span>{getGoalTitle(project.goalId)}</span>\r\n                            </div>\r\n\r\n                            <div className=\"project-progress\">\r\n                                <div className=\"progress-bar-track\">\r\n                                    <div\r\n                                        className=\"progress-bar-fill\"\r\n                                        style={{ width: `${project.completion || 0}%` }}\r\n                                    ></div>\r\n                                </div>\r\n                                <span className=\"progress-label\">{project.completion || 0}% Complete</span>\r\n                            </div>\r\n                        </div>\r\n                    ))\r\n                )}\r\n            </div>\r\n\r\n            {/* Pagination Controls */}\r\n            <div className=\"pagination-controls-wrapper\">\r\n                <div className=\"pagination-info\">\r\n                    Showing {displayProjects.length} of {hasActiveFilters ? (filteredPagination?.total || displayProjects.length) : (projectsPagination?.total || 0)} projects\r\n                </div>\r\n\r\n                {hasActiveFilters ? (\r\n                    filteredPagination?.hasMore && (\r\n                        <button\r\n                            className=\"btn-secondary load-more-btn\"\r\n                            onClick={loadMoreFilteredProjects}\r\n                            disabled={filteredLoadingMore}\r\n                        >\r\n                            {filteredLoadingMore ? (\r\n                                <span className=\"flex items-center\">\r\n                                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2\"></div>\r\n                                    Loading...\r\n                                </span>\r\n                            ) : (\r\n                                'Load More Projects'\r\n                            )}\r\n                        </button>\r\n                    )\r\n                ) : (\r\n                    projectsPagination?.hasMore && (\r\n                        <button\r\n                            className=\"btn-secondary load-more-btn\"\r\n                            onClick={loadMoreProjects}\r\n                            disabled={loadingMore}\r\n                        >\r\n                            {loadingMore ? (\r\n                                <span className=\"flex items-center\">\r\n                                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2\"></div>\r\n                                    Loading...\r\n                                </span>\r\n                            ) : (\r\n                                'Load More Projects'\r\n                            )}\r\n                        </button>\r\n                    )\r\n                )}\r\n            </div>\r\n\r\n            <Modal\r\n                isOpen={showProjectModal}\r\n                onClose={() => setShowProjectModal(false)}\r\n                title=\"Create New Project\"\r\n            >\r\n                <AddProjectForm onClose={() => setShowProjectModal(false)} />\r\n            </Modal>\r\n        </div>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\ProjectActivityFeed.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\TaskDetailPanel.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  44 |     // Sync state with task props when they change\n  45 |     useEffect(() => {\n> 46 |         setTitle(task.title);\n     |         ^^^^^^^^ Avoid calling setState() directly within an effect\n  47 |         setDescription(task.description || '');\n  48 |         setPriority(task.priority);\n  49 |         setStatus(task.status || 'todo');","line":46,"column":9,"nodeType":null,"endLine":46,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { X, Calendar, Flag, Clock, Edit, Trash2, AlignLeft, CheckCircle2 } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { useToast } from '../../context/ToastContext';\r\nimport './TaskDetail.css';\r\n\r\nimport { useAuth } from '../../hooks/useAuth';\r\n\r\nexport function TaskDetailPanel({ task, projectId, onClose }) {\r\n    const { updateTask, deleteTask } = useData();\r\n    const { success } = useToast();\r\n    const { canEdit, canDelete } = useAuth();\r\n    const [isEditing, setIsEditing] = useState(false);\r\n\r\n    // Helper to format date for input (YYYY-MM-DD)\r\n    // - Preserves YYYY-MM-DD strings as-is\r\n    // - Converts ISO strings using UTC components to avoid timezone shift\r\n    const formatDateForInput = (dateStr) => {\r\n        if (!dateStr) return '';\r\n        try {\r\n            if (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr)) {\r\n                return dateStr;\r\n            }\r\n\r\n            const date = new Date(dateStr);\r\n            // Use UTC methods to ensure we get the date as stored on server\r\n            const year = date.getUTCFullYear();\r\n            const month = String(date.getUTCMonth() + 1).padStart(2, '0');\r\n            const day = String(date.getUTCDate()).padStart(2, '0');\r\n            return `${year}-${month}-${day}`;\r\n        } catch (_e) {\r\n            return '';\r\n        }\r\n    };\r\n\r\n    const [title, setTitle] = useState(task.title);\r\n    const [description, setDescription] = useState(task.description || '');\r\n    const [priority, setPriority] = useState(task.priority);\r\n    const [status, setStatus] = useState(task.status || 'todo');\r\n    const [startDate, setStartDate] = useState(formatDateForInput(task.startDate || task.dueDate));\r\n    const [endDate, setEndDate] = useState(formatDateForInput(task.endDate || task.dueDate));\r\n    const [confirmDelete, setConfirmDelete] = useState(false);\r\n\r\n    // Sync state with task props when they change\r\n    useEffect(() => {\r\n        setTitle(task.title);\r\n        setDescription(task.description || '');\r\n        setPriority(task.priority);\r\n        setStatus(task.status || 'todo');\r\n        setStartDate(formatDateForInput(task.startDate || task.dueDate));\r\n        setEndDate(formatDateForInput(task.endDate || task.dueDate));\r\n    }, [task]);\r\n\r\n    const handleSave = async () => {\r\n        await updateTask(projectId, task.id, {\r\n            title,\r\n            description,\r\n            priority,\r\n            status,\r\n            startDate: startDate || null,\r\n            endDate: endDate || null\r\n        });\r\n        success('Task updated successfully');\r\n        setIsEditing(false);\r\n    };\r\n\r\n    const handleDelete = () => {\r\n        if (confirmDelete) {\r\n            deleteTask(projectId, task.id);\r\n            success('Task deleted');\r\n            onClose();\r\n        } else {\r\n            setConfirmDelete(true);\r\n        }\r\n    };\r\n\r\n    // Helper to format date for display without UTC shift\r\n    const formatDateForDisplay = (dateStr) => {\r\n        if (!dateStr) return 'Not set';\r\n        try {\r\n            // If strictly YYYY-MM-DD\r\n            if (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr)) {\r\n                const [year, month, day] = dateStr.split('-').map(Number);\r\n                // Create local date at midnight\r\n                const date = new Date(year, month - 1, day);\r\n                return date.toLocaleDateString();\r\n            }\r\n            // For ISO strings, use UTC timezone to prevent shift\r\n            return new Date(dateStr).toLocaleDateString(undefined, { timeZone: 'UTC' });\r\n        } catch (_e) {\r\n            return dateStr;\r\n        }\r\n    };\r\n\r\n\r\n    const priorityColors = {\r\n        high: '#ef4444',\r\n        medium: '#f59e0b',\r\n        low: '#10b981'\r\n    };\r\n\r\n    const statusColors = {\r\n        'todo': '#64748b',\r\n        'in-progress': '#3b82f6',\r\n        'review': '#8b5cf6',\r\n        'done': '#22c55e'\r\n    };\r\n\r\n    const statusLabels = {\r\n        'todo': 'To Do',\r\n        'in-progress': 'In Progress',\r\n        'review': 'Review',\r\n        'done': 'Done'\r\n    };\r\n\r\n    // Get display dates (support legacy dueDate field)\r\n    const displayStartDate = task.startDate || task.dueDate;\r\n    const displayEndDate = task.endDate || task.dueDate;\r\n    const currentStatus = task.status || 'todo';\r\n\r\n    return (\r\n        <div className=\"task-detail-overlay\" onClick={onClose}>\r\n            <div className=\"task-detail-panel\" onClick={e => e.stopPropagation()}>\r\n                <div className=\"panel-header\">\r\n                    <h3>{isEditing ? 'Edit Task' : 'Task Details'}</h3>\r\n                    <button className=\"close-btn\" onClick={onClose}>\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"panel-content\">\r\n                    {isEditing ? (\r\n                        <>\r\n                            <div className=\"form-group\">\r\n                                <label>Title</label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={title}\r\n                                    onChange={e => setTitle(e.target.value)}\r\n                                    className=\"form-input\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label>Description</label>\r\n                                <textarea\r\n                                    value={description}\r\n                                    onChange={e => setDescription(e.target.value)}\r\n                                    className=\"form-textarea\"\r\n                                    rows={3}\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-row\">\r\n                                <div className=\"form-group\">\r\n                                    <label>Status</label>\r\n                                    <select value={status} onChange={e => setStatus(e.target.value)} className=\"form-select\">\r\n                                        <option value=\"todo\">To Do</option>\r\n                                        <option value=\"in-progress\">In Progress</option>\r\n                                        <option value=\"review\">Review</option>\r\n                                        <option value=\"done\">Done</option>\r\n                                    </select>\r\n                                </div>\r\n                                <div className=\"form-group\">\r\n                                    <label>Priority</label>\r\n                                    <select value={priority} onChange={e => setPriority(e.target.value)} className=\"form-select\">\r\n                                        <option value=\"low\">Low</option>\r\n                                        <option value=\"medium\">Medium</option>\r\n                                        <option value=\"high\">High</option>\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"form-row\">\r\n                                <div className=\"form-group\">\r\n                                    <label>Start Date</label>\r\n                                    <input\r\n                                        type=\"date\"\r\n                                        value={startDate}\r\n                                        onChange={e => setStartDate(e.target.value)}\r\n                                        className=\"form-input\"\r\n                                    />\r\n                                </div>\r\n                                <div className=\"form-group\">\r\n                                    <label>End Date</label>\r\n                                    <input\r\n                                        type=\"date\"\r\n                                        value={endDate}\r\n                                        onChange={e => setEndDate(e.target.value)}\r\n                                        className=\"form-input\"\r\n                                        min={startDate}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            <h2 className=\"task-title-display\">{task.title}</h2>\r\n\r\n                            <div className=\"meta-grid\">\r\n                                <div className=\"meta-item\">\r\n                                    <span className=\"meta-label\">Status</span>\r\n                                    <div className=\"meta-value\">\r\n                                        <span className=\"status-badge-lg\" style={{\r\n                                            backgroundColor: `${statusColors[currentStatus]}20`,\r\n                                            color: statusColors[currentStatus]\r\n                                        }}>\r\n                                            <CheckCircle2 size={14} />\r\n                                            {statusLabels[currentStatus]}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"meta-item\">\r\n                                    <span className=\"meta-label\">Priority</span>\r\n                                    <div className=\"meta-value\">\r\n                                        <Flag size={16} style={{ color: priorityColors[task.priority] }} />\r\n                                        <span style={{ color: priorityColors[task.priority], textTransform: 'capitalize' }}>\r\n                                            {task.priority}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"meta-item\">\r\n                                    <span className=\"meta-label\">Start Date</span>\r\n                                    <div className=\"meta-value\">\r\n                                        <Calendar size={16} className=\"text-muted\" />\r\n                                        {formatDateForDisplay(displayStartDate)}\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"meta-item\">\r\n                                    <span className=\"meta-label\">Due Date</span>\r\n                                    <div className=\"meta-value\">\r\n                                        <Calendar size={16} className=\"text-muted\" />\r\n                                        {formatDateForDisplay(displayEndDate)}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"section-label\">\r\n                                <AlignLeft size={16} />\r\n                                Description\r\n                            </div>\r\n                            <div className=\"task-description-display\">\r\n                                {task.description || 'No description provided for this task.'}\r\n                            </div>\r\n                        </>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"panel-actions\">\r\n                    {isEditing ? (\r\n                        <>\r\n                            <button className=\"btn-secondary\" onClick={() => setIsEditing(false)}>Cancel</button>\r\n                            <button className=\"btn-primary\" onClick={handleSave}>Save Changes</button>\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            {canDelete && (\r\n                                <button\r\n                                    className={`btn-danger ${confirmDelete ? 'confirm' : ''}`}\r\n                                    onClick={handleDelete}\r\n                                >\r\n                                    <Trash2 size={16} />\r\n                                    {confirmDelete ? 'Confirm Delete' : 'Delete'}\r\n                                </button>\r\n                            )}\r\n                            {canEdit && (\r\n                                <button className=\"btn-primary\" onClick={() => setIsEditing(true)}>\r\n                                    <Edit size={16} />\r\n                                    Edit\r\n                                </button>\r\n                            )}\r\n                        </>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Kanban\\TaskTableView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Layout\\Layout.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  43 |     // Set initial sidebar state on mount\n  44 |     useEffect(() => {\n> 45 |         setIsSidebarOpen(window.innerWidth > 992);\n     |         ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  46 |     }, []);\n  47 |\n  48 |     const allNavItems = [","line":45,"column":9,"nodeType":null,"endLine":45,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { LayoutDashboard, Target, Folder, BarChart3, Menu, X, Inbox, FileText, Shield, TrendingUp } from 'lucide-react';\r\nimport { useState, useEffect } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { useAuth } from '../../hooks/useAuth';\r\nimport { ThemeToggle } from '../UI/ThemeToggle';\r\nimport './Layout.css';\r\n\r\n// ... UserProfile component ...\r\nfunction UserProfile() {\r\n    const { instance, account, userRoles } = useAuth();\r\n    const name = account?.name || 'User';\r\n    // Display the highest role for debugging/info\r\n    const roleDisplay = userRoles.length > 0 ? userRoles[0] : 'No Role';\r\n\r\n    const handleLogout = () => {\r\n        instance.logoutRedirect({\r\n            postLogoutRedirectUri: \"/\",\r\n            mainWindowRedirectUri: \"/\"\r\n        });\r\n    };\r\n\r\n    return (\r\n        <div className=\"user-profile\">\r\n            <div className=\"user-info\">\r\n                <span className=\"user-name\">{name}</span>\r\n                <span className=\"user-role\">{roleDisplay}</span>\r\n            </div>\r\n            <button onClick={handleLogout} className=\"sign-out-btn\">\r\n                Sign Out\r\n            </button>\r\n            <div className=\"user-avatar\">\r\n                {name.charAt(0)}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport function Layout({ children, currentView, onViewChange }) {\r\n    const [isSidebarOpen, setIsSidebarOpen] = useState(false);\r\n    const { isAppAdmin } = useAuth();\r\n    const { hasPermission } = useData();\r\n\r\n    // Set initial sidebar state on mount\r\n    useEffect(() => {\r\n        setIsSidebarOpen(window.innerWidth > 992);\r\n    }, []);\r\n\r\n    const allNavItems = [\r\n        { id: 'exec-dashboard', label: 'Executive Summary', icon: LayoutDashboard, permission: 'can_view_exec_dashboard' },\r\n        { id: 'dashboard', label: 'Dashboard', icon: BarChart3, permission: 'can_view_dashboard' },\r\n        { id: 'goals', label: 'Goals', icon: Target, permission: 'can_view_goals' },\r\n        { id: 'metrics', label: 'Metrics', icon: TrendingUp, permission: 'can_view_metrics' },\r\n        { id: 'projects', label: 'Projects', icon: Folder, permission: 'can_view_projects' },\r\n        { id: 'reports', label: 'Reports', icon: FileText, permission: 'can_view_reports' },\r\n        { id: 'intake', label: 'Intake', icon: Inbox, permission: 'can_view_intake' },\r\n    ];\r\n\r\n    const navItems = allNavItems.filter(item => {\r\n        if (!item.permission) return true;\r\n        return hasPermission(item.permission);\r\n    });\r\n\r\n    if (isAppAdmin) {\r\n        navItems.push({ id: 'admin', label: 'Admin Panel', icon: Shield });\r\n    }\r\n\r\n    const handleNavClick = (viewId) => {\r\n        onViewChange(viewId);\r\n        // Auto-close sidebar on mobile after clicking a link\r\n        if (window.innerWidth <= 992) {\r\n            setIsSidebarOpen(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"layout\">\r\n            {/* Sidebar Overlay for Mobile */}\r\n            {isSidebarOpen && window.innerWidth <= 992 && (\r\n                <div className=\"sidebar-overlay\" onClick={() => setIsSidebarOpen(false)}></div>\r\n            )}\r\n\r\n            {/* Sidebar */}\r\n            <aside className={`sidebar ${isSidebarOpen ? 'open' : 'closed'}`}>\r\n                <div className=\"sidebar-header\">\r\n                    <div className=\"logo\">\r\n                        <div className=\"logo-icon\">DHA</div>\r\n                        {/* Text removed as requested, keeping only logo icon */}\r\n                    </div>\r\n                    <button\r\n                        className=\"toggle-sidebar-btn\"\r\n                        onClick={() => setIsSidebarOpen(!isSidebarOpen)}\r\n                    >\r\n                        {isSidebarOpen ? <X size={20} /> : <Menu size={20} />}\r\n                    </button>\r\n                </div>\r\n\r\n                <nav className=\"nav-menu\">\r\n                    {navItems.map(item => (\r\n                        <button\r\n                            key={item.id}\r\n                            className={`nav-item ${currentView === item.id ? 'active' : ''}`}\r\n                            onClick={() => handleNavClick(item.id)}\r\n                        >\r\n                            <item.icon size={22} />\r\n                            {isSidebarOpen && <span>{item.label}</span>}\r\n                        </button>\r\n                    ))}\r\n                </nav>\r\n            </aside>\r\n\r\n\r\n            {/* Main Content */}\r\n            <main className=\"main-content\">\r\n                <header className=\"top-header\">\r\n                    {/* Mobile Menu Button */}\r\n                    <button\r\n                        className=\"mobile-menu-btn\"\r\n                        onClick={() => setIsSidebarOpen(!isSidebarOpen)}\r\n                        aria-label=\"Toggle Menu\"\r\n                    >\r\n                        <Menu size={24} />\r\n                    </button>\r\n\r\n                    <h2 className=\"page-title\">Digital Health Atlas</h2>\r\n\r\n                    <div className=\"header-actions\">\r\n\r\n                        <ThemeToggle />\r\n                        <UserProfile />\r\n                    </div>\r\n                </header>\r\n\r\n                <div className=\"content-scrollable\">\r\n                    {children}\r\n                </div>\r\n            </main>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Metrics\\MetricsPage.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  16 |     useEffect(() => {\n  17 |         if (initialGoalFilter) {\n> 18 |             setGoalFilter(initialGoalFilter);\n     |             ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  19 |         }\n  20 |     }, [initialGoalFilter]);\n  21 |","line":18,"column":13,"nodeType":null,"endLine":18,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { useState, useMemo, useEffect } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { getDescendantGoalIds } from '../UI/CascadingGoalFilter';\r\nimport { FilterBar } from '../UI/FilterBar';\r\nimport { TrendingUp, Target, BarChart2 } from 'lucide-react';\r\nimport { formatKpiValue } from '../../utils';\r\nimport './MetricsPage.css';\r\n\r\nexport function MetricsPage({ initialGoalFilter, onClearFilter }) {\r\n    const { goals, projects, hasPermission } = useData();\r\n    const [goalFilter, setGoalFilter] = useState(initialGoalFilter || '');\r\n    const [selectedTags, setSelectedTags] = useState([]);\r\n\r\n    // Sync with external filter changes\r\n    useEffect(() => {\r\n        if (initialGoalFilter) {\r\n            setGoalFilter(initialGoalFilter);\r\n        }\r\n    }, [initialGoalFilter]);\r\n\r\n    const handleFilterChange = (newGoalId) => {\r\n        setGoalFilter(newGoalId);\r\n        if (!newGoalId && onClearFilter) onClearFilter();\r\n    };\r\n\r\n    // Flatten all KPIs from goals into a single list with context\r\n    const allMetrics = useMemo(() => {\r\n        return goals.flatMap(goal => {\r\n            if (!goal.kpis) return [];\r\n            return goal.kpis.map(kpi => ({\r\n                ...kpi,\r\n                goalId: goal.id,\r\n                goalTitle: goal.title,\r\n                goalType: goal.type\r\n            }));\r\n        });\r\n    }, [goals]);\r\n\r\n    // Filter metrics based on cascading goal selection and tags\r\n    const filteredMetrics = useMemo(() => {\r\n        let metrics = allMetrics;\r\n\r\n        // Filter by goal\r\n        if (goalFilter) {\r\n            const descendantIds = getDescendantGoalIds(goals, goalFilter);\r\n            const relevantGoalIds = [String(goalFilter), ...descendantIds.map(String)];\r\n            metrics = metrics.filter(m => relevantGoalIds.includes(String(m.goalId)));\r\n        }\r\n\r\n        // Filter by tags: only show metrics from goals that have tagged projects\r\n        if (selectedTags.length > 0) {\r\n            // Find all goal IDs that have at least one project with a matching tag\r\n            const goalsWithTaggedProjects = new Set();\r\n            projects.forEach(p => {\r\n                if (p.tags && p.tags.some(t => selectedTags.includes(String(t.id)))) {\r\n                    if (p.goalId) goalsWithTaggedProjects.add(String(p.goalId));\r\n                }\r\n            });\r\n            // Also include ancestor goals so parent-level KPIs still show\r\n            const expandedGoalIds = new Set(goalsWithTaggedProjects);\r\n            goalsWithTaggedProjects.forEach(gId => {\r\n                let current = goals.find(g => String(g.id) === gId);\r\n                while (current && current.parentId) {\r\n                    expandedGoalIds.add(String(current.parentId));\r\n                    current = goals.find(g => String(g.id) === String(current.parentId));\r\n                }\r\n            });\r\n            metrics = metrics.filter(m => expandedGoalIds.has(String(m.goalId)));\r\n        }\r\n\r\n        return metrics;\r\n    }, [allMetrics, goalFilter, selectedTags, goals, projects]);\r\n\r\n    // Calculate progress helper\r\n    const calcProgress = (current, target) => {\r\n        if (!target) return 0;\r\n        return Math.min(100, Math.round((current / target) * 100));\r\n    };\r\n\r\n\r\n    if (!hasPermission('can_view_metrics')) {\r\n        return (\r\n            <div className=\"access-denied\">\r\n                <h2>Access Denied</h2>\r\n                <p>You do not have permission to view the Metrics Dashboard.</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"metrics-page\">\r\n            <div className=\"metrics-header\">\r\n                <div>\r\n                    <h1><BarChart2 size={24} style={{ display: 'inline', marginRight: '0.5rem' }} /> Metrics Dashboard</h1>\r\n                    <p className=\"subtitle\">Track Key Performance Indicators across the organization.</p>\r\n                </div>\r\n            </div>\r\n\r\n            <FilterBar\r\n                goalFilter={goalFilter}\r\n                onGoalFilterChange={handleFilterChange}\r\n                selectedTags={selectedTags}\r\n                onTagsChange={setSelectedTags}\r\n                countLabel={`${filteredMetrics.length} Metrics Found`}\r\n            />\r\n\r\n            {filteredMetrics.length === 0 ? (\r\n                <div className=\"empty-metrics\">\r\n                    <TrendingUp size={48} style={{ marginBottom: '1rem', opacity: 0.5 }} />\r\n                    <p>No metrics found matching your criteria.</p>\r\n                </div>\r\n            ) : (\r\n                <div className=\"metrics-grid\">\r\n                    {filteredMetrics.map(metric => {\r\n                        const progress = calcProgress(metric.current, metric.target);\r\n                        const isOnTrack = progress >= 50;\r\n                        const _goalId = String(metric.goalId); // ensure string\r\n\r\n                        return (\r\n                            <div key={metric.id} className=\"metric-card\">\r\n                                <div className=\"metric-card-header\">\r\n                                    <span className=\"metric-name\">{metric.name}</span>\r\n                                    <span className=\"metric-goal-badge\" title={`Goal: ${metric.goalTitle}`}>\r\n                                        {metric.goalTitle}\r\n                                    </span>\r\n                                </div>\r\n\r\n                                <div className=\"metric-values\">\r\n                                    <div className=\"metric-current-container\">\r\n                                        <span className=\"metric-current\">\r\n                                            {formatKpiValue(metric.current, metric.unit === '$' ? '$' : '')}\r\n                                        </span>\r\n                                        <span className=\"metric-separator\" style={{ margin: '0 0.5rem', color: 'var(--text-tertiary)' }}>/</span>\r\n                                        <span className=\"metric-target\">\r\n                                            {formatKpiValue(metric.target, metric.unit)}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"metric-progress\">\r\n                                    <div\r\n                                        className={`metric-progress-fill ${isOnTrack ? 'on-track' : 'behind'}`}\r\n                                        style={{ width: `${progress}%` }}\r\n                                    ></div>\r\n                                </div>\r\n\r\n                                <div className={`metric-status ${isOnTrack ? 'on-track' : 'behind'}`}>\r\n                                    {progress}%\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Reports\\ReportFilterTree.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has missing dependencies: 'buildTree' and 'hasProjects'. Either include them or remove the dependency array.","line":73,"column":8,"nodeType":"ArrayExpression","endLine":73,"endColumn":47,"suggestions":[{"desc":"Update the dependencies array to be: [buildTree, selectedTags.length, hasProjects]","fix":{"range":[2959,2998],"text":"[buildTree, selectedTags.length, hasProjects]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo } from 'react';\r\nimport { ChevronRight, ChevronDown, Folder, CheckSquare, Square, Tag, X } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { getDescendantGoalIds } from '../UI/CascadingGoalFilter';\r\nimport '../UI/ProjectTagSelector.css';\r\n\r\nexport function ReportFilterTree({ onSelectionChange, allProjects = [] }) {\r\n    const { goals, projects, tagGroups } = useData();\r\n    const [selectedIds, setSelectedIds] = useState(new Set());\r\n    const [expandedIds, setExpandedIds] = useState(new Set());\r\n    const [selectedTags, setSelectedTags] = useState([]);\r\n    const [showTagFilter, setShowTagFilter] = useState(false);\r\n\r\n    // Get only active tags grouped for the filter UI\r\n    const activeTags = useMemo(() => {\r\n        if (!tagGroups || tagGroups.length === 0) return [];\r\n        return tagGroups\r\n            .map(group => ({\r\n                ...group,\r\n                tags: (group.tags || []).filter(t => t.status?.toLowerCase() === 'active')\r\n            }))\r\n            .filter(group => group.tags.length > 0);\r\n    }, [tagGroups]);\r\n\r\n    const toggleTag = (tagId) => {\r\n        setSelectedTags(prev =>\r\n            prev.includes(tagId)\r\n                ? prev.filter(id => id !== tagId)\r\n                : [...prev, tagId]\r\n        );\r\n    };\r\n\r\n    // Filter projects by selected tags\r\n    const filteredProjects = useMemo(() => {\r\n        // Use allProjects if loaded, otherwise fallback to context projects\r\n        const source = allProjects.length > 0 ? allProjects : projects;\r\n\r\n        if (selectedTags.length === 0) return source;\r\n        return source.filter(p => {\r\n            if (!p.tags || p.tags.length === 0) return false;\r\n            const projectTagIds = p.tags.map(t => String(t.tagId));\r\n            return selectedTags.every(tagId => projectTagIds.includes(String(tagId)));\r\n        });\r\n    }, [projects, allProjects, selectedTags]);\r\n\r\n    // Build hierarchy tree using filtered projects\r\n    const buildTree = (parentId) => {\r\n        return goals\r\n            .filter(g => g.parentId === parentId)\r\n            .map(goal => ({\r\n                ...goal,\r\n                children: buildTree(goal.id),\r\n                projects: filteredProjects.filter(p => p.goalId === goal.id)\r\n            }));\r\n    };\r\n\r\n    // Helper: check if a tree node has any projects (direct or nested)\r\n    const hasProjects = (node) => {\r\n        if (node.projects.length > 0) return true;\r\n        return node.children.some(child => hasProjects(child));\r\n    };\r\n\r\n    const treeData = useMemo(() => {\r\n        const raw = buildTree(null);\r\n        // When tags are active, hide empty branches\r\n        if (selectedTags.length > 0) {\r\n            const prune = (nodes) => nodes\r\n                .filter(n => hasProjects(n))\r\n                .map(n => ({ ...n, children: prune(n.children) }));\r\n            return prune(raw);\r\n        }\r\n        return raw;\r\n    }, [goals, filteredProjects, selectedTags]);\r\n\r\n    // Toggle expansion\r\n    const toggleExpand = (id) => {\r\n        const newExpanded = new Set(expandedIds);\r\n        if (newExpanded.has(id)) newExpanded.delete(id);\r\n        else newExpanded.add(id);\r\n        setExpandedIds(newExpanded);\r\n    };\r\n\r\n    // Recursive selection\r\n    const toggleSelection = (item, isSelected) => {\r\n        const newSelected = new Set(selectedIds);\r\n\r\n        const toggleRecursive = (node, select) => {\r\n            const goalNodeId = `goal-${node.id}`;\r\n            if (select) {\r\n                newSelected.add(goalNodeId); // Goal ID\r\n                node.projects.forEach(p => newSelected.add(`project-${p.id}`)); // Project IDs\r\n            } else {\r\n                newSelected.delete(goalNodeId);\r\n                node.projects.forEach(p => newSelected.delete(`project-${p.id}`));\r\n            }\r\n            node.children.forEach(child => toggleRecursive(child, select));\r\n        };\r\n\r\n        toggleRecursive(item, isSelected);\r\n        setSelectedIds(newSelected);\r\n        onSelectionChange(Array.from(newSelected));\r\n    };\r\n\r\n    // Toggle individual project\r\n    const toggleProject = (projectId, isSelected) => {\r\n        const projectNodeId = `project-${projectId}`;\r\n        const newSelected = new Set(selectedIds);\r\n        if (isSelected) newSelected.add(projectNodeId);\r\n        else newSelected.delete(projectNodeId);\r\n        setSelectedIds(newSelected);\r\n        onSelectionChange(Array.from(newSelected));\r\n    };\r\n\r\n    const TreeNode = ({ node, level = 0 }) => {\r\n        const goalNodeId = `goal-${node.id}`;\r\n        const isExpanded = expandedIds.has(goalNodeId);\r\n        const isSelected = selectedIds.has(goalNodeId);\r\n\r\n        // Calculate available reports (Own + Descendants)\r\n        const descendantIds = getDescendantGoalIds(goals, node.id);\r\n        const allRelatedGoalIds = [node.id, ...descendantIds];\r\n        const linkedProjects = filteredProjects.filter(p => allRelatedGoalIds.includes(p.goalId));\r\n        const availableReports = linkedProjects.reduce((sum, p) => sum + (p.reportCount || 0), 0);\r\n\r\n        return (\r\n            <div className=\"tree-node\" style={{ marginLeft: `${level * 12}px` }}>\r\n                <div className=\"tree-item-content\">\r\n                    {node.children.length > 0 ? (\r\n                        <button\r\n                            className=\"btn-icon-sm\"\r\n                            onClick={(e) => { e.stopPropagation(); toggleExpand(goalNodeId); }}\r\n                            style={{ background: 'transparent', border: 'none', padding: 0, cursor: 'pointer' }}\r\n                        >\r\n                            {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}\r\n                        </button>\r\n                    ) : <span style={{ width: 14 }} />}\r\n\r\n                    <div\r\n                        onClick={() => toggleSelection(node, !isSelected)}\r\n                        style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}\r\n                    >\r\n                        {isSelected ? <CheckSquare size={16} className=\"text-primary\" /> : <Square size={16} />}\r\n                        <Folder size={16} className=\"text-secondary\" />\r\n                        <span className=\"tree-label\">{node.title}</span>\r\n                        {availableReports > 0 && (\r\n                            <span className=\"tree-count\" title={`${availableReports} projects with reports available in this hierarchy`}>\r\n                                {availableReports} Reports\r\n                            </span>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {isExpanded && (\r\n                    <div className=\"tree-children-nodes\">\r\n                        {/* Projects */}\r\n                        {node.projects.map(p => {\r\n                            const reportCount = p.reportCount || 0;\r\n                            return (\r\n                                <div key={p.id} className=\"tree-item-content\" style={{ marginLeft: '24px' }}>\r\n                                    <div\r\n                                        onClick={() => toggleProject(p.id, !selectedIds.has(`project-${p.id}`))}\r\n                                        style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}\r\n                                    >\r\n                                        {selectedIds.has(`project-${p.id}`) ? <CheckSquare size={16} className=\"text-primary\" /> : <Square size={16} />}\r\n                                        <span className=\"tree-label\" style={{ fontSize: '0.85rem' }}>{p.title}</span>\r\n                                        {reportCount > 0 && (\r\n                                            <span className=\"tree-count\" style={{ fontSize: '0.7em', background: '#ecfdf5', color: '#059669' }}>\r\n                                                {reportCount}\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })}\r\n                        {/* Sub-goals */}\r\n                        {node.children.map(child => (\r\n                            <TreeNode key={child.id} node={child} level={level + 1} />\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    return (\r\n        <div className=\"report-filter-tree\">\r\n            {/* Tag filter toggle */}\r\n            <div className=\"report-tag-filter-header\">\r\n                <button\r\n                    className={`btn-secondary btn-sm report-tag-toggle ${showTagFilter ? 'active' : ''} ${selectedTags.length > 0 ? 'has-selection' : ''}`}\r\n                    onClick={() => setShowTagFilter(!showTagFilter)}\r\n                >\r\n                    <Tag size={14} />\r\n                    Filter by Tags\r\n                    {selectedTags.length > 0 && <span className=\"report-tag-count\">{selectedTags.length}</span>}\r\n                </button>\r\n                {selectedTags.length > 0 && (\r\n                    <button\r\n                        className=\"btn-secondary btn-sm report-clear-tags\"\r\n                        onClick={() => setSelectedTags([])}\r\n                    >\r\n                        <X size={12} /> Clear\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            {showTagFilter && activeTags.length > 0 && (\r\n                <div className=\"report-tag-panel\">\r\n                    {activeTags.map(group => (\r\n                        <div key={group.id} className=\"report-tag-group\">\r\n                            <span className=\"report-tag-group-label\">{group.name}</span>\r\n                            <div className=\"report-tag-options\">\r\n                                {group.tags.map(tag => (\r\n                                    <button\r\n                                        key={tag.id}\r\n                                        className={`exec-tag-pill ${selectedTags.includes(String(tag.id)) ? 'selected' : ''}`}\r\n                                        onClick={() => toggleTag(String(tag.id))}\r\n                                        style={{ '--tag-color': tag.color || '#6366f1' }}\r\n                                    >\r\n                                        <span className=\"exec-tag-dot\" style={{ background: tag.color || '#6366f1' }}></span>\r\n                                        {tag.name}\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {treeData.map(node => (\r\n                <TreeNode key={node.id} node={node} />\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Reports\\ReportPreview.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'authFetch'. Either include it or remove the dependency array.","line":60,"column":8,"nodeType":"ArrayExpression","endLine":60,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [reportProjects, fullReports, authFetch]","fix":{"range":[2654,2683],"text":"[reportProjects, fullReports, authFetch]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useRef, useState, useEffect } from 'react';\r\nimport { Download, Printer, CheckSquare, Square } from 'lucide-react';\r\nimport html2pdf from 'html2pdf.js';\r\nimport { StatusReportView } from '../StatusReport/StatusReportView';\r\nimport { useData } from '../../context/DataContext';\r\n\r\nimport { API_BASE } from '../../apiClient';\r\n\r\nexport function ReportPreview({ selectedProjectIds, allProjects = [] }) {\r\n    const { projects, goals, getLatestStatusReport, authFetch } = useData();\r\n    const [includeAppendix, setIncludeAppendix] = useState(false);\r\n    const [fullReports, setFullReports] = useState({});\r\n    const [loadingFullReports, setLoadingFullReports] = useState(false);\r\n    const printRef = useRef(null);\r\n\r\n    // Use allProjects (full list with embedded reports) if available, fallback to context\r\n    const sourceProjects = allProjects.length > 0 ? allProjects : projects;\r\n\r\n    // Filter projects\r\n    const reportProjects = sourceProjects.filter(p => selectedProjectIds.includes(`project-${p.id}`));\r\n\r\n    // Fetch full reports for ALL selected projects to ensure we have milestones/details for the main view\r\n    useEffect(() => {\r\n        if (reportProjects.length === 0) return;\r\n\r\n        const fetchFullReports = async () => {\r\n            setLoadingFullReports(true);\r\n            const newReports = {};\r\n            try {\r\n                // Determine which reports we still need to fetch\r\n                const projectsToFetch = reportProjects.filter(p => !fullReports[p.id]);\r\n\r\n                if (projectsToFetch.length === 0) {\r\n                    setLoadingFullReports(false);\r\n                    return;\r\n                }\r\n\r\n                await Promise.all(\r\n                    projectsToFetch.map(async (project) => {\r\n                        try {\r\n                            const res = await authFetch(`${API_BASE}/projects/${project.id}/reports`);\r\n                            if (res.ok) {\r\n                                const reports = await res.json();\r\n                                if (reports.length > 0) {\r\n                                    newReports[project.id] = reports[0]; // Latest report\r\n                                }\r\n                            }\r\n                        } catch (err) {\r\n                            console.error(`Error fetching report for project ${project.id}:`, err);\r\n                        }\r\n                    })\r\n                );\r\n                setFullReports(prev => ({ ...prev, ...newReports }));\r\n            } finally {\r\n                setLoadingFullReports(false);\r\n            }\r\n        };\r\n\r\n        fetchFullReports();\r\n    }, [reportProjects, fullReports]); // dependency on reportProjects encompasses selectedProjectIds changes\r\n\r\n    // Helper: Find the Division level (second level in hierarchy, child of root organization) for a project\r\n    const getDivision = (goalId) => {\r\n        let current = goals.find(g => g.id === goalId);\r\n        if (!current) return null;\r\n\r\n        // Build the path from current goal up to root\r\n        const path = [current];\r\n        while (current && current.parentId) {\r\n            const parent = goals.find(g => g.id === current.parentId);\r\n            if (!parent) break;\r\n            path.unshift(parent);\r\n            current = parent;\r\n        }\r\n\r\n        // path[0] is Organization (root), path[1] is Division\r\n        // Return the Division level (index 1), or the project's direct goal if hierarchy is shallow\r\n        return path.length >= 2 ? path[1] : path[0];\r\n    };\r\n\r\n    // Group projects by Division (second level in hierarchy)\r\n    const groupedProjects = {};\r\n\r\n    reportProjects.forEach(p => {\r\n        const division = getDivision(p.goalId);\r\n        const groupName = division ? division.title : 'Uncategorized';\r\n        if (!groupedProjects[groupName]) {\r\n            groupedProjects[groupName] = {\r\n                division: division,\r\n                projects: []\r\n            };\r\n        }\r\n        groupedProjects[groupName].projects.push(p);\r\n    });\r\n\r\n    // Sort groups alphabetically by department name\r\n    const sortedGroupEntries = Object.entries(groupedProjects).sort((a, b) =>\r\n        a[0].localeCompare(b[0])\r\n    );\r\n\r\n    // Helper to get Status Color\r\n    const getStatusColor = (status) => {\r\n        switch (status) {\r\n            case 'green': return '#10b981';\r\n            case 'yellow': return '#f59e0b';\r\n            case 'red': return '#ef4444';\r\n            default: return '#6b7280';\r\n        }\r\n    };\r\n\r\n    const getStatusGradient = (status) => {\r\n        switch (status) {\r\n            case 'green': return 'linear-gradient(135deg, #059669, #10b981)';\r\n            case 'yellow': return 'linear-gradient(135deg, #d97706, #f59e0b)';\r\n            case 'red': return 'linear-gradient(135deg, #dc2626, #ef4444)';\r\n            default: return 'linear-gradient(135deg, #4b5563, #6b7280)';\r\n        }\r\n    };\r\n\r\n    const formatDate = (dateStr) => {\r\n        if (!dateStr) return '-';\r\n        return new Date(dateStr).toLocaleDateString('en-US', {\r\n            month: 'long',\r\n            day: 'numeric',\r\n            year: 'numeric'\r\n        });\r\n    };\r\n\r\n    const formatShortDate = (dateStr) => {\r\n        if (!dateStr) return '-';\r\n        return new Date(dateStr).toLocaleDateString('en-US', {\r\n            month: '2-digit',\r\n            day: '2-digit',\r\n            year: 'numeric'\r\n        });\r\n    };\r\n\r\n    const handleExportPdf = async () => {\r\n        if (!printRef.current) return;\r\n        const element = printRef.current;\r\n        const opt = {\r\n            margin: [0.3, 0.3, 0.3, 0.3],\r\n            filename: `Portfolio_Report_${new Date().toISOString().split('T')[0]}.pdf`,\r\n            image: { type: 'jpeg', quality: 0.98 },\r\n            html2canvas: {\r\n                scale: 2,\r\n                useCORS: true,\r\n                letterRendering: true,\r\n                scrollY: 0, // Critical for capturing full height\r\n                windowHeight: element.scrollHeight\r\n            },\r\n            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },\r\n            pagebreak: { mode: ['css', 'legacy'] }\r\n        };\r\n        await html2pdf().set(opt).from(element).save();\r\n    };\r\n\r\n    // Render a single Summary Card\r\n    const SummaryCard = ({ project }) => {\r\n        // Use embedded report from exec-summary data first, fallback to context\r\n        // BUT for the main view, we want the FULL report if possible.\r\n        // The user wants the screenshot view which has milestones etc. \r\n        // We might need to fetch full reports for the main view too if they are not already there?\r\n        // Actually, ExecDashboard uses lightweight reports and shows basic info. \r\n        // The screenshot shows \"Key Milestones\" which are usually in the full report.\r\n        // Let's use the full report if we have it (from the appendix fetch), otherwise fallback.\r\n        // Wait, the appendix fetch only happens if includeAppendix is true. \r\n        // If the user wants full details in the MAIN view, we should fetch them by default?\r\n        // The screenshot shows \"Key Milestones\", so yes, we need full data.\r\n\r\n        // HOWEVER, for now let's just restore the card.\r\n        // If the lightweight report has milestones (it might), then it works.\r\n        // If not, we might need to fetch full reports for EVERYTHING selected.\r\n\r\n        const report = fullReports[project.id] || project.report || getLatestStatusReport(project.id);\r\n        const statusColor = report ? getStatusColor(report.overallStatus) : '#d1d5db';\r\n        const statusGradient = report ? getStatusGradient(report.overallStatus) : 'linear-gradient(135deg, #4b5563, #6b7280)';\r\n\r\n        const infoTableStyle = {\r\n            width: '100%',\r\n            borderCollapse: 'collapse',\r\n            marginTop: '0'\r\n        };\r\n\r\n        const infoThStyle = {\r\n            background: 'linear-gradient(135deg, #0ea5e9, #38bdf8)',\r\n            color: 'white',\r\n            padding: '6px 8px',\r\n            textAlign: 'left',\r\n            fontWeight: '600',\r\n            fontSize: '10px',\r\n            border: '1px solid #0284c7'\r\n        };\r\n\r\n        const infoTdStyle = {\r\n            padding: '6px 8px',\r\n            border: '1px solid #d1d5db',\r\n            background: 'white',\r\n            verticalAlign: 'top',\r\n            fontSize: '10px'\r\n        };\r\n\r\n        const labelCellStyle = {\r\n            background: '#f3f4f6',\r\n            fontWeight: '600',\r\n            color: '#374151',\r\n            padding: '6px 8px',\r\n            border: '1px solid #d1d5db',\r\n            verticalAlign: 'top',\r\n            fontSize: '10px'\r\n        };\r\n\r\n        const bannerStyle = {\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'space-between',\r\n            padding: '8px 12px',\r\n            border: '2px solid #1f2937',\r\n            borderBottom: 'none',\r\n            overflow: 'hidden',\r\n            marginTop: '1rem'\r\n        };\r\n\r\n        const statusBarStyle = {\r\n            height: '24px',\r\n            width: '100%',\r\n            borderRadius: '2px',\r\n            backgroundColor: statusColor\r\n        };\r\n\r\n        return (\r\n            <div style={{ breakInside: 'avoid' }}>\r\n                {/* Header Banner */}\r\n                <div style={bannerStyle}>\r\n                    <div style={{ flex: '1', minWidth: 0 }}>\r\n                        {/* Placeholder for Logo if needed, user screenshot has it */}\r\n                    </div>\r\n                    <div style={{\r\n                        background: statusGradient,\r\n                        color: 'white',\r\n                        padding: '6px 20px',\r\n                        fontSize: '14px',\r\n                        fontWeight: '600',\r\n                        borderRadius: '4px',\r\n                        flexShrink: 0\r\n                    }}>\r\n                        Status Update\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Project Info Table */}\r\n                <table style={infoTableStyle}>\r\n                    <thead>\r\n                        <tr>\r\n                            <th style={{ ...infoThStyle, width: '25%' }}>Project Name</th>\r\n                            <th style={{ ...infoThStyle, width: '20%' }}>Report Date</th>\r\n                            <th style={{ ...infoThStyle, width: '20%' }}>Prepared By</th>\r\n                            <th style={{ ...infoThStyle, width: '35%' }}>Overall Status</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        <tr>\r\n                            <td style={infoTdStyle}>{project.title}</td>\r\n                            <td style={infoTdStyle}>{report ? formatDate(report.reportDate) : '-'}</td>\r\n                            <td style={infoTdStyle}>{report ? report.createdBy : '-'}</td>\r\n                            <td style={infoTdStyle}>\r\n                                <div style={statusBarStyle} />\r\n                            </td>\r\n                        </tr>\r\n                    </tbody>\r\n                </table>\r\n\r\n                {report && (\r\n                    <>\r\n                        {/* Project Purpose */}\r\n                        {report.purpose && (\r\n                            <table style={infoTableStyle}>\r\n                                <tbody>\r\n                                    <tr>\r\n                                        <td style={{ ...labelCellStyle, width: '15%' }}>Project Purpose:</td>\r\n                                        <td style={infoTdStyle}>{report.purpose}</td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n\r\n                        {/* Executive Summary */}\r\n                        {report.executiveSummary && (\r\n                            <table style={infoTableStyle}>\r\n                                <tbody>\r\n                                    <tr>\r\n                                        <td style={{ ...labelCellStyle, width: '15%' }}>Executive Summary - Current State:</td>\r\n                                        <td style={infoTdStyle}>{report.executiveSummary}</td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n\r\n                        {/* Key Contacts */}\r\n                        {report.contacts?.length > 0 && (\r\n                            <table style={infoTableStyle}>\r\n                                <tbody>\r\n                                    <tr>\r\n                                        <td style={{ ...labelCellStyle, width: '15%' }}>Key Contact(s):</td>\r\n                                        <td style={infoTdStyle}>\r\n                                            {report.contacts.map((c, i) => (\r\n                                                <span key={i}>\r\n                                                    {c.name}\r\n                                                    {i < report.contacts.length - 1 ? ', ' : ''}\r\n                                                </span>\r\n                                            ))}\r\n                                        </td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n\r\n                        {/* Milestones */}\r\n                        {report.milestones?.some(m => m.date) && (\r\n                            <div>\r\n                                <div style={{\r\n                                    background: 'linear-gradient(135deg, #059669, #10b981)',\r\n                                    color: 'white',\r\n                                    padding: '6px 12px',\r\n                                    fontWeight: '600',\r\n                                    fontSize: '11px',\r\n                                    borderRadius: '2px 2px 0 0'\r\n                                }}>\r\n                                    Key Milestones\r\n                                </div>\r\n                                <div style={{\r\n                                    border: '1px solid #d1d5db',\r\n                                    borderTop: 'none',\r\n                                    padding: '16px 8px',\r\n                                    background: 'white'\r\n                                }}>\r\n                                    <div style={{ display: 'flex', justifyContent: 'space-around', position: 'relative', padding: '10px 0' }}>\r\n                                        <div style={{\r\n                                            position: 'absolute', top: '50%', left: '5%', right: '5%', height: '3px',\r\n                                            background: '#374151', transform: 'translateY(-50%)', zIndex: 0\r\n                                        }} />\r\n                                        {report.milestones.filter(m => m.date).map((m, idx) => (\r\n                                            <div key={idx} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', zIndex: 1, flex: 1, textAlign: 'center' }}>\r\n                                                <div style={{ fontSize: '10px', color: '#1f2937', marginBottom: '8px', fontWeight: '600' }}>\r\n                                                    {formatShortDate(m.date)}\r\n                                                </div>\r\n                                                <div style={{\r\n                                                    width: '12px', height: '12px', transform: 'rotate(45deg)',\r\n                                                    background: m.status === 'complete' ? '#10b981' : (m.status === 'in-progress' ? '#f59e0b' : 'white'),\r\n                                                    border: `2px solid ${m.status === 'complete' ? '#10b981' : (m.status === 'in-progress' ? '#f59e0b' : '#374151')}`,\r\n                                                    boxShadow: '0 1px 2px rgba(0,0,0,0.1)'\r\n                                                }} />\r\n                                                <div style={{ fontSize: '9px', color: '#4b5563', marginTop: '8px', maxWidth: '80px', lineHeight: '1.2' }}>\r\n                                                    {m.name}\r\n                                                </div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                    </>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    if (reportProjects.length === 0) {\r\n        return (\r\n            <div className=\"report-preview-pane\">\r\n                <div className=\"preview-content\">\r\n                    <div style={{ color: 'white' }}>Select projects from the left to generate report.</div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"report-preview-pane\">\r\n            <div className=\"preview-header\">\r\n                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>\r\n                    <h3>Report Preview ({reportProjects.length} Projects)</h3>\r\n                    <button\r\n                        className=\"btn-secondary\"\r\n                        onClick={() => setIncludeAppendix(!includeAppendix)}\r\n                    >\r\n                        {includeAppendix ? <CheckSquare size={16} className=\"text-primary\" /> : <Square size={16} />}\r\n                        Include Detailed Appendices\r\n                    </button>\r\n                </div>\r\n                <div className=\"preview-actions\">\r\n                    <button className=\"btn-secondary\" onClick={() => window.print()}>\r\n                        <Printer size={16} /> Print\r\n                    </button>\r\n                    <button className=\"btn-primary\" onClick={handleExportPdf}>\r\n                        <Download size={16} /> Export PDF\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"preview-content\">\r\n                <div className=\"preview-sheet\" id=\"report-print-content\" ref={printRef}>\r\n\r\n                    {/* PART 1: PROJECT SUMMARIES (CARDS) */}\r\n                    <div className=\"report-summary-header\" style={{\r\n                        background: '#1f2937',\r\n                        color: 'white',\r\n                        padding: '1rem',\r\n                        textAlign: 'center',\r\n                        fontSize: '1.5rem',\r\n                        fontWeight: '700',\r\n                        marginBottom: '2rem'\r\n                    }}>\r\n                        Portfolio Status Report\r\n                        <div style={{ fontSize: '1rem', fontWeight: '400', marginTop: '0.5rem' }}>\r\n                            {formatDate(new Date())}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {sortedGroupEntries.map(([groupName, { projects }]) => (\r\n                        <div key={groupName} className=\"hierarchy-section\">\r\n                            <div className=\"hierarchy-header\">{groupName}</div>\r\n                            {projects.map(project => (\r\n                                <SummaryCard key={project.id} project={project} />\r\n                            ))}\r\n                        </div>\r\n                    ))}\r\n\r\n                    {/* PART 2: DETAILED APPENDICES */}\r\n                    {includeAppendix && (\r\n                        <>\r\n                            <div style={{ pageBreakBefore: 'always' }} />\r\n\r\n                            <div className=\"report-summary-header\" style={{\r\n                                background: '#1f2937',\r\n                                color: 'white',\r\n                                padding: '1rem',\r\n                                textAlign: 'center',\r\n                                fontSize: '1.5rem',\r\n                                fontWeight: '700',\r\n                                marginBottom: '0'\r\n                            }}>\r\n                                Appendix: Detailed Reports\r\n                            </div>\r\n\r\n                            {loadingFullReports && (\r\n                                <div style={{ padding: '2rem', textAlign: 'center', color: '#6b7280' }}>\r\n                                    Loading full reports...\r\n                                </div>\r\n                            )}\r\n\r\n                            {sortedGroupEntries.map(([groupName, { projects: groupProjects }]) => (\r\n                                <div key={groupName}>\r\n                                    {/* Division Subheader */}\r\n                                    <div style={{\r\n                                        background: 'linear-gradient(135deg, #374151, #4b5563)',\r\n                                        color: 'white',\r\n                                        padding: '8px 12px',\r\n                                        fontSize: '1rem',\r\n                                        fontWeight: '600'\r\n                                    }}>\r\n                                        {groupName}\r\n                                    </div>\r\n\r\n                                    {groupProjects.map((project) => {\r\n                                        // Use full report if available, fallback to embedded/context report\r\n                                        const report = fullReports[project.id] || project.report || getLatestStatusReport(project.id);\r\n                                        if (!report) return null;\r\n                                        return (\r\n                                            <div key={project.id}>\r\n                                                <StatusReportView\r\n                                                    report={report}\r\n                                                    projectTitle={project.title}\r\n                                                    onExportPdf={() => { }}\r\n                                                    hideActions={true}\r\n                                                />\r\n                                            </div>\r\n                                        );\r\n                                    })}\r\n                                </div>\r\n                            ))}\r\n                        </>\r\n                    )}\r\n\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\Reports\\ReportsView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportCompare.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportEditor.jsx","messages":[],"suppressedMessages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_/u.","line":184,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":184,"endColumn":54,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[6340,6346],"text":""},"desc":"Remove unused variable 'Icon'."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportHistory.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportPage.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchReports'. Either include it or remove the dependency array.","line":44,"column":8,"nodeType":"ArrayExpression","endLine":44,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [fetchReports, project.id]","fix":{"range":[1776,1788],"text":"[fetchReports, project.id]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { Plus, FileText, History, Eye, RefreshCw } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\n\r\nimport { Modal } from '../UI/Modal';\r\nimport { StatusReportEditor } from './StatusReportEditor';\r\nimport { StatusReportView } from './StatusReportView';\r\nimport { StatusReportHistory } from './StatusReportHistory';\r\nimport { StatusReportCompare } from './StatusReportCompare';\r\nimport './StatusReport.css';\r\n\r\nimport { API_BASE } from '../../apiClient';\r\n\r\nexport function StatusReportPage({ project, onClose: _onClose }) {\r\n    const { authFetch } = useData();\r\n    const [reports, setReports] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [activeTab, setActiveTab] = useState('current'); // 'current', 'history', 'edit'\r\n    const [viewingReport, setViewingReport] = useState(null);\r\n    const [comparingReports, setComparingReports] = useState(null);\r\n\r\n    // Fetch reports on mount\r\n    const fetchReports = async () => {\r\n        // console.log(\"StatusReportPage: Fetching reports for project\", project.id);\r\n        setLoading(true);\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects/${project.id}/reports`);\r\n            if (res.ok) {\r\n                const data = await res.json();\r\n                // console.log(\"StatusReportPage: Fetched reports:\", data);\r\n                setReports(data);\r\n            } else {\r\n                console.error(\"StatusReportPage: Fetch failed status:\", res.status);\r\n            }\r\n        } catch (err) {\r\n            console.error(\"Failed to load reports:\", err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchReports();\r\n    }, [project.id]);\r\n\r\n    const latestReport = reports.length > 0 ? reports[0] : null; // API returns sorted DESC\r\n    useEffect(() => {\r\n        // console.log(\"StatusReportPage: latestReport:\", latestReport);\r\n    }, [latestReport]);\r\n\r\n    const handleViewReport = (report) => {\r\n        setViewingReport(report);\r\n        setActiveTab('view');\r\n    };\r\n\r\n    const handleCompare = (report1, report2) => {\r\n        // Ensure older version is first\r\n        const sorted = [report1, report2].sort((a, b) => a.version - b.version);\r\n        setComparingReports(sorted);\r\n        setActiveTab('compare');\r\n    };\r\n\r\n    const handleCreateNew = () => {\r\n        setActiveTab('edit');\r\n    };\r\n\r\n    const handleSaveComplete = () => {\r\n        fetchReports();\r\n        setActiveTab('current');\r\n        setViewingReport(null);\r\n    };\r\n\r\n    return (\r\n        <div className=\"status-report-page\">\r\n            {/* Tabs with New Report button */}\r\n            <div className=\"report-tabs\">\r\n                <button\r\n                    className={`report-tab ${activeTab === 'current' ? 'active' : ''}`}\r\n                    onClick={() => { setActiveTab('current'); setViewingReport(null); }}\r\n                >\r\n                    <Eye size={16} /> Current\r\n                </button>\r\n                <button\r\n                    className={`report-tab ${activeTab === 'history' ? 'active' : ''}`}\r\n                    onClick={() => setActiveTab('history')}\r\n                >\r\n                    <History size={16} /> History ({reports.length})\r\n                </button>\r\n                <button className=\"btn-primary btn-new-report\" onClick={handleCreateNew}>\r\n                    <Plus size={16} /> New Report\r\n                </button>\r\n            </div>\r\n\r\n            {loading ? (\r\n                <div style={{ padding: '2rem', textAlign: 'center', color: 'var(--text-secondary)' }}>\r\n                    <RefreshCw className=\"spin\" size={24} /> Loading reports...\r\n                </div>\r\n            ) : (\r\n                /* Content Area - Scrollable */\r\n                <div className=\"report-content-area\">\r\n                    {activeTab === 'current' && (\r\n                        <>\r\n                            {latestReport ? (\r\n                                <StatusReportView\r\n                                    report={latestReport}\r\n                                    projectTitle={project.title}\r\n                                />\r\n                            ) : (\r\n                                <div className=\"empty-reports\">\r\n                                    <FileText size={48} />\r\n                                    <p>No status reports yet. Create your first report to establish a governance baseline.</p>\r\n                                    <button className=\"btn-primary\" onClick={handleCreateNew}>\r\n                                        <Plus size={16} /> Create First Report\r\n                                    </button>\r\n                                </div>\r\n                            )}\r\n                        </>\r\n                    )}\r\n\r\n                    {activeTab === 'history' && (\r\n                        <StatusReportHistory\r\n                            projectId={project.id}\r\n                            reports={reports}\r\n                            onViewReport={handleViewReport}\r\n                            onCompare={handleCompare}\r\n                        />\r\n                    )}\r\n\r\n                    {activeTab === 'view' && viewingReport && (\r\n                        <StatusReportView\r\n                            report={viewingReport}\r\n                            projectTitle={project.title}\r\n                        />\r\n                    )}\r\n\r\n                    {activeTab === 'compare' && comparingReports && (\r\n                        <StatusReportCompare\r\n                            report1={comparingReports[0]}\r\n                            report2={comparingReports[1]}\r\n                            projectTitle={project.title}\r\n                            onClose={() => setActiveTab('history')}\r\n                        />\r\n                    )}\r\n                </div>\r\n            )}\r\n            {activeTab === 'edit' && (\r\n                <Modal\r\n                    isOpen={true}\r\n                    onClose={() => setActiveTab(latestReport ? 'current' : 'current')}\r\n                    title={`Create Status Report v${reports.length + 1}`}\r\n                    size=\"xl\"\r\n                    closeOnOverlayClick={false}\r\n                >\r\n                    <StatusReportEditor\r\n                        projectId={project.id}\r\n                        projectTitle={project.title}\r\n                        previousReport={latestReport}\r\n                        onSave={handleSaveComplete}\r\n                        onCancel={() => setActiveTab(latestReport ? 'current' : 'current')}\r\n                    />\r\n                </Modal>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\StatusReport\\StatusReportView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\CascadingGoalFilter.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  78 |     useEffect(() => {\n  79 |         if (!value) {\n> 80 |             setSelections({ org: '', division: '', department: '', branch: '' });\n     |             ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  81 |             return;\n  82 |         }\n  83 |","line":80,"column":13,"nodeType":null,"endLine":80,"endColumn":26},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":190,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":190,"endColumn":37}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { Filter, X } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport './CascadingGoalFilter.css';\r\n\r\nconst LEVEL_NAMES = ['Organization', 'Division', 'Department', 'Branch'];\r\n\r\nexport function CascadingGoalFilter({ value, onChange }) {\r\n    const { goals } = useData();\r\n\r\n    // Track selections at each level\r\n    const [selections, setSelections] = useState({\r\n        org: '',\r\n        division: '',\r\n        department: '',\r\n        branch: ''\r\n    });\r\n\r\n    // Get goals at each level\r\n    const getGoalsAtLevel = (level, parentId = null) => {\r\n        if (level === 0) {\r\n            // Root level - no parent\r\n            return goals.filter(g => !g.parentId);\r\n        }\r\n        // Child level - filter by parent\r\n        if (!parentId) return [];\r\n        return goals.filter(g => g.parentId === parentId);\r\n    };\r\n\r\n    // Get available options for each dropdown\r\n    const orgGoals = getGoalsAtLevel(0);\r\n    const divisionGoals = getGoalsAtLevel(1, selections.org);\r\n    const departmentGoals = getGoalsAtLevel(2, selections.division);\r\n    const branchGoals = getGoalsAtLevel(3, selections.department);\r\n\r\n    // Handle selection change at a level\r\n    const handleChange = (level, goalIdValue) => {\r\n        // IDs are strings from API, so keep them as strings to match\r\n        const goalId = goalIdValue || '';\r\n        const newSelections = { ...selections };\r\n\r\n        switch (level) {\r\n            case 'org':\r\n                newSelections.org = goalId;\r\n                newSelections.division = '';\r\n                newSelections.department = '';\r\n                newSelections.branch = '';\r\n                break;\r\n            case 'division':\r\n                newSelections.division = goalId;\r\n                newSelections.department = '';\r\n                newSelections.branch = '';\r\n                break;\r\n            case 'department':\r\n                newSelections.department = goalId;\r\n                newSelections.branch = '';\r\n                break;\r\n            case 'branch':\r\n                newSelections.branch = goalId;\r\n                break;\r\n        }\r\n\r\n        setSelections(newSelections);\r\n\r\n        // Return the most specific (deepest) selection\r\n        const selectedId = newSelections.branch || newSelections.department ||\r\n            newSelections.division || newSelections.org || '';\r\n        onChange(selectedId);\r\n    };\r\n\r\n    // Clear all filters\r\n    const handleClear = () => {\r\n        setSelections({ org: '', division: '', department: '', branch: '' });\r\n        onChange('');\r\n    };\r\n\r\n    // Sync external value changes\r\n    useEffect(() => {\r\n        if (!value) {\r\n            setSelections({ org: '', division: '', department: '', branch: '' });\r\n            return;\r\n        }\r\n\r\n        // Find the goal and trace its ancestry\r\n        // Use loose equality or parsing to match string/number\r\n        const goal = goals.find(g => g.id == value);\r\n        if (!goal) return;\r\n\r\n        // Build ancestry chain\r\n        const ancestry = [];\r\n        let current = goal;\r\n        while (current) {\r\n            ancestry.unshift(current.id);\r\n            // Ensure parentId lookup is robust\r\n            current = goals.find(g => g.id === current.parentId);\r\n        }\r\n\r\n        // Set selections based on ancestry\r\n        setSelections({\r\n            org: ancestry[0] || '',\r\n            division: ancestry[1] || '',\r\n            department: ancestry[2] || '',\r\n            branch: ancestry[3] || ''\r\n        });\r\n    }, [value, goals]);\r\n\r\n    const hasAnySelection = selections.org || selections.division ||\r\n        selections.department || selections.branch;\r\n\r\n    return (\r\n        <div className=\"cascading-filter\">\r\n            <div className=\"cascading-filter-row\">\r\n                <Filter size={16} className=\"filter-icon\" />\r\n\r\n                {/* Organization */}\r\n                <select\r\n                    value={selections.org}\r\n                    onChange={e => handleChange('org', e.target.value)}\r\n                    className=\"form-select\"\r\n                    style={{ minWidth: '160px', width: 'auto' }}\r\n                >\r\n                    <option value=\"\">All Organizations</option>\r\n                    {orgGoals.map(g => (\r\n                        <option key={g.id} value={g.id}>{g.title}</option>\r\n                    ))}\r\n                </select>\r\n\r\n                {/* Division - only show if org selected */}\r\n                {selections.org && divisionGoals.length > 0 && (\r\n                    <select\r\n                        value={selections.division}\r\n                        onChange={e => handleChange('division', e.target.value)}\r\n                        className=\"form-select\"\r\n                        style={{ minWidth: '160px', width: 'auto' }}\r\n                    >\r\n                        <option value=\"\">All Divisions</option>\r\n                        {divisionGoals.map(g => (\r\n                            <option key={g.id} value={g.id}>{g.title}</option>\r\n                        ))}\r\n                    </select>\r\n                )}\r\n\r\n                {/* Department - only show if division selected */}\r\n                {selections.division && departmentGoals.length > 0 && (\r\n                    <select\r\n                        value={selections.department}\r\n                        onChange={e => handleChange('department', e.target.value)}\r\n                        className=\"form-select\"\r\n                        style={{ minWidth: '160px', width: 'auto' }}\r\n                    >\r\n                        <option value=\"\">All Departments</option>\r\n                        {departmentGoals.map(g => (\r\n                            <option key={g.id} value={g.id}>{g.title}</option>\r\n                        ))}\r\n                    </select>\r\n                )}\r\n\r\n                {/* Branch - only show if department selected */}\r\n                {selections.department && branchGoals.length > 0 && (\r\n                    <select\r\n                        value={selections.branch}\r\n                        onChange={e => handleChange('branch', e.target.value)}\r\n                        className=\"form-select\"\r\n                        style={{ minWidth: '160px', width: 'auto' }}\r\n                    >\r\n                        <option value=\"\">All Branches</option>\r\n                        {branchGoals.map(g => (\r\n                            <option key={g.id} value={g.id}>{g.title}</option>\r\n                        ))}\r\n                    </select>\r\n                )}\r\n\r\n                {/* Clear button */}\r\n                {hasAnySelection && (\r\n                    <button\r\n                        className=\"btn-secondary\"\r\n                        onClick={handleClear}\r\n                        title=\"Clear filters\"\r\n                        style={{ padding: '0.6rem', display: 'flex', alignItems: 'center', justifyContent: 'center' }}\r\n                    >\r\n                        <X size={16} />\r\n                    </button>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\n// Helper function to get all descendant goal IDs\r\nexport function getDescendantGoalIds(goals, parentId) {\r\n    const descendants = [];\r\n    // Use loose equality to match string IDs with number parentIds if needed\r\n    const children = goals.filter(g => g.parentId == parentId);\r\n\r\n    for (const child of children) {\r\n        descendants.push(child.id);\r\n        descendants.push(...getDescendantGoalIds(goals, child.id));\r\n    }\r\n\r\n    return descendants;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\ErrorBoundary.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\FilterBar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\Modal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\ProjectTagSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\ThemeToggle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\components\\UI\\Toast.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\context\\DataContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":955,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":955,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useEffect, useState, useMemo, useCallback } from 'react';\r\nimport { useMsal } from '@azure/msal-react';\r\nimport { apiRequest } from '../authConfig';\r\nimport { fetchWithAuth, ApiError, API_BASE } from '../apiClient';\r\n\r\nconst DataContext = createContext();\r\n\r\n// Helper: Calculate project completion percentage\r\nfunction calcProjectCompletion(project) {\r\n    // ... (unchanged)\r\n    if (!project._detailsLoaded) return project.completion || 0;\r\n    if (!project.tasks || project.tasks.length === 0) return 0;\r\n    const doneCount = project.tasks.filter(t => t.status === 'done').length;\r\n    return Math.round((doneCount / project.tasks.length) * 100);\r\n}\r\n\r\nexport function DataProvider({ children }) {\r\n    // ... State definitions (unchanged)\r\n    const [goals, setGoals] = useState([]);\r\n    const [projects, setProjects] = useState([]);\r\n    const [projectsPagination, setProjectsPagination] = useState({\r\n        page: 1, limit: 50, total: 0, totalPages: 0, hasMore: false\r\n    });\r\n    const [intakeForms, setIntakeForms] = useState([]);\r\n    const [intakeSubmissions, setIntakeSubmissions] = useState([]);\r\n    const [tagGroups, setTagGroups] = useState([]);\r\n    const [permissions, setPermissions] = useState([]);\r\n    const { instance } = useMsal();\r\n    const [loading, setLoading] = useState(true);\r\n    const [loadingMore, setLoadingMore] = useState(false);\r\n    const [error, setError] = useState(null);\r\n\r\n    // Helper: Authenticated fetch wrapper using centralized client\r\n    const authFetch = useCallback(async (url, options = {}) => {\r\n        let token = null;\r\n        try {\r\n            const account = instance.getActiveAccount();\r\n            if (account) {\r\n                const response = await instance.acquireTokenSilent({\r\n                    ...apiRequest,\r\n                    account: account\r\n                });\r\n                token = response.accessToken;\r\n            }\r\n        } catch (error) {\r\n            console.error('Token acquisition failed', error);\r\n            // Proceed without token (backend will reject 401 if strict)\r\n        }\r\n\r\n        return fetchWithAuth(url, token, options);\r\n    }, [instance]);\r\n\r\n    // Load more projects (pagination)\r\n    const loadMoreProjects = useCallback(async () => {\r\n        if (!projectsPagination.hasMore || loadingMore) return;\r\n\r\n        setLoadingMore(true);\r\n        try {\r\n            const nextPage = projectsPagination.page + 1;\r\n            const res = await authFetch(`${API_BASE}/projects?page=${nextPage}&limit=${projectsPagination.limit}`);\r\n            // fetchWithAuth throws on error, so res is OK here\r\n            const data = await res.json();\r\n            setProjects(prev => [...prev, ...data.projects]);\r\n            setProjectsPagination(data.pagination);\r\n        } catch (err) {\r\n            console.error('Error loading more projects:', err);\r\n        } finally {\r\n            setLoadingMore(false);\r\n        }\r\n    }, [projectsPagination, loadingMore, authFetch]);\r\n\r\n    // Fetch Exec Summary (All Projects)\r\n    const fetchExecSummaryProjects = useCallback(async () => {\r\n        const res = await authFetch(`${API_BASE}/projects/exec-summary`);\r\n        return await res.json();\r\n    }, [authFetch]);\r\n\r\n    // Fetch all data on mount (Permission-Aware)\r\n    useEffect(() => {\r\n        async function fetchData() {\r\n            try {\r\n                console.log(\"DataContext: Starting data fetch...\");\r\n                setLoading(true);\r\n\r\n                // 1. Fetch Permissions FIRST to determine what else to fetch\r\n                let currentPermissions = [];\r\n                try {\r\n                    const permsRes = await authFetch(`${API_BASE}/admin/permissions`);\r\n                    currentPermissions = await permsRes.json();\r\n                    setPermissions(currentPermissions);\r\n                } catch (err) {\r\n                    console.warn(\"DataContext: Failed to load permissions\", err);\r\n                    // If 403/401, permissions remain empty\r\n                }\r\n\r\n                // Helper to check permission against the JUST loaded permissions\r\n                // (State update hasn't propagated yet)\r\n                const account = instance.getActiveAccount();\r\n                const roles = account?.idTokenClaims?.roles || [];\r\n                const checkPerm = (permKey) => {\r\n                    if (roles.includes('Admin')) return true;\r\n                    // Check if any user role has the permission allowed\r\n                    return currentPermissions.some(p => roles.includes(p.role) && p.permission === permKey && p.isAllowed);\r\n                };\r\n\r\n                // 2. Fetch Core Data (Goals, Projects)\r\n                // We use Promise.allSettled to allow partial failures\r\n                const [goalsResult, projectsResult] = await Promise.allSettled([\r\n                    checkPerm('can_view_goals') ? authFetch(`${API_BASE}/goals`) : Promise.reject('skipped'),\r\n                    checkPerm('can_view_projects') ? authFetch(`${API_BASE}/projects?page=1&limit=50`) : Promise.reject('skipped')\r\n                ]);\r\n\r\n                if (goalsResult.status === 'fulfilled') {\r\n                    setGoals(await goalsResult.value.json());\r\n                } else if (goalsResult.reason !== 'skipped') {\r\n                    // Check if it was 403 (shouldn't happen if checkPerm works, but fallback)\r\n                    if (goalsResult.reason?.status === 403) {\r\n                        setGoals([]);\r\n                    } else {\r\n                        console.error(\"Failed to load goals\", goalsResult.reason);\r\n                    }\r\n                }\r\n\r\n                if (projectsResult.status === 'fulfilled') {\r\n                    const projectsData = await projectsResult.value.json();\r\n                    setProjects(projectsData.projects || projectsData);\r\n                    if (projectsData.pagination) setProjectsPagination(projectsData.pagination);\r\n                } else if (projectsResult.reason !== 'skipped') {\r\n                    if (projectsResult.reason?.status === 403) {\r\n                        setProjects([]);\r\n                    } else {\r\n                        console.error(\"Failed to load projects\", projectsResult.reason);\r\n                    }\r\n                }\r\n\r\n                console.log(\"DataContext: Critical data loaded. Unblocking render.\");\r\n                setLoading(false);\r\n\r\n                // 3. Fetch Secondary Data (Intake, Tags) - Background\r\n                const secondaryPromises = [];\r\n\r\n                // Tags (generally public/authenticated)\r\n                secondaryPromises.push(authFetch(`${API_BASE}/tags`).then(r => r.json()).then(setTagGroups).catch(e => console.warn('Tags fetch failed', e)));\r\n\r\n                // Intake Forms (if can view/manage)\r\n                if (checkPerm('can_view_intake') || checkPerm('can_manage_intake')) {\r\n                    secondaryPromises.push(authFetch(`${API_BASE}/intake/forms`).then(r => r.json()).then(setIntakeForms).catch(e => console.warn('Intake forms failed', e)));\r\n                }\r\n\r\n                // Submissions - ONLY if allowed\r\n                // 'can_view_incoming_requests' -> All submissions\r\n                if (checkPerm('can_view_incoming_requests')) {\r\n                    secondaryPromises.push(authFetch(`${API_BASE}/intake/submissions`).then(r => r.json()).then(setIntakeSubmissions).catch(e => console.warn('Submissions fetch failed', e)));\r\n                }\r\n\r\n                // My Submissions - Always allowed for authenticated users\r\n                if (account) {\r\n                    secondaryPromises.push(authFetch(`${API_BASE}/intake/my-submissions`).then(r => r.json()).then(setMySubmissions).catch(e => console.warn('My Submissions failed', e)));\r\n                }\r\n\r\n                await Promise.allSettled(secondaryPromises);\r\n\r\n                setError(null);\r\n            } catch (err) {\r\n                console.error('Error fetching data:', err);\r\n                setError(err.message);\r\n                setLoading(false);\r\n            }\r\n        }\r\n\r\n        const account = instance.getActiveAccount();\r\n        if (account) {\r\n            fetchData();\r\n        }\r\n    }, [instance, authFetch]);\r\n\r\n\r\n    const updatePermissionsBulk = useCallback(async (updates) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/admin/permissions/bulk`, {\r\n                method: 'POST',\r\n                body: JSON.stringify({ updates })\r\n            });\r\n            if (!res.ok) throw new Error('Failed to update permissions');\r\n\r\n            // Update local state\r\n            setPermissions(prev => {\r\n                const newPerms = [...prev];\r\n                updates.forEach(u => {\r\n                    const idx = newPerms.findIndex(p => p.role === u.role && p.permission === u.permission);\r\n                    if (idx >= 0) {\r\n                        newPerms[idx] = { ...newPerms[idx], isAllowed: u.isAllowed };\r\n                    } else {\r\n                        newPerms.push({ role: u.role, permission: u.permission, isAllowed: u.isAllowed });\r\n                    }\r\n                });\r\n                return newPerms;\r\n            });\r\n            return true;\r\n        } catch (err) {\r\n            console.error(err);\r\n            return false;\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // Derived: Projects with completion %\r\n    const projectsWithCompletion = useMemo(() => {\r\n        return projects.map(p => ({\r\n            ...p,\r\n            completion: calcProjectCompletion(p)\r\n        }));\r\n    }, [projects]);\r\n\r\n    // Derived: Goals with progress calculated from server-provided stats (recursive aggregation)\r\n    const goalsWithProgress = useMemo(() => {\r\n        if (goals.length === 0) return [];\r\n\r\n        // 1. Goal Hierarchy Lookup (O(G)) - Parent -> Children\r\n        const goalChildrenMap = {};\r\n        goals.forEach(g => {\r\n            if (g.parentId) {\r\n                if (!goalChildrenMap[g.parentId]) goalChildrenMap[g.parentId] = [];\r\n                goalChildrenMap[g.parentId].push(g.id);\r\n            }\r\n        });\r\n\r\n        // 2. Recursive Stats Aggregation with Memoization\r\n        const statsCache = {}; // Stores { count, sum, kpiCount } for each goal (including descendants)\r\n\r\n        const getGoalStats = (goalId) => {\r\n            if (statsCache[goalId] !== undefined) return statsCache[goalId];\r\n\r\n            // Prevent infinite recursion\r\n            statsCache[goalId] = { count: 0, sum: 0, kpiCount: 0 };\r\n\r\n            const goal = goals.find(g => g.id === goalId);\r\n            if (!goal) return { count: 0, sum: 0, kpiCount: 0 };\r\n\r\n            // Start with direct/server stats\r\n            let totalCount = goal.directProjectCount || 0;\r\n            let totalSum = goal.directCompletionSum || 0;\r\n            let totalKpiCount = (goal.kpis ? goal.kpis.length : 0);\r\n\r\n            // Add stats from child goals\r\n            const childGoalIds = goalChildrenMap[goalId] || [];\r\n            childGoalIds.forEach(childId => {\r\n                const childStats = getGoalStats(childId);\r\n                totalCount += childStats.count;\r\n                totalSum += childStats.sum;\r\n                totalKpiCount += childStats.kpiCount;\r\n            });\r\n\r\n            const result = { count: totalCount, sum: totalSum, kpiCount: totalKpiCount };\r\n            statsCache[goalId] = result;\r\n            return result;\r\n        };\r\n\r\n        return goals.map(goal => {\r\n            // Get aggregated stats\r\n            const stats = getGoalStats(goal.id);\r\n\r\n            // Calculate progress\r\n            let progress = 0;\r\n            if (stats.count > 0) {\r\n                progress = Math.round(stats.sum / stats.count);\r\n            }\r\n\r\n            return {\r\n                ...goal,\r\n                progress,\r\n                linkedProjectCount: goal.directProjectCount || 0, // Direct only\r\n                totalProjectCount: stats.count,                   // Rolling up count\r\n                totalKpiCount: stats.kpiCount                     // Rolling up KPI count\r\n            };\r\n        });\r\n    }, [goals]);\r\n\r\n    // Optimization: Pre-calculate user permissions into a Set for O(1) lookup\r\n    const userPermissions = useMemo(() => {\r\n        const account = instance.getActiveAccount();\r\n        if (!account || !account.idTokenClaims || !account.idTokenClaims.roles) return new Set();\r\n\r\n        const roles = account.idTokenClaims.roles;\r\n\r\n        // Admin bypass - Efficiently handle admins\r\n        if (roles.includes('Admin')) return 'ALL';\r\n\r\n        const allowed = new Set();\r\n        // Iterate permissions once to build the lookup set\r\n        permissions.forEach(p => {\r\n            // If user has the role and permission is allowed, add to set\r\n            if (roles.includes(p.role) && p.isAllowed) {\r\n                allowed.add(p.permission);\r\n            }\r\n        });\r\n        return allowed;\r\n    }, [instance, permissions]);\r\n\r\n    // Optimized O(1) permission check\r\n    const hasPermission = useCallback((permissionKey) => {\r\n        if (userPermissions === 'ALL') return true;\r\n        return userPermissions.has(permissionKey);\r\n    }, [userPermissions]);\r\n\r\n    // ==================== GOALS ====================\r\n\r\n    const addGoal = useCallback(async (goal) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/goals`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(goal)\r\n            });\r\n            const newGoal = await res.json();\r\n            setGoals(prev => [...prev, newGoal]);\r\n            return newGoal.id;\r\n        } catch (err) {\r\n            console.error('Error adding goal:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateGoal = useCallback(async (id, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/goals/${id}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setGoals(prev => prev.map(g => g.id === id ? { ...g, ...updates } : g));\r\n        } catch (err) {\r\n            console.error('Error updating goal:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const deleteGoal = useCallback(async (id) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/goals/${id}`, { method: 'DELETE' });\r\n            setGoals(prev => prev.filter(g => g.id !== id));\r\n        } catch (err) {\r\n            console.error('Error deleting goal:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== KPIs ====================\r\n\r\n    const addKpi = useCallback(async (goalId, kpi) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/goals/${goalId}/kpis`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(kpi)\r\n            });\r\n            const newKpi = await res.json();\r\n            setGoals(prev => prev.map(g => {\r\n                if (g.id !== goalId) return g;\r\n                return { ...g, kpis: [...(g.kpis || []), newKpi] };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error adding KPI:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateKpi = useCallback(async (goalId, kpiId, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/kpis/${kpiId}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setGoals(prev => prev.map(g => {\r\n                if (g.id !== goalId) return g;\r\n                return {\r\n                    ...g,\r\n                    kpis: (g.kpis || []).map(k => k.id === kpiId ? { ...k, ...updates } : k)\r\n                };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error updating KPI:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const deleteKpi = useCallback(async (goalId, kpiId) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/kpis/${kpiId}`, { method: 'DELETE' });\r\n            setGoals(prev => prev.map(g => {\r\n                if (g.id !== goalId) return g;\r\n                return { ...g, kpis: (g.kpis || []).filter(k => k.id !== kpiId) };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error deleting KPI:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== PROJECTS ====================\r\n\r\n    // Fetch full project details (tasks, reports, etc.) on demand\r\n    const loadProjectDetails = useCallback(async (projectId) => {\r\n        try {\r\n            setLoading(true);\r\n            const res = await authFetch(`${API_BASE}/projects/${projectId}`);\r\n            if (!res.ok) throw new Error('Failed to load project details');\r\n\r\n            const detailedProject = await res.json();\r\n\r\n            if (detailedProject) {\r\n                // Update local state with the detailed version\r\n                setProjects(prev => prev.map(p =>\r\n                    p.id === projectId ? { ...p, ...detailedProject, _detailsLoaded: true } : p\r\n                ));\r\n            }\r\n\r\n            return detailedProject;\r\n        } catch (err) {\r\n            console.error('Error loading project details:', err);\r\n            return null;\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const addProject = useCallback(async (project) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(project)\r\n            });\r\n            if (!res.ok) {\r\n                const errData = await res.json().catch(() => ({}));\r\n                throw new Error(errData.error || `Failed to create project (HTTP ${res.status})`);\r\n            }\r\n            const newProject = await res.json();\r\n            setProjects(prev => [...prev, newProject]);\r\n            return newProject.id;\r\n        } catch (err) {\r\n            console.error('Error adding project:', err);\r\n            throw err;\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateProject = useCallback(async (id, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/projects/${id}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setProjects(prev => prev.map(p => p.id === id ? { ...p, ...updates } : p));\r\n        } catch (err) {\r\n            console.error('Error updating project:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const deleteProject = useCallback(async (id) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/projects/${id}`, { method: 'DELETE' });\r\n            setProjects(prev => prev.filter(p => p.id !== id));\r\n        } catch (err) {\r\n            console.error('Error deleting project:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== TASKS ====================\r\n\r\n    const addTask = useCallback(async (projectId, task) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects/${projectId}/tasks`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(task)\r\n            });\r\n            const newTask = await res.json();\r\n            setProjects(prev => prev.map(p => {\r\n                if (String(p.id) !== String(projectId)) return p;\r\n                // If tasks array exists, update it. If not, just update count/metadata if needed\r\n                if (!p.tasks) return { ...p, taskCount: (p.taskCount || 0) + 1 };\r\n\r\n                return { ...p, tasks: [...p.tasks, newTask], taskCount: p.tasks.length + 1 };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error adding task:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateTask = useCallback(async (projectId, taskId, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/tasks/${taskId}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setProjects(prev => prev.map(p => {\r\n                if (String(p.id) !== String(projectId)) return p;\r\n                if (!p.tasks) return p; // Tasks not loaded, nothing to update in state\r\n\r\n                return {\r\n                    ...p,\r\n                    tasks: p.tasks.map(t => String(t.id) === String(taskId) ? { ...t, ...updates } : t)\r\n                };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error updating task:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const moveTask = useCallback(async (projectId, taskId, newStatus) => {\r\n        await updateTask(projectId, taskId, { status: newStatus });\r\n    }, [updateTask]);\r\n\r\n    const deleteTask = useCallback(async (projectId, taskId) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/tasks/${taskId}`, { method: 'DELETE' });\r\n            setProjects(prev => prev.map(p => {\r\n                if (String(p.id) !== String(projectId)) return p;\r\n                if (!p.tasks) return { ...p, taskCount: Math.max(0, (p.taskCount || 1) - 1) };\r\n\r\n                return {\r\n                    ...p,\r\n                    tasks: p.tasks.filter(t => String(t.id) !== String(taskId)),\r\n                    taskCount: p.tasks.length - 1\r\n                };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error deleting task:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== STATUS REPORTS ====================\r\n\r\n    const addStatusReport = useCallback(async (projectId, reportData) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects/${projectId}/reports`, {\r\n                method: 'POST',\r\n                body: JSON.stringify({ reportData, createdBy: reportData.createdBy })\r\n            });\r\n            const newReport = await res.json();\r\n            setProjects(prev => prev.map(p => {\r\n                if (p.id !== projectId) return p;\r\n                return {\r\n                    ...p,\r\n                    statusReports: [...(p.statusReports || []), newReport],\r\n                    latestReport: newReport,\r\n                    reportCount: (p.reportCount || 0) + 1\r\n                };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error adding status report:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const getLatestStatusReport = useCallback((projectId) => {\r\n        const project = projects.find(p => p.id === projectId);\r\n        if (!project) return null;\r\n        // optimization: check pre-fetched latestReport\r\n        if (project.latestReport) return project.latestReport;\r\n        // fallback: check statusReports array if loaded\r\n        if (project.statusReports?.length) return project.statusReports[project.statusReports.length - 1];\r\n        return null;\r\n    }, [projects]);\r\n\r\n    const restoreStatusReport = useCallback(async (projectId, reportId, author) => {\r\n        const project = projects.find(p => p.id === projectId);\r\n        const reportToRestore = project?.statusReports?.find(r => r.id === reportId);\r\n        if (!reportToRestore) return;\r\n\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/projects/${projectId}/reports`, {\r\n                method: 'POST',\r\n                body: JSON.stringify({\r\n                    reportData: reportToRestore,\r\n                    createdBy: author,\r\n                    restoredFrom: reportToRestore.version\r\n                })\r\n            });\r\n            const newReport = await res.json();\r\n            setProjects(prev => prev.map(p => {\r\n                if (p.id !== projectId) return p;\r\n                return { ...p, statusReports: [...(p.statusReports || []), newReport] };\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error restoring status report:', err);\r\n        }\r\n    }, [projects, authFetch]);\r\n\r\n    // ==================== INTAKE FORMS ====================\r\n\r\n    const addIntakeForm = useCallback(async (form) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/intake/forms`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(form)\r\n            });\r\n            const newForm = await res.json();\r\n            setIntakeForms(prev => [...prev, newForm]);\r\n            return newForm.id;\r\n        } catch (err) {\r\n            console.error('Error adding intake form:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateIntakeForm = useCallback(async (id, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/intake/forms/${id}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n            setIntakeForms(prev => prev.map(f => f.id === id ? { ...f, ...updates } : f));\r\n        } catch (err) {\r\n            console.error('Error updating intake form:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const deleteIntakeForm = useCallback(async (id) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/intake/forms/${id}`, { method: 'DELETE' });\r\n            setIntakeForms(prev => prev.filter(f => f.id !== id));\r\n        } catch (err) {\r\n            console.error('Error deleting intake form:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    // ==================== INTAKE SUBMISSIONS ====================\r\n\r\n    const [mySubmissions, setMySubmissions] = useState([]);\r\n\r\n    // ... (existing code)\r\n\r\n    // Helper: Authenticated fetch wrapper\r\n    // ...\r\n\r\n\r\n\r\n    // ...\r\n\r\n    // ==================== INTAKE SUBMISSIONS ====================\r\n\r\n    const addIntakeSubmission = useCallback(async (submission) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/intake/submissions`, {\r\n                method: 'POST',\r\n                body: JSON.stringify(submission)\r\n            });\r\n            const newSubmission = await res.json();\r\n\r\n            // Update both lists\r\n            setIntakeSubmissions(prev => [...prev, newSubmission]);\r\n            setMySubmissions(prev => [newSubmission, ...prev]); // Add to top of my list\r\n\r\n            return newSubmission.id;\r\n        } catch (err) {\r\n            console.error('Error adding submission:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const updateIntakeSubmission = useCallback(async (id, updates) => {\r\n        try {\r\n            await authFetch(`${API_BASE}/intake/submissions/${id}`, {\r\n                method: 'PUT',\r\n                body: JSON.stringify(updates)\r\n            });\r\n\r\n            // Update both lists\r\n            setIntakeSubmissions(prev => prev.map(s => s.id === id ? { ...s, ...updates } : s));\r\n            setMySubmissions(prev => prev.map(s => s.id === id ? { ...s, ...updates } : s));\r\n\r\n        } catch (err) {\r\n            console.error('Error updating submission:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const addConversationMessage = useCallback(async (submissionId, message, senderType) => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/intake/submissions/${submissionId}/message`, {\r\n                method: 'POST',\r\n                body: JSON.stringify({ message })\r\n            });\r\n\r\n            if (!res.ok) throw new Error('Failed to send message');\r\n\r\n            const { conversation } = await res.json();\r\n\r\n            const newStatus = senderType === 'admin' ? 'awaiting-response' : 'pending';\r\n\r\n            // Optimistic update or refetch - here taking the returned conversation\r\n            const updateLocal = (prev) => prev.map(s => {\r\n                if (s.id !== submissionId) return s;\r\n                return {\r\n                    ...s,\r\n                    status: newStatus,\r\n                    conversation: conversation\r\n                };\r\n            });\r\n\r\n            setIntakeSubmissions(prev => updateLocal(prev));\r\n            setMySubmissions(prev => updateLocal(prev));\r\n\r\n        } catch (err) {\r\n            console.error('Error sending message:', err);\r\n            throw err;\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const markConversationRead = useCallback(async (submissionId) => {\r\n        const submission = intakeSubmissions.find(s => s.id === submissionId);\r\n        if (!submission?.conversation) return;\r\n\r\n        const updatedConversation = submission.conversation.map(msg => ({\r\n            ...msg,\r\n            read: true\r\n        }));\r\n\r\n        await updateIntakeSubmission(submissionId, {\r\n            conversation: updatedConversation\r\n        });\r\n    }, [intakeSubmissions, updateIntakeSubmission]);\r\n\r\n    // Legacy support: migrate old infoRequests to conversation format\r\n    const migrateInfoRequestsToConversation = useCallback((submission) => {\r\n        if (!submission.infoRequests || submission.conversation) return submission;\r\n\r\n        const conversation = [];\r\n        submission.infoRequests.forEach(ir => {\r\n            // Add admin question\r\n            conversation.push({\r\n                id: `msg-${ir.id}-q`,\r\n                type: 'admin',\r\n                message: ir.question,\r\n                timestamp: ir.askedAt,\r\n                read: true\r\n            });\r\n            // Add requester response if exists\r\n            if (ir.response) {\r\n                conversation.push({\r\n                    id: `msg-${ir.id}-r`,\r\n                    type: 'requester',\r\n                    message: ir.response,\r\n                    timestamp: ir.respondedAt,\r\n                    read: true\r\n                });\r\n            }\r\n        });\r\n\r\n        return { ...submission, conversation };\r\n    }, []);\r\n\r\n\r\n\r\n    const convertSubmissionToProject = useCallback(async (submissionId, projectData) => {\r\n        const projectId = await addProject(projectData);\r\n        if (!projectId) {\r\n            throw new Error('Project creation failed ‚Äî no project ID returned');\r\n        }\r\n        await updateIntakeSubmission(submissionId, {\r\n            status: 'approved',\r\n            convertedProjectId: projectId\r\n        });\r\n        return projectId;\r\n    }, [addProject, updateIntakeSubmission]);\r\n\r\n    // ==================== TAG MANAGEMENT ====================\r\n\r\n    const refreshTags = useCallback(async () => {\r\n        try {\r\n            const res = await authFetch(`${API_BASE}/tags`);\r\n            if (res.ok) setTagGroups(await res.json());\r\n        } catch (err) {\r\n            console.error('Failed to refresh tags:', err);\r\n        }\r\n    }, [authFetch]);\r\n\r\n    const addTagGroup = useCallback(async (groupData) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tag-groups`, {\r\n            method: 'POST',\r\n            body: JSON.stringify(groupData)\r\n        });\r\n        if (!res.ok) throw new Error('Failed to create tag group');\r\n        const newGroup = await res.json();\r\n        setTagGroups(prev => [...prev, newGroup]);\r\n        return newGroup;\r\n    }, [authFetch]);\r\n\r\n    const updateTagGroup = useCallback(async (id, groupData) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tag-groups/${id}`, {\r\n            method: 'PUT',\r\n            body: JSON.stringify(groupData)\r\n        });\r\n        if (!res.ok) throw new Error('Failed to update tag group');\r\n        await refreshTags();\r\n    }, [authFetch, refreshTags]);\r\n\r\n    const deleteTagGroup = useCallback(async (id) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tag-groups/${id}`, {\r\n            method: 'DELETE'\r\n        });\r\n        if (!res.ok) throw new Error('Failed to delete tag group');\r\n        setTagGroups(prev => prev.filter(g => g.id !== id));\r\n    }, [authFetch]);\r\n\r\n    const addTag = useCallback(async (tagData) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tags`, {\r\n            method: 'POST',\r\n            body: JSON.stringify(tagData)\r\n        });\r\n        if (!res.ok) throw new Error('Failed to create tag');\r\n        const newTag = await res.json();\r\n        setTagGroups(prev => prev.map(g =>\r\n            g.id === tagData.groupId ? { ...g, tags: [...g.tags, newTag] } : g\r\n        ));\r\n        return newTag;\r\n    }, [authFetch]);\r\n\r\n    const updateTag = useCallback(async (id, tagData) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tags/${id}`, {\r\n            method: 'PUT',\r\n            body: JSON.stringify(tagData)\r\n        });\r\n        if (!res.ok) throw new Error('Failed to update tag');\r\n        await refreshTags();\r\n    }, [authFetch, refreshTags]);\r\n\r\n    const deleteTag = useCallback(async (id) => {\r\n        const res = await authFetch(`${API_BASE}/admin/tags/${id}`, {\r\n            method: 'DELETE'\r\n        });\r\n        if (!res.ok) throw new Error('Failed to delete tag');\r\n        setTagGroups(prev => prev.map(g => ({\r\n            ...g,\r\n            tags: g.tags.filter(t => t.id !== id)\r\n        })));\r\n    }, [authFetch]);\r\n\r\n    const updateProjectTags = useCallback(async (projectId, tags) => {\r\n        const res = await authFetch(`${API_BASE}/projects/${projectId}/tags`, {\r\n            method: 'PUT',\r\n            body: JSON.stringify({ tags })\r\n        });\r\n        if (!res.ok) {\r\n            const errData = await res.json().catch(() => ({}));\r\n            throw new Error(errData.error || 'Failed to update project tags');\r\n        }\r\n        // Optimistically update the project's tags in state\r\n        setProjects(prev => prev.map(p => {\r\n            if (p.id === projectId) {\r\n                // We need to resolve tag names from tagGroups\r\n                const allTags = tagGroups.flatMap(g => g.tags);\r\n                const resolvedTags = tags.map(t => {\r\n                    const tag = allTags.find(at => at.id === t.tagId);\r\n                    return tag ? {\r\n                        tagId: t.tagId,\r\n                        name: tag.name,\r\n                        slug: tag.slug,\r\n                        color: tag.color,\r\n                        groupId: tag.groupId,\r\n                        isPrimary: t.isPrimary,\r\n                        tagStatus: tag.status\r\n                    } : null;\r\n                }).filter(Boolean);\r\n                return { ...p, tags: resolvedTags };\r\n            }\r\n            return p;\r\n        }));\r\n        return true;\r\n    }, [authFetch, tagGroups]);\r\n\r\n    // Show loading state\r\n    if (loading) {\r\n        return (\r\n            <div style={{\r\n                display: 'flex',\r\n                justifyContent: 'center',\r\n                alignItems: 'center',\r\n                height: '100vh',\r\n                color: 'var(--text-secondary)'\r\n            }}>\r\n                Loading data from database...\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Show error state\r\n    if (error) {\r\n        const isAuthError = typeof error === 'string' && (error.includes('401') || error.includes('Session'));\r\n\r\n        return (\r\n            <div style={{\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                justifyContent: 'center',\r\n                alignItems: 'center',\r\n                height: '100vh',\r\n                gap: '1rem',\r\n                color: 'var(--text-secondary)'\r\n            }}>\r\n                {isAuthError ? (\r\n                    <>\r\n                        <h2 style={{ color: '#f59e0b' }}>Session Expired</h2>\r\n                        <p>Your session has expired or is invalid. Please sign in again.</p>\r\n                        <button\r\n                            onClick={() => instance.loginRedirect(apiRequest)}\r\n                            style={{\r\n                                padding: '0.6rem 1.2rem',\r\n                                background: '#2563eb',\r\n                                color: 'white',\r\n                                border: 'none',\r\n                                borderRadius: '6px',\r\n                                fontSize: '1rem',\r\n                                cursor: 'pointer',\r\n                                marginTop: '0.5rem',\r\n                                fontWeight: '500'\r\n                            }}\r\n                        >\r\n                            Sign In Again\r\n                        </button>\r\n                    </>\r\n                ) : (\r\n                    <>\r\n                        <h2 style={{ color: '#ef4444' }}>Connection Error</h2>\r\n                        <p><strong>Error:</strong> {error}</p>\r\n                        <div style={{ fontSize: '0.9rem', color: '#666' }}>\r\n                            <p>Possible causes:</p>\r\n                            <ul style={{ listStyle: 'none', padding: 0 }}>\r\n                                <li>1. Backend server is not running on port 3001</li>\r\n                                <li>2. Authentication failed (401 Unauthorized)</li>\r\n                                <li>3. Network/CORS connectivity issue</li>\r\n                            </ul>\r\n                        </div>\r\n                        <p>Make sure the API server is running on port 3001</p>\r\n                        <code>cd server && npm start</code>\r\n                    </>\r\n                )}\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <DataContext.Provider value={{\r\n            goals: goalsWithProgress,\r\n            addGoal, updateGoal, deleteGoal,\r\n            addKpi, updateKpi, deleteKpi,\r\n            projects: projectsWithCompletion,\r\n            projectsPagination,\r\n            loadMoreProjects,\r\n            loading,\r\n            loadingMore,\r\n            moveTask, addTask, addProject, updateProject, deleteProject, loadProjectDetails,\r\n            updateTask, deleteTask,\r\n            intakeForms, addIntakeForm, updateIntakeForm, deleteIntakeForm,\r\n            intakeSubmissions, mySubmissions, addIntakeSubmission, updateIntakeSubmission,\r\n            addConversationMessage, markConversationRead, migrateInfoRequestsToConversation, convertSubmissionToProject,\r\n            addStatusReport, getLatestStatusReport, restoreStatusReport,\r\n            authFetch, fetchExecSummaryProjects,\r\n\r\n            permissions, hasPermission, updatePermissionsBulk,\r\n\r\n            tagGroups, addTagGroup, updateTagGroup, deleteTagGroup,\r\n            addTag, updateTag, deleteTag, updateProjectTags\r\n        }}>\r\n            {children}\r\n        </DataContext.Provider>\r\n    );\r\n}\r\n\r\nexport const useData = () => useContext(DataContext);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\context\\ThemeContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":30,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":30,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useEffect, useState } from 'react';\r\n\r\nconst ThemeContext = createContext();\r\n\r\nexport function ThemeProvider({ children }) {\r\n    const [theme, setTheme] = useState(() => {\r\n        // Check local storage or system preference\r\n        const saved = localStorage.getItem('theme');\r\n        if (saved) return saved;\r\n        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';\r\n    });\r\n\r\n    useEffect(() => {\r\n        // Apply theme to document\r\n        document.documentElement.setAttribute('data-theme', theme);\r\n        localStorage.setItem('theme', theme);\r\n    }, [theme]);\r\n\r\n    const toggleTheme = () => {\r\n        setTheme(prev => prev === 'light' ? 'dark' : 'light');\r\n    };\r\n\r\n    return (\r\n        <ThemeContext.Provider value={{ theme, toggleTheme }}>\r\n            {children}\r\n        </ThemeContext.Provider>\r\n    );\r\n}\r\n\r\nexport const useTheme = () => useContext(ThemeContext);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\context\\ToastContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":5,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":5,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useState, useCallback } from 'react';\r\n\r\nconst ToastContext = createContext();\r\n\r\nexport function useToast() {\r\n    const context = useContext(ToastContext);\r\n    if (!context) {\r\n        throw new Error('useToast must be used within a ToastProvider');\r\n    }\r\n    return context;\r\n}\r\n\r\nexport function ToastProvider({ children }) {\r\n    const [toasts, setToasts] = useState([]);\r\n\r\n    const addToast = useCallback((message, type = 'success', duration = 3000) => {\r\n        const id = Date.now() + Math.random();\r\n        const toast = { id, message, type };\r\n\r\n        setToasts(prev => [...prev, toast]);\r\n\r\n        // Auto-remove after duration\r\n        setTimeout(() => {\r\n            setToasts(prev => prev.filter(t => t.id !== id));\r\n        }, duration);\r\n\r\n        return id;\r\n    }, []);\r\n\r\n    const removeToast = useCallback((id) => {\r\n        setToasts(prev => prev.filter(t => t.id !== id));\r\n    }, []);\r\n\r\n    // Convenience methods\r\n    const success = useCallback((message, duration) => addToast(message, 'success', duration), [addToast]);\r\n    const error = useCallback((message, duration) => addToast(message, 'error', duration), [addToast]);\r\n    const info = useCallback((message, duration) => addToast(message, 'info', duration), [addToast]);\r\n    const warning = useCallback((message, duration) => addToast(message, 'warning', duration), [addToast]);\r\n\r\n    return (\r\n        <ToastContext.Provider value={{ toasts, addToast, removeToast, success, error, info, warning }}>\r\n            {children}\r\n        </ToastContext.Provider>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\hooks\\useAuth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\src\\utils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mula\\OneDrive\\Documents\\AntiGravity\\Digital Health Atlas\\vite.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]